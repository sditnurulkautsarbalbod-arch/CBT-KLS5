<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT SD IT Nurul Kautsar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- IndexedDB untuk caching lokal -->

    <style>
        /* ============================================= */
        /* TEMA: OCEAN ACADEMY - Biru Laut & Tosca      */
        /* ============================================= */
        
        :root {
            --primary: #0EA5E9;
            --primary-dark: #0284C7;
            --primary-light: #7DD3FC;
            --secondary: #14B8A6;
            --secondary-dark: #0D9488;
            --secondary-light: #5EEAD4;
            --accent: #F97316;
            --accent-light: #FDBA74;
            --bg-main: #F0F9FF;
            --bg-card: #FFFFFF;
            --text-dark: #0F172A;
            --text-muted: #64748B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gradient-primary: linear-gradient(135deg, #0EA5E9 0%, #14B8A6 100%);
            --gradient-secondary: linear-gradient(135deg, #14B8A6 0%, #0EA5E9 100%);
            --gradient-warm: linear-gradient(135deg, #F97316 0%, #F59E0B 100%);
        }
        
        /* Prevent text selection */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection only in input fields and textareas */
        input, textarea, [contenteditable="true"] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body {
            background-color: var(--bg-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .bounce-in { animation: bounceIn 0.6s ease-out; }
        @keyframes bounceIn { 
            0% { opacity: 0; transform: scale(0.3); }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .timer-warning { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Question Navigation */
        .question-nav-btn { 
            transition: all 0.3s ease;
            border-radius: 12px;
            font-weight: 600;
        }
        .question-nav-btn.answered { 
            background: var(--gradient-secondary);
            color: white;
            box-shadow: 0 4px 14px rgba(20, 184, 166, 0.4);
        }
        .question-nav-btn.current { 
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.4);
        }
        .question-nav-btn.unanswered { 
            background-color: #E2E8F0;
            color: #475569;
        }
        .question-nav-btn:hover { 
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.3);
        }
        
        /* Modal */
        .modal-backdrop { backdrop-filter: blur(8px); }
        
        /* Login Container */
        .login-container {
            background: var(--gradient-primary);
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            animation: rotate 30s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 24px;
            position: relative;
            z-index: 10;
        }
        
        /* Cards */
        .ocean-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.1);
            transition: all 0.3s ease;
        }
        
        .ocean-card:hover {
            box-shadow: 0 8px 30px rgba(14, 165, 233, 0.2);
            transform: translateY(-2px);
        }
        
        /* Buttons */
        .btn-ocean {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.4);
        }
        
        .btn-ocean:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
        }
        
        .btn-teal {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(20, 184, 166, 0.4);
        }
        
        .btn-teal:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.5);
        }
        
        .btn-warm {
            background: var(--gradient-warm);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(249, 115, 22, 0.4);
        }
        
        .btn-warm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5);
        }
        
        /* Sidebar */
        .sidebar-ocean {
            background: linear-gradient(180deg, #0EA5E9 0%, #0284C7 50%, #14B8A6 100%);
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin: 4px 8px;
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(4px);
        }
        
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Input Fields */
        .input-ocean {
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-ocean:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
            outline: none;
        }
        
        /* Tables */
        .table-ocean thead {
            background: var(--gradient-primary);
            color: white;
        }
        
        .table-ocean thead th {
            padding: 16px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        
        .table-ocean tbody tr {
            transition: all 0.2s ease;
        }
        
        .table-ocean tbody tr:hover {
            background-color: #F0F9FF;
        }
        
        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(14, 165, 233, 0.15);
        }
        
        .stat-card.teal::before {
            background: var(--gradient-secondary);
        }
        
        .stat-card.orange::before {
            background: var(--gradient-warm);
        }
        
        /* Exam Interface */
        .exam-header {
            background: var(--gradient-primary);
            color: white;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.3);
        }
        
        .exam-timer {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px 24px;
        }
        
        .exam-question-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(14, 165, 233, 0.1);
            border: 2px solid rgba(14, 165, 233, 0.1);
        }
        
        .option-btn {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 16px;
            padding: 16px 20px;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .option-btn:hover {
            border-color: var(--primary);
            background: #F0F9FF;
            transform: translateX(4px);
        }
        
        .option-btn.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(20, 184, 166, 0.1) 100%);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);
        }
        
        /* Decorative Elements */
        .wave-decoration {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230EA5E9' fill-opacity='0.1' d='M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,154.7C960,171,1056,181,1152,165.3C1248,149,1344,107,1392,85.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
        }
        
        /* Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #F1F5F9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--gradient-primary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-dark); }
        
        /* Badge */
        .badge-ocean {
            background: var(--gradient-primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-teal {
            background: var(--gradient-secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Icon Containers */
        .icon-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .icon-circle.ocean {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.2) 0%, rgba(20, 184, 166, 0.2) 100%);
            color: var(--primary);
        }
        
        .icon-circle.teal {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.2) 0%, rgba(14, 165, 233, 0.2) 100%);
            color: var(--secondary);
        }
        
        .icon-circle.orange {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            color: var(--accent);
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.24.0"
  }
}
</script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container flex items-center justify-center p-4">
        <!-- Decorative Elements -->
        <div class="absolute top-10 left-10 w-20 h-20 bg-white/10 rounded-full float"></div>
        <div class="absolute top-32 right-20 w-16 h-16 bg-white/10 rounded-full float" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-20 left-1/4 w-24 h-24 bg-white/10 rounded-full float" style="animation-delay: 2s;"></div>
        
        <div class="login-box bg-white rounded-3xl shadow-2xl p-8 sm:p-10 w-full max-w-md fade-in relative">
            <!-- Header -->
            <div class="text-center mb-8">
                <!-- Logo/Icon -->
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-cyan-500 to-teal-500 flex items-center justify-center shadow-lg bounce-in">
                    <i class="fas fa-graduation-cap text-white text-3xl"></i>
                </div>
                <div class="bg-gradient-to-r from-cyan-500 to-teal-500 text-white py-4 px-6 rounded-2xl mb-4 shadow-lg">
                    <h1 class="text-xl font-bold tracking-wide">üè´ SD IT NURUL KAUTSAR</h1>
                </div>
                <h2 class="text-2xl font-bold bg-gradient-to-r from-cyan-600 to-teal-600 bg-clip-text text-transparent">UJIAN ONLINE KELAS 5</h2>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="space-y-5">
                <div id="loginError" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                        <i class="fas fa-user text-cyan-500"></i>
                    </div>
                    <input type="text" id="username" required 
                           class="input-ocean w-full pl-12 pr-4 py-4 text-gray-700" 
                           placeholder="Username">
                </div>
                
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                        <i class="fas fa-lock text-cyan-500"></i>
                    </div>
                    <input type="password" id="password" required 
                           class="input-ocean w-full pl-12 pr-12 py-4 text-gray-700" 
                           placeholder="Password">
                    <button type="button" id="togglePasswordVisibility" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-400 hover:text-cyan-500 transition-colors">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <button type="submit" class="w-full btn-ocean py-4 text-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Masuk</span>
                </button>
            </form>
            
            <!-- Footer -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">¬© 2026 CBT SD IT Nurul Kautsar</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Interface -->
    <div id="dashboardInterface" class="hidden flex h-screen" style="background-color: var(--bg-main);">
        <!-- Sidebar -->
        <div id="dashboardSidebar" class="w-64 sidebar-ocean text-white flex flex-col shadow-2xl">
            <div class="px-4 py-6 text-center border-b border-white/20">
                <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-white/20 flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-xl"></i>
                </div>
                <h2 class="text-lg font-bold">CBT Dashboard</h2>
                <div class="mt-3 bg-white/10 rounded-xl py-2 px-3">
                    <p id="dashboardUserInfo" class="font-semibold text-sm"></p>
                    <p id="dashboardUserRole" class="text-xs text-cyan-200"></p>
                </div>
            </div>
            <nav id="dashboardNav" class="flex-1 overflow-y-auto py-4 no-scrollbar"></nav>
            <div class="px-4 py-4 border-t border-blue-800">
                <button id="dashboardLogoutBtn" class="w-full flex items-center justify-center px-4 py-2 text-sm font-medium hover:bg-blue-800 transition duration-200 rounded-md">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Logout
                </button>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header for Admin/Guru -->
            <header id="dashboardHeader" class="hidden bg-white shadow-md z-10 p-4">
                <!-- Content populated by JavaScript -->
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-8">
                <div id="dashboardContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </main>
        </div>
    </div>

    <!-- Management Modal -->
    <div id="managementModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold text-gray-800" id="modalTitle">Modal Title</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" id="modalContent">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="confirmTitle">Konfirmasi</h3>
            <p class="text-gray-700 mb-6" id="confirmMessage">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="confirmOkBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Gemini Generation Modal -->
    <div id="geminiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 class="text-xl font-bold text-gray-800" id="geminiModalTitle">‚ú® Buat Soal Otomatis dengan AI</h3>
                <button onclick="UI.hideGeminiModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto" id="geminiModalContent">
                <!-- Gemini Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

     <!-- Exam Lock Screen Modal -->
    <div id="examLockModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 text-center fade-in">
            <i id="examLockIcon" class="fas fa-lock text-5xl text-blue-600 mb-6"></i>
            <h3 id="examLockTitle" class="text-2xl font-bold text-gray-900 mb-4">Mode Ujian Terkunci</h3>
            <p id="examLockDesc" class="text-gray-700 mb-2">Anda akan memasuki mode ujian layar penuh.</p>
            <ul id="examLockRules" class="text-sm text-left text-gray-600 list-disc list-inside mb-8 space-y-2 p-4 bg-gray-50 rounded-lg">
                <li>Pastikan tidak ada aplikasi atau jendela lain yang terbuka.</li>
                <li>Dilarang meninggalkan halaman ujian atau keluar dari mode layar penuh.</li>
            </ul>
            <button id="startFullscreenExamBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 text-lg">
                <i class="fas fa-play-circle mr-2"></i> Saya Mengerti & Mulai Ujian
            </button>
        </div>
    </div>

    <!-- Re-enter Fullscreen Modal -->
    <div id="reEnterFullscreenModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 text-center fade-in">
            <i class="fas fa-expand text-5xl text-blue-600 mb-6"></i>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Ujian Dijeda</h3>
            <p class="text-gray-700 mb-6">Anda harus berada dalam mode layar penuh untuk melanjutkan ujian.</p>
            <p id="violationWarning" class="text-red-500 font-bold mb-6"></p>
            <button id="reEnterFullscreenBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 text-lg">
                <i class="fas fa-expand-arrows-alt mr-2"></i> Masuk Layar Penuh Kembali
            </button>
        </div>
    </div>

    <!-- Exam Interface -->
    <div id="examInterface" class="hidden min-h-screen bg-gray-100">
        <!-- Exam Top Bar -->
        <div class="bg-white shadow-md sticky top-0 z-20">
            <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <p id="examUserInfo" class="text-sm font-semibold text-gray-800 hidden sm:block"></p>
                    <div class="flex items-center bg-red-100 text-red-700 px-3 py-2 rounded-lg shadow-sm">
                        <i class="far fa-clock mr-2"></i>
                        <span id="examTimer" class="font-bold text-md">01:00:00</span>
                    </div>
                </div>
                <button id="questionListBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center">
                    <i class="fas fa-list-ul mr-2"></i><span class="hidden sm:inline">Daftar Soal</span>
                </button>
                <div class="flex items-center gap-4">
                    <p class="text-sm text-gray-600 font-medium hidden sm:block">
                        Soal <span id="currentQuestionNum">1</span> dari <span id="totalQuestions">0</span>
                    </p>
                    <button id="submitExamBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 whitespace-nowrap">
                        <i class="fas fa-flag-checkered mr-2"></i> Selesai
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6 sm:px-6 sm:py-8">
            <!-- Question Area -->
            <div class="w-full bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                <div id="questionContent">
                    <!-- Question will be rendered here -->
                </div>
                <div class="mt-8 pt-6 border-t flex flex-col sm:flex-row justify-between items-center gap-4">
                    <button id="prevQuestionBtn" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                        <i class="fas fa-chevron-left mr-2"></i> Soal Sebelumnya
                    </button>
                    <div class="w-full sm:w-1/3">
                        <p class="text-center text-xs text-gray-500 mb-1">Progress</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <button id="nextQuestionBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                        Soal Selanjutnya <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question List Modal -->
    <div id="questionListModal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Daftar Soal</h3>
                <button id="closeQuestionListBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="overflow-y-auto">
                <div id="questionListModalContent" class="grid grid-cols-5 gap-2 sm:gap-4">
                    <!-- Navigation buttons will be rendered here via JS -->
                </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-center items-center gap-4 text-sm flex-wrap">
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span>Sudah dijawab</span>
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-blue-500 mr-2"></span>Dikerjakan</span>
                <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-300 mr-2"></span>Belum dijawab</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // =================================================================
        // INDEXED DB SERVICE - Penyimpanan lokal untuk offline & caching
        // Database: CBT_KLS4_DB
        // =================================================================
        const IndexedDBService = {
            dbName: 'CBT_KLS4_DB',
            dbVersion: 2,
            db: null,
            stores: ['users', 'questions', 'results', 'grades', 'settings', 'blockedStudents', 'syncQueue', 'metadata'],
            
            // Initialize database
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    
                    request.onerror = () => reject(request.error);
                    
                    request.onsuccess = () => {
                        this.db = request.result;
                        console.log('IndexedDB initialized successfully');
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // Create object stores
                        this.stores.forEach(storeName => {
                            if (!db.objectStoreNames.contains(storeName)) {
                                const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                                
                                // Add indexes based on store type
                                if (storeName === 'users') {
                                    store.createIndex('username', 'username', { unique: true });
                                    store.createIndex('role', 'role', { unique: false });
                                    store.createIndex('kelas', 'kelas', { unique: false });
                                }
                                if (storeName === 'questions') {
                                    store.createIndex('kode', 'kode', { unique: false });
                                    store.createIndex('kelas', 'kelas', { unique: false });
                                    store.createIndex('mataPelajaran', 'mataPelajaran', { unique: false });
                                }
                                if (storeName === 'results' || storeName === 'grades') {
                                    store.createIndex('username', 'username', { unique: false });
                                    store.createIndex('kodeUjian', 'kodeUjian', { unique: false });
                                    store.createIndex('kelas', 'kelas', { unique: false });
                                }
                                if (storeName === 'syncQueue') {
                                    store.createIndex('action', 'action', { unique: false });
                                    store.createIndex('timestamp', 'timestamp', { unique: false });
                                    store.createIndex('status', 'status', { unique: false });
                                }
                                if (storeName === 'metadata') {
                                    store.createIndex('key', 'key', { unique: true });
                                }
                            }
                        });
                    };
                });
            },
            
            // Generic CRUD operations
            async getAll(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve([]); return; }
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async get(storeName, id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve(null); return; }
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async put(storeName, data) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve(null); return; }
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async putBulk(storeName, dataArray) {
                return new Promise((resolve, reject) => {
                    if (!this.db || !Array.isArray(dataArray)) { resolve([]); return; }
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    dataArray.forEach(item => {
                        if (item && typeof item === 'object') {
                            store.put(item);
                        }
                    });
                    
                    transaction.oncomplete = () => resolve(dataArray);
                    transaction.onerror = () => reject(transaction.error);
                });
            },
            
            async delete(storeName, id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve(false); return; }
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            },
            
            async clear(storeName) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve(false); return; }
                    const transaction = this.db.transaction(storeName, 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Query by index
            async getByIndex(storeName, indexName, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { resolve([]); return; }
                    const transaction = this.db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Metadata helpers untuk tracking sync
            async setMeta(key, value) {
                return this.put('metadata', { id: key, key, value, updatedAt: Date.now() });
            },
            
            async getMeta(key) {
                const meta = await this.get('metadata', key);
                return meta ? meta.value : null;
            },
            
            // Check if data needs sync (older than TTL)
            async needsSync(storeName, ttlMs = 300000) { // Default 5 menit
                const lastSync = await this.getMeta(`lastSync_${storeName}`);
                if (!lastSync) return true;
                return (Date.now() - lastSync) > ttlMs;
            },
            
            // Mark store as synced
            async markSynced(storeName) {
                return this.setMeta(`lastSync_${storeName}`, Date.now());
            }
        };

        // =================================================================
        // BACKGROUND SYNC MANAGER - Sinkronisasi di latar belakang
        // =================================================================
        const BackgroundSync = {
            syncInterval: null,
            isSyncing: false,
            syncIntervalMs: 60000, // Sync setiap 1 menit
            pendingOperations: [],
            
            async init() {
                // Start background sync interval
                this.startBackgroundSync();
                
                // Listen for online event to trigger sync
                window.addEventListener('online', () => {
                    console.log('Back online - triggering sync');
                    this.syncAll();
                });
                
                // Sync when tab becomes visible
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && navigator.onLine) {
                        this.syncAll();
                    }
                });
            },
            
            startBackgroundSync() {
                if (this.syncInterval) return;
                
                this.syncInterval = setInterval(() => {
                    if (navigator.onLine && !this.isSyncing) {
                        this.syncAll();
                    }
                }, this.syncIntervalMs);
                
                console.log('Background sync started');
            },
            
            stopBackgroundSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            },
            
            // Add operation to sync queue
            async queueOperation(action, storeName, data) {
                const operation = {
                    id: `op-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    action,
                    storeName,
                    data,
                    timestamp: Date.now(),
                    status: 'pending',
                    retryCount: 0
                };
                
                await IndexedDBService.put('syncQueue', operation);
                
                // Sync immediately if online (dengan await untuk memastikan terkirim)
                if (navigator.onLine) {
                    await this.processSyncQueue();
                }
                
                return operation;
            },
            
            // Process pending sync queue
            async processSyncQueue() {
                if (this.isSyncing || !navigator.onLine) return;
                
                try {
                    const queue = await IndexedDBService.getAll('syncQueue');
                    const pendingOps = queue.filter(op => op.status === 'pending');
                    
                    for (const op of pendingOps) {
                        try {
                            await this.executeOperation(op);
                            op.status = 'completed';
                            await IndexedDBService.put('syncQueue', op);
                        } catch (error) {
                            op.retryCount++;
                            op.status = op.retryCount >= 3 ? 'failed' : 'pending';
                            op.lastError = error.message;
                            await IndexedDBService.put('syncQueue', op);
                        }
                    }
                    
                    // Clean up completed operations
                    const completed = queue.filter(op => op.status === 'completed');
                    for (const op of completed) {
                        await IndexedDBService.delete('syncQueue', op.id);
                    }
                } catch (error) {
                    console.error('Error processing sync queue:', error);
                }
            },
            
            async executeOperation(op) {
                const { action, storeName, data } = op;
                
                try {
                    switch (action) {
                        case 'add':
                            // Special case: blockedStudents uses 'blockStudent' action
                            if (storeName === 'blockedStudents') {
                                return await callGoogleScript('POST', { action: 'blockStudent', data: data });
                            }
                            return await callGoogleScript('POST', { action: `add${this.capitalize(storeName)}`, data: data });
                        case 'addBatch':
                            // Untuk results, GAS expects 'addResults' (plural), bukan 'addResult'
                            if (storeName === 'results') {
                                return await callGoogleScript('POST', { action: 'addResults', data: data });
                            }
                            return await callGoogleScript('POST', { action: `add${this.capitalize(storeName)}`, data: data });
                        case 'addQuestionsBatch':
                            // Special case: GAS expects 'addQuestionsBatch' action name
                            return await callGoogleScript('POST', { action: 'addQuestionsBatch', data: data });
                        case 'update':
                            // Special case: settings uses 'saveSettings' action
                            if (storeName === 'settings') {
                                return await callGoogleScript('POST', { action: 'saveSettings', data: data });
                            }
                            const updateResult = await callGoogleScript('POST', { action: `update${this.capitalize(storeName)}`, data: data });
                            // Smart retry: jika UPDATE gagal dengan "not found", coba CREATE
                            if (updateResult.status !== 'success' && updateResult.message?.includes('not found')) {
                                console.log(`UPDATE failed for ${storeName}, retrying as CREATE...`);
                                return await callGoogleScript('POST', { action: `add${this.capitalize(storeName)}`, data: data });
                            }
                            return updateResult;
                        case 'delete':
                            // Special case: blockedStudents uses 'unblockStudent' action with blockId
                            if (storeName === 'blockedStudents') {
                                // Handle single unblock or unblock all
                                if (data.all) {
                                    return await callGoogleScript('POST', { action: 'unblockAllStudents', data: {} });
                                }
                                return await callGoogleScript('POST', { action: 'unblockStudent', data: { blockId: data.blockId || data.id, username: data.username, examCode: data.examCode } });
                            }
                            return await callGoogleScript('POST', { action: `delete${this.capitalize(storeName)}`, data: { id: data.id, ...data } });
                        default:
                            throw new Error(`Unknown action: ${action}`);
                    }
                } catch (error) {
                    // Smart retry untuk network errors pada UPDATE
                    if (action === 'update' && error.message?.includes('Failed')) {
                        console.log(`UPDATE network error for ${storeName}, will retry as CREATE...`);
                        try {
                            return await callGoogleScript('POST', { action: `add${this.capitalize(storeName)}`, data: data });
                        } catch (retryError) {
                            throw retryError;
                        }
                    }
                    throw error;
                }
            },
            
            capitalize(str) {
                // Handle plural to singular for API
                const singular = str.endsWith('s') ? str.slice(0, -1) : str;
                return singular.charAt(0).toUpperCase() + singular.slice(1);
            },
            
            // Sync all data stores from server
            async syncAll() {
                if (this.isSyncing || !navigator.onLine) return;
                this.isSyncing = true;
                
                console.log('Starting background sync...');
                this.showSyncIndicator(true);
                
                try {
                    // Process pending operations first
                    await this.processSyncQueue();
                    
                    // Sync each store that needs it
                    const stores = ['users', 'questions', 'results', 'grades', 'settings', 'blockedStudents'];
                    
                    for (const store of stores) {
                        if (await IndexedDBService.needsSync(store)) {
                            await this.syncStore(store);
                        }
                    }
                    
                    console.log('Background sync completed');
                } catch (error) {
                    console.error('Background sync error:', error);
                } finally {
                    this.isSyncing = false;
                    this.showSyncIndicator(false);
                }
            },
            
            async syncStore(storeName) {
                try {
                    let data = [];
                    
                    switch (storeName) {
                        case 'users':
                            const usersResult = await callGoogleScript('GET', { action: 'getUsers' });
                            data = usersResult.status === 'success' ? usersResult.data : [];
                            // Update AppState
                            if (data.length > 0) {
                                AppState.users = data.map((user, index) => ({
                                    ...user,
                                    id: user.id || `gs-user-${index}`
                                }));
                            }
                            break;
                            
                        case 'questions':
                            const questionsResult = await callGoogleScript('GET', { action: 'getQuestions' });
                            data = questionsResult.status === 'success' ? questionsResult.data : [];
                            break;
                            
                        case 'results':
                            const resultsResult = await callGoogleScript('GET', { action: 'getResults' });
                            data = resultsResult.status === 'success' ? resultsResult.data : [];
                            break;
                            
                        case 'grades':
                            const gradesResult = await callGoogleScript('GET', { action: 'getGrades' });
                            data = gradesResult.status === 'success' ? gradesResult.data : [];
                            break;
                            
                        case 'settings':
                            const settingsResult = await callGoogleScript('GET', { action: 'getSettings', key: 'examConfig' });
                            if (settingsResult.status === 'success' && settingsResult.data) {
                                data = [{ id: 'examConfig', ...settingsResult.data }];
                                AppState.examConfig = settingsResult.data;
                            }
                            break;
                            
                        case 'blockedStudents':
                            const blockedResult = await callGoogleScript('GET', { action: 'getBlockedStudents' });
                            data = blockedResult.status === 'success' ? blockedResult.data : [];
                            break;
                    }
                    
                    // Clear and repopulate store
                    if (data.length > 0) {
                        await IndexedDBService.clear(storeName);
                        await IndexedDBService.putBulk(storeName, data);
                        await IndexedDBService.markSynced(storeName);
                        
                        // Update memory cache
                        AppState.cache.set(storeName, { data, timestamp: Date.now(), valid: true });
                    }
                    
                    console.log(`Synced ${storeName}: ${data.length} items`);
                } catch (error) {
                    console.error(`Error syncing ${storeName}:`, error);
                }
            },
            
            showSyncIndicator(show) {
                // Syncing berjalan di background tanpa indikator visual
                // Uncomment kode di bawah jika ingin menampilkan indikator
                /*
                let indicator = document.getElementById('bgSyncIndicator');
                
                if (!indicator && show) {
                    indicator = document.createElement('div');
                    indicator.id = 'bgSyncIndicator';
                    indicator.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-3 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm z-50 transition-opacity duration-300';
                    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>Syncing...</span>';
                    document.body.appendChild(indicator);
                }
                
                if (indicator) {
                    indicator.style.opacity = show ? '1' : '0';
                    if (!show) {
                        setTimeout(() => indicator?.remove(), 300);
                    }
                }
                */
            }
        };

        // =================================================================
        // SYNC MANAGER - Enhanced with IndexedDB
        // =================================================================
        const SyncManager = {
            isOnline: navigator.onLine,
            
            // Initialize SyncManager
            init() {
                // Listen for online/offline events
                window.addEventListener('online', () => {
                    this.isOnline = true;
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
            }
        };

        // =================================================================
        // CACHE HELPER - Simple cache utilities
        // =================================================================
        const CacheHelper = {
            // Get cached data dari memory
            getCached(key) {
                const cached = AppState.cache.get(key);
                if (cached && cached.valid) {
                    return cached.data;
                }
                return null;
            },
            
            // Check if data is cached and valid (cache TTL: 5 menit)
            isCacheValid(key, ttlMs = 300000) {
                const cached = AppState.cache.get(key);
                if (!cached) return false;
                return (Date.now() - cached.timestamp) < ttlMs;
            },
            
            // Set cache data
            setCache(key, data) {
                AppState.cache.set(key, {
                    data: data,
                    timestamp: Date.now(),
                    valid: true
                });
            },
            
            // Invalidate cache (memory dan IndexedDB)
            async invalidateCache(key) {
                const cached = AppState.cache.get(key);
                if (cached) {
                    cached.valid = false;
                }
                
                try {
                    await IndexedDBService.setMeta(`lastSync_${key}`, 0);
                } catch (error) {
                    console.warn(`Could not invalidate IndexedDB cache for ${key}`);
                }
            }
        };

        // =================================================================
        // DATA SERVICE - Enhanced dengan IndexedDB & Background Sync
        // Optimistic UI: Update lokal dulu, sync ke server di background
        // =================================================================
        const DataService = {
            // ============ USERS ============
            async getUsers(forceRefresh = false) {
                // Check memory cache dulu
                if (!forceRefresh && CacheHelper.isCacheValid('users')) {
                    const cached = CacheHelper.getCached('users');
                    if (cached) return cached;
                }
                
                // Check IndexedDB jika tidak force refresh
                if (!forceRefresh) {
                    try {
                        const idbData = await IndexedDBService.getAll('users');
                        if (idbData && idbData.length > 0) {
                            AppState.cache.set('users', { data: idbData, timestamp: Date.now(), valid: true });
                            AppState.users = idbData;
                            // Trigger background refresh
                            BackgroundSync.syncStore('users');
                            return idbData;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                // Fetch dari server
                const result = await callGoogleScript('GET', { action: 'getUsers' });
                const data = result.status === 'success' ? result.data : [];
                
                // Update semua cache layers
                AppState.cache.set('users', { data, timestamp: Date.now(), valid: true });
                AppState.users = data;
                await IndexedDBService.clear('users');
                await IndexedDBService.putBulk('users', data);
                await IndexedDBService.markSynced('users');
                
                return data;
            },
            
            async addUser(userData) {
                // Generate ID
                const tempId = userData.id || `user-${Date.now()}`;
                const newUser = { ...userData, id: tempId };
                
                // 1. Update React State (Optimistic UI)
                const cached = CacheHelper.getCached('users') || [];
                cached.push(newUser);
                AppState.cache.set('users', { data: cached, timestamp: Date.now(), valid: true });
                AppState.users = cached;
                
                // 2. Save to IndexedDB
                await IndexedDBService.put('users', newUser);
                
                // 3. Enqueue for background sync (non-blocking)
                await BackgroundSync.queueOperation('add', 'users', newUser);
                
                return { success: true, message: 'User berhasil ditambahkan' };
            },
            
            async updateUser(userData) {
                // 1. Optimistic update
                const cached = CacheHelper.getCached('users') || [];
                const index = cached.findIndex(u => u.username === userData.username || u.id === userData.id);
                let updatedUser = userData;
                
                if (index !== -1) {
                    updatedUser = { ...cached[index], ...userData };
                    cached[index] = updatedUser;
                    AppState.cache.set('users', { data: cached, timestamp: Date.now(), valid: true });
                    AppState.users = cached;
                    
                    // 2. Save to IndexedDB
                    await IndexedDBService.put('users', updatedUser);
                }
                
                // 3. Enqueue for background sync
                await BackgroundSync.queueOperation('update', 'users', updatedUser);
                
                return { success: true, message: 'User berhasil diupdate' };
            },
            
            async deleteUser(username) {
                // 1. Optimistic delete
                const cached = CacheHelper.getCached('users') || [];
                const userToDelete = cached.find(u => u.username === username);
                const filteredData = cached.filter(u => u.username !== username);
                
                AppState.cache.set('users', { data: filteredData, timestamp: Date.now(), valid: true });
                AppState.users = filteredData;
                
                // 2. Delete from IndexedDB
                if (userToDelete?.id) {
                    await IndexedDBService.delete('users', userToDelete.id);
                }
                
                // 3. Enqueue for background sync
                await BackgroundSync.queueOperation('delete', 'users', { id: userToDelete?.id, username });
                
                return { success: true, message: 'User berhasil dihapus' };
            },
            
            // ============ QUESTIONS ============
            async getQuestions(kode = null, forceRefresh = false) {
                if (!forceRefresh && !kode && CacheHelper.isCacheValid('questions')) {
                    const cached = CacheHelper.getCached('questions');
                    if (cached) return cached;
                }
                
                // Check IndexedDB
                if (!forceRefresh && !kode) {
                    try {
                        const idbData = await IndexedDBService.getAll('questions');
                        if (idbData && idbData.length > 0) {
                            AppState.cache.set('questions', { data: idbData, timestamp: Date.now(), valid: true });
                            BackgroundSync.syncStore('questions');
                            return idbData;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                const params = kode ? { action: 'getQuestions', kode: kode } : { action: 'getQuestions' };
                const result = await callGoogleScript('GET', params);
                const data = result.status === 'success' ? result.data : [];
                
                if (!kode) {
                    AppState.cache.set('questions', { data, timestamp: Date.now(), valid: true });
                    await IndexedDBService.clear('questions');
                    await IndexedDBService.putBulk('questions', data);
                    await IndexedDBService.markSynced('questions');
                }
                return data;
            },
            
            async addQuestion(questionData) {
                const tempId = questionData.id || `q-${Date.now()}`;
                const newQuestion = { ...questionData, id: tempId };
                
                // 1. Optimistic update
                const cached = CacheHelper.getCached('questions') || [];
                cached.push(newQuestion);
                AppState.cache.set('questions', { data: cached, timestamp: Date.now(), valid: true });
                
                // 2. Save to IndexedDB
                await IndexedDBService.put('questions', newQuestion);
                
                // 3. Enqueue for background sync
                await BackgroundSync.queueOperation('add', 'questions', newQuestion);
                
                return { success: true, message: 'Soal berhasil ditambahkan' };
            },
            
            async addQuestions(questionsArray) {
                // 1. Optimistic update
                const cached = CacheHelper.getCached('questions') || [];
                const newQuestions = questionsArray.map((q, i) => ({ ...q, id: q.id || `q-${Date.now()}-${i}` }));
                cached.push(...newQuestions);
                AppState.cache.set('questions', { data: cached, timestamp: Date.now(), valid: true });
                
                // 2. Save to IndexedDB
                await IndexedDBService.putBulk('questions', newQuestions);
                
                // 3. Enqueue as batch - use special action name for GAS compatibility
                await BackgroundSync.queueOperation('addQuestionsBatch', 'questions', newQuestions);
                
                return { success: true, message: `${newQuestions.length} soal berhasil ditambahkan` };
            },
            
            async updateQuestion(questionData) {
                const cached = CacheHelper.getCached('questions') || [];
                const index = cached.findIndex(q => q.id === questionData.id);
                let updatedQuestion = questionData;
                
                if (index !== -1) {
                    updatedQuestion = { ...cached[index], ...questionData };
                    cached[index] = updatedQuestion;
                    AppState.cache.set('questions', { data: cached, timestamp: Date.now(), valid: true });
                    await IndexedDBService.put('questions', updatedQuestion);
                }
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('update', 'questions', updatedQuestion);
                
                return { success: true, message: 'Soal berhasil diupdate' };
            },
            
            async deleteQuestion(questionId) {
                const cached = CacheHelper.getCached('questions') || [];
                const filteredData = cached.filter(q => q.id !== questionId);
                AppState.cache.set('questions', { data: filteredData, timestamp: Date.now(), valid: true });
                await IndexedDBService.delete('questions', questionId);
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('delete', 'questions', { id: questionId });
                
                return { success: true, message: 'Soal berhasil dihapus' };
            },
            
            async deleteQuestions(questionIds) {
                const cached = CacheHelper.getCached('questions') || [];
                const filteredData = cached.filter(q => !questionIds.includes(q.id));
                AppState.cache.set('questions', { data: filteredData, timestamp: Date.now(), valid: true });
                
                // Delete from IndexedDB and enqueue
                for (const id of questionIds) {
                    await IndexedDBService.delete('questions', id);
                    await BackgroundSync.queueOperation('delete', 'questions', { id });
                }
                
                return { success: true, message: `${questionIds.length} soal berhasil dihapus` };
            },
            
            // ============ RESULTS ============
            async getResults(filters = {}, forceRefresh = false) {
                const hasFilters = Object.keys(filters).length > 0;
                
                if (!forceRefresh && !hasFilters && CacheHelper.isCacheValid('results')) {
                    const cached = CacheHelper.getCached('results');
                    if (cached) return cached;
                }
                
                if (!forceRefresh && !hasFilters) {
                    try {
                        const idbData = await IndexedDBService.getAll('results');
                        if (idbData && idbData.length > 0) {
                            AppState.cache.set('results', { data: idbData, timestamp: Date.now(), valid: true });
                            BackgroundSync.syncStore('results');
                            return idbData;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                const params = { action: 'getResults', ...filters };
                const result = await callGoogleScript('GET', params);
                const data = result.status === 'success' ? result.data : [];
                
                if (!hasFilters) {
                    AppState.cache.set('results', { data, timestamp: Date.now(), valid: true });
                    await IndexedDBService.clear('results');
                    await IndexedDBService.putBulk('results', data);
                    await IndexedDBService.markSynced('results');
                }
                return data;
            },
            
            async addResults(resultsArray) {
                const cached = CacheHelper.getCached('results') || [];
                const newResults = resultsArray.map((r, i) => ({ ...r, id: r.id || `r-${Date.now()}-${i}` }));
                cached.push(...newResults);
                AppState.cache.set('results', { data: cached, timestamp: Date.now(), valid: true });
                await IndexedDBService.putBulk('results', newResults);
                
                // Enqueue sebagai SATU batch operation, bukan per-item
                await BackgroundSync.queueOperation('addBatch', 'results', newResults);
                
                return { success: true, message: `${newResults.length} hasil berhasil ditambahkan` };
            },
            
            async updateResult(resultData) {
                const cached = CacheHelper.getCached('results') || [];
                const index = cached.findIndex(r => r.id === resultData.id);
                let updatedResult = resultData;
                
                if (index !== -1) {
                    updatedResult = { ...cached[index], ...resultData };
                    cached[index] = updatedResult;
                    AppState.cache.set('results', { data: cached, timestamp: Date.now(), valid: true });
                    await IndexedDBService.put('results', updatedResult);
                }
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('update', 'results', updatedResult);
                
                return { success: true, message: 'Hasil berhasil diupdate' };
            },
            
            async deleteResults(filters) {
                // Clear local cache and IndexedDB
                AppState.cache.set('results', { data: [], timestamp: Date.now(), valid: false });
                await IndexedDBService.clear('results');
                
                // Enqueue delete operation
                await BackgroundSync.queueOperation('delete', 'results', filters);
                
                return { success: true, message: 'Hasil berhasil dihapus' };
            },
            
            // ============ GRADES ============
            async getGrades(filters = {}, forceRefresh = false) {
                const hasFilters = Object.keys(filters).length > 0;
                
                if (!forceRefresh && !hasFilters && CacheHelper.isCacheValid('grades')) {
                    const cached = CacheHelper.getCached('grades');
                    if (cached) return cached;
                }
                
                if (!forceRefresh && !hasFilters) {
                    try {
                        const idbData = await IndexedDBService.getAll('grades');
                        if (idbData && idbData.length > 0) {
                            AppState.cache.set('grades', { data: idbData, timestamp: Date.now(), valid: true });
                            BackgroundSync.syncStore('grades');
                            return idbData;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                const params = { action: 'getGrades', ...filters };
                const result = await callGoogleScript('GET', params);
                const data = result.status === 'success' ? result.data : [];
                
                if (!hasFilters) {
                    AppState.cache.set('grades', { data, timestamp: Date.now(), valid: true });
                    await IndexedDBService.clear('grades');
                    await IndexedDBService.putBulk('grades', data);
                    await IndexedDBService.markSynced('grades');
                }
                return data;
            },
            
            async addGrade(gradeData) {
                const tempId = gradeData.id || `g-${Date.now()}`;
                const newGrade = { ...gradeData, id: tempId };
                
                const cached = CacheHelper.getCached('grades') || [];
                cached.push(newGrade);
                AppState.cache.set('grades', { data: cached, timestamp: Date.now(), valid: true });
                await IndexedDBService.put('grades', newGrade);
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('add', 'grades', newGrade);
                
                return { success: true, message: 'Nilai berhasil ditambahkan' };
            },
            
            async updateGrade(gradeData) {
                const cached = CacheHelper.getCached('grades') || [];
                // Cari dengan id ATAU gradeId ATAU kombinasi namaSiswa+kodeSoal
                const index = cached.findIndex(g => 
                    g.id === gradeData.id || 
                    g.id === gradeData.gradeId || 
                    g.gradeId === gradeData.gradeId ||
                    g.gradeId === gradeData.id ||
                    (gradeData.namaSiswa && gradeData.kodeSoal && 
                     g.namaSiswa === gradeData.namaSiswa && g.kodeSoal === gradeData.kodeSoal)
                );
                let updatedGrade = gradeData;
                
                if (index !== -1) {
                    // Merge dengan data existing untuk memastikan semua field tersedia
                    updatedGrade = { ...cached[index], ...gradeData };
                    // Pastikan gradeId konsisten
                    updatedGrade.gradeId = updatedGrade.gradeId || cached[index].gradeId;
                    updatedGrade.id = updatedGrade.id || updatedGrade.gradeId;
                    cached[index] = updatedGrade;
                } else {
                    // Jika tidak ditemukan, tambahkan sebagai baru
                    updatedGrade = { ...gradeData, id: gradeData.id || gradeData.gradeId };
                    cached.push(updatedGrade);
                }
                
                // Update cache global
                AppState.cache.set('grades', { data: cached, timestamp: Date.now(), valid: true });
                
                // PENTING: Clear semua filtered cache untuk grades agar data konsisten
                Object.keys(AppState.cache._data).forEach(key => {
                    if (typeof key === 'string' && key.startsWith('grades_')) {
                        delete AppState.cache._data[key];
                    }
                });
                
                // Update IndexedDB
                await IndexedDBService.put('grades', updatedGrade);
                
                // Enqueue for background sync - pastikan gradeId, namaSiswa, kodeSoal ada
                const syncData = {
                    ...updatedGrade,
                    gradeId: updatedGrade.gradeId,
                    namaSiswa: updatedGrade.namaSiswa,
                    kodeSoal: updatedGrade.kodeSoal
                };
                await BackgroundSync.queueOperation('update', 'grades', syncData);
                
                // TRIGGER: Auto-refresh UI Daftar Nilai jika sedang terbuka
                if (typeof UI !== 'undefined' && typeof UI.refreshGradesUIIfVisible === 'function') {
                    UI.refreshGradesUIIfVisible();
                }
                
                return { success: true, message: 'Nilai berhasil diupdate' };
            },
            
            async deleteGrade(gradeId) {
                const cached = CacheHelper.getCached('grades') || [];
                const filteredData = cached.filter(g => g.id !== gradeId);
                AppState.cache.set('grades', { data: filteredData, timestamp: Date.now(), valid: true });
                await IndexedDBService.delete('grades', gradeId);
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('delete', 'grades', { id: gradeId });
                
                return { success: true, message: 'Nilai berhasil dihapus' };
            },
            
            async deleteGrades(gradeIds) {
                const cached = CacheHelper.getCached('grades') || [];
                const filteredData = cached.filter(g => !gradeIds.includes(g.id));
                AppState.cache.set('grades', { data: filteredData, timestamp: Date.now(), valid: true });
                
                for (const id of gradeIds) {
                    await IndexedDBService.delete('grades', id);
                    await BackgroundSync.queueOperation('delete', 'grades', { id });
                }
                
                return { success: true, message: `${gradeIds.length} nilai berhasil dihapus` };
            },
            
            // ============ BLOCKED STUDENTS ============
            async getBlockedStudents(forceRefresh = false) {
                if (!forceRefresh && CacheHelper.isCacheValid('blockedStudents')) {
                    const cached = CacheHelper.getCached('blockedStudents');
                    if (cached) return cached;
                }
                
                if (!forceRefresh) {
                    try {
                        const idbData = await IndexedDBService.getAll('blockedStudents');
                        if (idbData && idbData.length > 0) {
                            AppState.cache.set('blockedStudents', { data: idbData, timestamp: Date.now(), valid: true });
                            BackgroundSync.syncStore('blockedStudents');
                            return idbData;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                const result = await callGoogleScript('GET', { action: 'getBlockedStudents' });
                const data = result.status === 'success' ? result.data : [];
                
                AppState.cache.set('blockedStudents', { data, timestamp: Date.now(), valid: true });
                await IndexedDBService.clear('blockedStudents');
                await IndexedDBService.putBulk('blockedStudents', data.map((b, i) => ({ ...b, id: b.id || `blocked-${i}` })));
                await IndexedDBService.markSynced('blockedStudents');
                
                return data;
            },
            
            async blockStudent(blockData) {
                const tempId = `blocked-${Date.now()}`;
                const newBlock = { ...blockData, id: tempId };
                
                const cached = CacheHelper.getCached('blockedStudents') || [];
                cached.push(newBlock);
                AppState.cache.set('blockedStudents', { data: cached, timestamp: Date.now(), valid: true });
                await IndexedDBService.put('blockedStudents', newBlock);
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('add', 'blockedStudents', newBlock);
                
                return { success: true, message: 'Siswa berhasil diblokir' };
            },
            
            async unblockStudent(blockId) {
                const cached = CacheHelper.getCached('blockedStudents') || [];
                // Find the blocked student to get username and examCode for proper sync
                const blockedStudent = cached.find(b => b.id === blockId || b.blockId === blockId);

                // Sync directly with Google Sheets first (wait for completion)
                const syncData = blockedStudent
                    ? { blockId: blockedStudent.blockId, username: blockedStudent.username, examCode: blockedStudent.examCode }
                    : { blockId: blockId };

                try {
                    await callGoogleScript('POST', { action: 'unblockStudent', data: syncData });
                } catch (e) {
                    console.error('Error syncing unblock to Google Sheets:', e);
                    // Still continue to update local cache/IndexedDB
                }

                // Update local cache and IndexedDB
                const filteredData = cached.filter(b => b.id !== blockId && b.blockId !== blockId);
                AppState.cache.set('blockedStudents', { data: filteredData, timestamp: Date.now(), valid: true });
                await IndexedDBService.delete('blockedStudents', blockId);

                return { success: true, message: 'Siswa berhasil di-unblock' };
            },

            async unblockAllStudents() {
                // Sync directly with Google Sheets first (wait for completion)
                try {
                    await callGoogleScript('POST', { action: 'unblockAllStudents', data: {} });
                } catch (e) {
                    console.error('Error syncing unblock all to Google Sheets:', e);
                    // Still continue to update local cache/IndexedDB
                }

                // Update local cache and IndexedDB
                AppState.cache.set('blockedStudents', { data: [], timestamp: Date.now(), valid: true });
                await IndexedDBService.clear('blockedStudents');

                return { success: true, message: 'Semua siswa berhasil di-unblock' };
            },
            
            async isStudentBlocked(username, examCode) {
                const blocked = await this.getBlockedStudents();
                return blocked.some(b => b.username === username && b.examCode === examCode);
            },
            
            // ============ SETTINGS ============
            async getSettings(key = 'examConfig', forceRefresh = false) {
                if (!forceRefresh && CacheHelper.isCacheValid('settings')) {
                    const cached = CacheHelper.getCached('settings');
                    if (cached) return cached;
                }
                
                if (!forceRefresh) {
                    try {
                        const idbData = await IndexedDBService.getAll('settings');
                        if (idbData && idbData.length > 0) {
                            const settings = idbData[0];
                            AppState.cache.set('settings', { data: settings, timestamp: Date.now(), valid: true });
                            AppState.examConfig = settings;
                            BackgroundSync.syncStore('settings');
                            return settings;
                        }
                    } catch (e) { console.warn('IDB read error:', e); }
                }
                
                const result = await callGoogleScript('GET', { action: 'getSettings', key: key });
                let data;
                if (result.status === 'success' && result.data) {
                    data = { id: 'examConfig', key: key, ...result.data };
                } else {
                    data = { id: 'examConfig', key: key, durationMinutes: 60 };
                }
                
                AppState.cache.set('settings', { data, timestamp: Date.now(), valid: true });
                AppState.examConfig = data;
                await IndexedDBService.clear('settings');
                await IndexedDBService.put('settings', data);
                await IndexedDBService.markSynced('settings');
                
                return data;
            },
            
            async saveSettings(settingsData) {
                const data = { id: 'examConfig', ...settingsData };
                AppState.cache.set('settings', { data, timestamp: Date.now(), valid: true });
                AppState.examConfig = data;
                await IndexedDBService.put('settings', data);
                
                // Enqueue for background sync
                await BackgroundSync.queueOperation('update', 'settings', data);
                
                return { success: true, message: 'Pengaturan berhasil disimpan' };
            }
        };

        // =================================================================
        // TEXT SIMILARITY - Penilaian otomatis tanpa AI
        // Menggunakan Levenshtein, N-gram, dan Keyword Matching
        // Prinsip: Toleransi typo, variasi kalimat, tidak kaku
        // =================================================================
        const TextSimilarity = {
            // Normalisasi teks: lowercase, hapus tanda baca berlebih, trim
            normalize(text) {
                if (!text) return '';
                return String(text)
                    .toLowerCase()
                    .replace(/[.,!?;:'"()\[\]{}]/g, ' ')  // Hapus tanda baca
                    .replace(/\s+/g, ' ')                  // Multiple spaces jadi single
                    .trim();
            },

            // Levenshtein Distance - mengukur jarak edit antar string
            levenshteinDistance(str1, str2) {
                const m = str1.length;
                const n = str2.length;
                
                if (m === 0) return n;
                if (n === 0) return m;
                
                const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
                
                for (let i = 0; i <= m; i++) dp[i][0] = i;
                for (let j = 0; j <= n; j++) dp[0][j] = j;
                
                for (let i = 1; i <= m; i++) {
                    for (let j = 1; j <= n; j++) {
                        const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                        dp[i][j] = Math.min(
                            dp[i - 1][j] + 1,      // deletion
                            dp[i][j - 1] + 1,      // insertion
                            dp[i - 1][j - 1] + cost // substitution
                        );
                    }
                }
                
                return dp[m][n];
            },

            // Levenshtein Similarity (0-100)
            levenshteinSimilarity(str1, str2) {
                const s1 = this.normalize(str1);
                const s2 = this.normalize(str2);
                
                if (s1 === s2) return 100;
                if (!s1 || !s2) return 0;
                
                const maxLen = Math.max(s1.length, s2.length);
                const distance = this.levenshteinDistance(s1, s2);
                return Math.round((1 - distance / maxLen) * 100);
            },

            // Fuzzy word match - toleransi 1-2 typo per kata (Levenshtein Distance)
            fuzzyWordMatch(word1, word2) {
                const w1 = this.normalize(word1);
                const w2 = this.normalize(word2);

                if (w1 === w2) return true;

                // Toleransi typo berdasarkan panjang kata
                const maxLen = Math.max(w1.length, w2.length);
                const distance = this.levenshteinDistance(w1, w2);

                // Kata pendek (<=4 huruf): toleransi 1 typo
                // Kata sedang (5-7 huruf): toleransi 1-2 typo
                // Kata panjang (>7 huruf): toleransi 2 typo
                let allowedTypos = 1;
                if (maxLen >= 5 && maxLen <= 7) allowedTypos = 2;
                if (maxLen > 7) allowedTypos = 2;

                return distance <= allowedTypos;
            },

            // Generate N-grams dari text
            generateNgrams(text, n = 2) {
                const normalized = this.normalize(text);
                const words = normalized.split(' ').filter(w => w.length > 0);
                
                if (words.length < n) return [normalized];
                
                const ngrams = [];
                for (let i = 0; i <= words.length - n; i++) {
                    ngrams.push(words.slice(i, i + n).join(' '));
                }
                return ngrams;
            },

            // N-gram Similarity (0-100)
            ngramSimilarity(str1, str2, n = 2) {
                const ngrams1 = this.generateNgrams(str1, n);
                const ngrams2 = this.generateNgrams(str2, n);
                
                if (ngrams1.length === 0 || ngrams2.length === 0) {
                    // Fallback ke word similarity jika terlalu pendek
                    return this.levenshteinSimilarity(str1, str2);
                }
                
                const set1 = new Set(ngrams1);
                const set2 = new Set(ngrams2);
                
                let matchCount = 0;
                set1.forEach(ng => {
                    if (set2.has(ng)) matchCount++;
                });
                
                const unionSize = new Set([...ngrams1, ...ngrams2]).size;
                return Math.round((matchCount / unionSize) * 100);
            },

            // Extract keywords (kata penting, abaikan stopwords)
            extractKeywords(text) {
                const stopwords = new Set([
                    'yang', 'dan', 'di', 'ke', 'dari', 'ini', 'itu', 'dengan', 'untuk',
                    'pada', 'adalah', 'sebagai', 'dalam', 'tidak', 'akan', 'juga',
                    'atau', 'ada', 'mereka', 'sudah', 'saya', 'kita', 'kami', 'anda',
                    'bisa', 'dapat', 'harus', 'oleh', 'setelah', 'tentang', 'seperti',
                    'ketika', 'saat', 'jika', 'maka', 'karena', 'agar', 'supaya',
                    'yaitu', 'yakni', 'merupakan', 'ialah', 'tersebut', 'sangat',
                    'lebih', 'paling', 'lalu', 'kemudian', 'sebelum', 'sesudah',
                    'bahwa', 'hal', 'cara', 'melalui', 'antara', 'sama', 'serta',
                    'the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been',
                    'of', 'to', 'in', 'for', 'on', 'with', 'at', 'by', 'from'
                ]);
                
                const normalized = this.normalize(text);
                const words = normalized.split(' ').filter(w => w.length > 2);
                return words.filter(w => !stopwords.has(w));
            },

            // Keyword Matching dengan Fuzzy (toleransi typo 1-2 karakter)
            keywordSimilarity(str1, str2) {
                const keywords1 = this.extractKeywords(str1); // jawaban siswa
                const keywords2 = this.extractKeywords(str2); // kunci jawaban

                if (keywords1.length === 0 && keywords2.length === 0) return 100;
                if (keywords1.length === 0 || keywords2.length === 0) return 0;

                let matchScore = 0;
                const totalKeywords = keywords2.length; // Gunakan kunci jawaban sebagai acuan

                // Untuk setiap keyword di kunci jawaban, cek apakah ada di jawaban siswa
                keywords2.forEach(correctKeyword => {
                    // Cek exact match atau fuzzy match (toleransi 1-2 typo)
                    const hasMatch = keywords1.some(studentKeyword => {
                        if (studentKeyword === correctKeyword) return true;
                        if (this.fuzzyWordMatch(studentKeyword, correctKeyword)) return true;
                        return false;
                    });

                    if (hasMatch) {
                        matchScore += 1;
                    } else {
                        // Partial match dengan Levenshtein untuk kata mirip
                        const bestSimilarity = keywords1.reduce((best, kw) => {
                            const sim = this.levenshteinSimilarity(kw, correctKeyword);
                            return sim > best ? sim : best;
                        }, 0);

                        // Jika similarity >= 70%, beri partial credit
                        if (bestSimilarity >= 70) {
                            matchScore += bestSimilarity / 100;
                        }
                    }
                });

                return Math.round((matchScore / totalKeywords) * 100);
            },

            // Hitung similarity gabungan dengan bobot
            calculateCombinedSimilarity(studentAnswer, correctAnswer) {
                // Normalisasi dulu
                const student = this.normalize(studentAnswer);
                const correct = this.normalize(correctAnswer);

                // Jika persis sama, langsung 100
                if (student === correct) return 100;

                // Jika kosong
                if (!student || student === 'tidak dijawab') return 0;
                if (!correct) return 0;

                // Hitung 3 metode similarity
                const levenshtein = this.levenshteinSimilarity(studentAnswer, correctAnswer);
                const ngram = this.ngramSimilarity(studentAnswer, correctAnswer, 2);
                const keyword = this.keywordSimilarity(studentAnswer, correctAnswer);

                // Bobot: Keyword 50%, Levenshtein 30%, N-gram 20%
                // Keyword paling penting untuk menilai konsep uraian
                const weightedScore = (keyword * 0.50) + (levenshtein * 0.30) + (ngram * 0.20);

                return Math.round(weightedScore);
            },

            // ===== PENILAIAN FLEKSIBEL UNTUK SOAL URAIAN =====
            // 1. Normalization: lowercase, trim, hapus tanda baca
            // 2. Keyword Scoring: poin untuk kata kunci yang ditemukan
            // 3. Fuzzy Matching: toleransi typo 1-2 karakter (Levenshtein)
            // 4. Threshold 60%: similarity >= 60% = nilai 100
            gradeAnswer(studentAnswer, correctAnswer) {
                const similarity = this.calculateCombinedSimilarity(studentAnswer, correctAnswer);

                let nilai;
                let feedback;

                if (similarity >= 60) {
                    // THRESHOLD 60%: Dianggap BENAR (nilai penuh)
                    nilai = 100;
                    feedback = 'Jawaban benar! Konsep dan kata kunci sesuai dengan kunci jawaban.';
                } else if (similarity >= 50) {
                    // Hampir mencapai threshold - nilai tinggi proporsional
                    nilai = 70 + Math.round((similarity - 50) * 3); // 50% = 70, 59% = 97
                    feedback = 'Jawaban sudah mendekati benar, ada sedikit perbedaan kata kunci.';
                } else if (similarity >= 40) {
                    // Cukup - sebagian konsep benar
                    nilai = 50 + Math.round((similarity - 40) * 2); // 40% = 50, 49% = 68
                    feedback = 'Jawaban cukup, beberapa konsep penting sudah disebutkan.';
                } else if (similarity >= 25) {
                    // Kurang - perlu perbaikan
                    nilai = 25 + Math.round((similarity - 25) * 1.67); // 25% = 25, 39% = 48
                    feedback = 'Jawaban kurang lengkap, perlu menambahkan kata kunci penting.';
                } else {
                    // Salah - tidak sesuai
                    nilai = Math.round(similarity);
                    feedback = 'Jawaban tidak sesuai dengan kunci jawaban.';
                }
                
                return {
                    nilai: nilai,
                    similarity: similarity,
                    feedback: feedback
                };
            }
        };

        // =================================================================
        // SISTEM PENILAIAN SD (Keyword Coverage-based Grading)
        // Khusus untuk anak SD dengan toleransi lebih longgar dan nilai lebih motivatif
        // =================================================================
        const SDGrading = {
            // ===== KONFIGURASI PENILAIAN SD =====
            config: {
                // Skala nilai (lebih lembut untuk SD)
                scoreRanges: [
                    { min: 0, max: 9, score: 20, status: 'Mencoba', feedback: 'Terus berusaha ya!' },
                    { min: 10, max: 19, score: 30, status: 'Kurang', feedback: 'Ada usaha, terus belajar!' },
                    { min: 20, max: 29, score: 45, status: 'Cukup', feedback: 'Mulai paham, bagus!' },
                    { min: 30, max: 39, score: 60, status: 'Cukup Baik', feedback: 'Bagus sekali!' },
                    { min: 40, max: 49, score: 75, status: 'Baik', feedback: 'Hebat! Kamu paham sebagian besar!' },
                    { min: 50, max: 59, score: 90, status: 'Sangat Baik', feedback: 'Sangat Hebat!' },
                    { min: 60, max: 100, score: 100, status: 'Luar Biasa!', feedback: 'Luar Biasa! Kamu Pintar!' }
                ],

                // Typo tolerance (lebih longgar untuk SD)
                typoTolerance: {
                    minLength: 4,    // Kata ‚â§ 4 huruf: 0 typo
                    shortWord: 7,   // Kata 5-7 huruf: 1 typo
                    mediumWord: 12, // Kata 8-12 huruf: 2 typo
                    longWord: 99    // Kata >12 huruf: 3 typo
                },

                // Fuzzy match threshold (lebih rendah untuk SD)
                fuzzyThreshold: 0.65,  // 65% similarity dianggap match

                // Stopword bahasa Indonesia (dihapus dari penilaian)
                stopwords: [
                    // Kata penghubung
                    'dan', 'atau', 'tetapi', 'namun', 'karena', 'maka', 'jika',
                    'sehingga', 'untuk', 'dengan', 'pada', 'di', 'ke', 'dari', 'dalam',
                    // Kata tanya
                    'apa', 'siapa', 'mengapa', 'bagaimana', 'kapan', 'dimana', 'kenapa',
                    // Pronomina
                    'saya', 'aku', 'kamu', 'engkau', 'dia', 'mereka', 'kita', 'kami',
                    // Partikel
                    'yang', 'pun', 'lah', 'kah', 'tah', 'juga', 'lagi', 'lebih', 'paling',
                    // Preposisi
                    'oleh', 'yaitu', 'ialah', 'yakni', 'adalah', 'menjadi',
                    // Kuantitas
                    'semua', 'tiap', 'setiap', 'banyak', 'sedikit', 'sebagian',
                    // Kata lain-lain
                    'ini', 'itu', 'tersebut', 'sangat', 'lalu', 'kemudian', 'sebelum', 'sesudah',
                    'bahwa', 'hal', 'cara', 'melalui', 'antara', 'sama', 'serta',
                    // English common words
                    'the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been',
                    'of', 'to', 'in', 'for', 'on', 'with', 'at', 'by', 'from'
                ]
            },

            // ===== FUNGSI UTAMA: gradeAnswerForSD =====
            // Menilai jawaban siswa dengan metode keyword coverage
            gradeAnswerForSD(studentAnswer, correctAnswer) {
                // STEP 1: Ekstrak kata kunci
                const correctKeywords = this.extractKeywords(correctAnswer);
                const studentKeywords = this.extractKeywords(studentAnswer);

                // STEP 2: Hitung matches
                let totalScore = 0;
                const matchedKeywords = [];
                const missedKeywords = [];

                correctKeywords.forEach(correctKeyword => {
                    let bestMatch = null;
                    let bestSimilarity = 0;

                    // Cari match terbaik di jawaban siswa
                    studentKeywords.forEach(studentKeyword => {
                        const similarity = this.calculateSimilarity(
                            studentKeyword,
                            correctKeyword
                        );

                        if (similarity > bestSimilarity) {
                            bestMatch = studentKeyword;
                            bestSimilarity = similarity;
                        }
                    });

                    // Hitung skor berdasarkan similarity
                    if (bestSimilarity >= this.config.fuzzyThreshold) {
                        totalScore += 1;
                        matchedKeywords.push({
                            correct: correctKeyword,
                            student: bestMatch,
                            similarity: bestSimilarity,
                            type: 'full'
                        });
                    } else if (bestSimilarity >= 0.5) {
                        // Partial match (setengah poin)
                        totalScore += 0.5;
                        matchedKeywords.push({
                            correct: correctKeyword,
                            student: bestMatch,
                            similarity: bestSimilarity,
                            type: 'partial'
                        });
                    } else {
                        missedKeywords.push(correctKeyword);
                    }
                });

                // STEP 3: Hitung persentase
                const percentage = (totalScore / correctKeywords.length) * 100;

                // STEP 4: Tentukan skor akhir
                const scoreRange = this.config.scoreRanges.find(
                    range => percentage >= range.min && percentage <= range.max
                );

                const finalScore = scoreRange ? scoreRange.score : 0;
                const feedback = scoreRange ? scoreRange.feedback : "";
                const status = scoreRange ? scoreRange.status : "";

                // STEP 5: Generate detailed feedback
                const detailFeedback = this.generateDetailedFeedback(
                    matchedKeywords,
                    missedKeywords,
                    percentage
                );

                return {
                    score: finalScore,
                    percentage: Math.round(percentage),
                    status: status,
                    feedback: feedback,
                    detailFeedback: detailFeedback,
                    matched: matchedKeywords,
                    missed: missedKeywords,
                    totalKeywords: correctKeywords.length,
                    matchedCount: matchedKeywords.length,
                    details: {
                        totalScore: totalScore,
                        exactMatches: matchedKeywords.filter(m => !m.partial && m.type === 'full').length,
                        partialMatches: matchedKeywords.filter(m => m.type === 'partial').length
                    }
                };
            },

            // ===== EKSTRAKSI KATA KUNCI =====
            extractKeywords(text) {
                if (!text) return [];

                // Lowercase dan hapus tanda baca
                let normalized = text.toLowerCase()
                    .replace(/[^\w\s]/g, '')  // Hapus tanda baca
                    .replace(/\s+/g, ' ')      // Multiple spaces jadi single
                    .trim();

                // Split menjadi kata-kata
                const words = normalized.split(' ').filter(w => w.length > 2);

                // Hapus stopwords
                const keywords = words.filter(
                    word => !this.config.stopwords.includes(word)
                );

                // Hapus duplikat dan return
                return [...new Set(keywords)];
            },

            // ===== HITUNG SIMILARITY DENGAN TYPO TOLERANCE =====
            calculateSimilarity(str1, str2) {
                const len1 = str1.length;

                // Tentukan max typo berdasarkan panjang kata
                let maxTypo;
                if (len1 <= this.config.typoTolerance.minLength) {
                    maxTypo = 0;
                } else if (len1 <= this.config.typoTolerance.shortWord) {
                    maxTypo = 1;
                } else if (len1 <= this.config.typoTolerance.mediumWord) {
                    maxTypo = 2;
                } else {
                    maxTypo = 3;
                }

                // Hitung Levenshtein distance
                const distance = this.levenshteinDistance(str1, str2);

                // Jika melebihi tolerance, tidak match
                if (distance > maxTypo) {
                    return 0;
                }

                // Hitung similarity
                const maxLength = Math.max(len1, str2.length);
                const similarity = 1 - (distance / maxLength);

                return similarity;
            },

            // ===== LEVENSHTEIN DISTANCE =====
            levenshteinDistance(str1, str2) {
                const m = str1.length;
                const n = str2.length;
                const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

                for (let i = 0; i <= m; i++) dp[i][0] = i;
                for (let j = 0; j <= n; j++) dp[0][j] = j;

                for (let i = 1; i <= m; i++) {
                    for (let j = 1; j <= n; j++) {
                        if (str1[i - 1] === str2[j - 1]) {
                            dp[i][j] = dp[i - 1][j - 1];
                        } else {
                            dp[i][j] = 1 + Math.min(
                                dp[i - 1][j],      // Delete
                                dp[i][j - 1],      // Insert
                                dp[i - 1][j - 1]   // Replace
                            );
                        }
                    }
                }

                return dp[m][n];
            },

            // ===== GENERATE DETAILED FEEDBACK =====
            generateDetailedFeedback(matchedKeywords, missedKeywords, percentage) {
                let feedback = "";

                // Highlight kata yang cocok
                if (matchedKeywords.length > 0) {
                    const exactMatches = matchedKeywords.filter(m => m.type === 'full');
                    const partialMatches = matchedKeywords.filter(m => m.type === 'partial');

                    feedback += `<strong>Kata yang cocok:</strong> ${exactMatches.map(m => m.student).join(', ')}`;
                    if (partialMatches.length > 0) {
                        feedback += ` (hampir: ${partialMatches.map(m => m.student).join(', ')})`;
                    }
                }

                // Highlight kata yang kurang
                if (missedKeywords.length > 0) {
                    if (feedback) feedback += "<br><br>";
                    feedback += `<strong>Kata yang kurang:</strong> ${missedKeywords.join(', ')}`;
                }

                // Persentase
                if (feedback) feedback += "<br><br>";
                feedback += `<strong>Persentase:</strong> ${Math.round(percentage)}% kata kunci yang cocok`;

                return feedback;
            }
        };

        // =================================================================
        // GOOGLE SCRIPT HELPER (Full Google Sheets)
        // =================================================================

        // =================================================================
        // APPLICATION STATE
        // =================================================================
        const AppState = {
            currentUser: null,
            currentQuestion: 0,
            examAnswers: {},
            examTimer: null,
            examTimeLeft: 3600, // 60 minutes in seconds
            questions: [], // This will be populated from Google Sheets for the current exam
            currentView: 'login',
            selectedExamCode: null,
            violationCount: 0, // Replaces fullscreenViolations
            lastQuestionData: { semester: '', tahunAjaran: '' }, // To store last used question data for teacher
            pendingGradeUpdates: {}, // Key: "studentName|examCode", Value: {nilai, grade, keterangan}
            filters: {
                questions: { kelas: '', mataPelajaran: '', kode: '' },
                results: { kodesoal: '', mataPelajaran: '', kelas: '', namaLengkap: '' },
                grades: { kodeSoal: '', mataPelajaran: '', kelas: '', namaSiswa: '' }
            },
            currentlyDisplayed: {
                questions: [],
                results: [],
                grades: []
            },
            // Pagination and Caching
            pagination: {
                questions: { currentPage: 1, totalItems: 0 },
                results: { currentPage: 1, totalItems: 0 },
                grades: { currentPage: 1, totalItems: 0 }
            },
            itemsPerPage: 25,
            cache: {
                _data: {},
                generateKey: (prefix, filters) => `${prefix}_${JSON.stringify(filters)}`,
                get: function(key) { return this._data[key]; },
                set: function(key, value) { this._data[key] = value; },
                delete: function(key) { delete this._data[key]; },
                clear: function() { this._data = {}; }
            },
            // Users are now fetched from Google Script
            users: [],
            // Classes and Subjects remain local
            classes: [
                { id: 1, nama: '4A', deskripsi: 'Kelas 4A' }, { id: 2, nama: '4B', deskripsi: 'Kelas 4B' },
                { id: 3, nama: '4C', deskripsi: 'Kelas 4C' }, { id: 4, nama: '4D', deskripsi: 'Kelas 4D' },
                { id: 5, nama: '5A', deskripsi: 'Kelas 5A' }, { id: 6, nama: '5B', deskripsi: 'Kelas 5B' },
                { id: 9, nama: '6A', deskripsi: 'Kelas 6A' }, { id: 10, nama: '6B', deskripsi: 'Kelas 6B' }
            ],
            subjects: [
                { id: 1, nama: 'Bahasa Indonesia', deskripsi: 'Mata pelajaran Bahasa Indonesia' },
                { id: 2, nama: 'Matematika', deskripsi: 'Mata pelajaran Matematika' },
                { id: 3, nama: 'Bahasa Inggris', deskripsi: 'Mata pelajaran Bahasa Inggris' },
                { id: 4, nama: 'Pend. Pancasila', deskripsi: 'Mata pelajaran Pend. Pancasila' },
                { id: 5, nama: 'IPAS', deskripsi: 'Mata pelajaran IPAS' },
                { id: 6, nama: 'Seni Rupa', deskripsi: 'Mata pelajaran Seni Rupa' },
                { id: 7, nama: 'Tauhid', deskripsi: 'Mata pelajaran Tauhid' },
                { id: 8, nama: 'Bahasa Arab', deskripsi: 'Mata pelajaran Bahasa Arab' },
                { id: 9, nama: 'Fikih', deskripsi: 'Mata pelajaran Fikih' },
                { id: 10, nama: 'Siroh', deskripsi: 'Mata pelajaran Siroh' },
                { id: 11, nama: 'Akhlak', deskripsi: 'Mata pelajaran Akhlak' },
                { id: 12, nama: 'Hadits', deskripsi: 'Mata pelajaran Hadits' },
                { id: 13, nama: 'Khot', deskripsi: 'Mata pelajaran Khot' },
                { id: 14, nama: 'PJOK', deskripsi: 'Mata pelajaran PJOK' }
            ]
        };
        
        // =================================================================
        // GOOGLE SCRIPT HELPER
        // =================================================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx1Um_h-dHgE9L5mKX9SPXgJQkw_obuAkx1V-RX5YfGLlvyX6zTfRphL_24JXl9qGc/exec';

        async function callGoogleScript(method = 'GET', params = {}) {
            const url = new URL(SCRIPT_URL);
            
            if (method === 'GET') {
                Object.keys(params).forEach(key => {
                    if (params[key] || params[key] === 0) { // Also include params with value 0
                        url.searchParams.append(key, params[key]);
                    }
                });

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                } catch (error) {
                    console.error('Error calling Google Script (GET):', error);
                    UI.showNotification('Gagal terhubung ke Google Sheet.', 'error');
                    throw error;
                }
            } else if (method === 'POST') {
                try {
                    // Use fetch with redirect handling for Google Apps Script
                    // GAS redirects to the actual response, so we need to follow redirects
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify(params),
                        redirect: 'follow'
                    });
                    
                    // Try to parse response as JSON
                    try {
                        const text = await response.text();
                        // GAS sometimes returns HTML wrapper, try to extract JSON
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            return JSON.parse(jsonMatch[0]);
                        }
                        return { status: 'success', message: 'Data sent successfully.' };
                    } catch (parseError) {
                        // If we can't parse, assume success if request didn't throw
                        console.log('[POST] Response received but not JSON, assuming success');
                        return { status: 'success', message: 'Data sent successfully.' };
                    }
                } catch (error) {
                    console.error('Error calling Google Script (POST):', error);
                    // If CORS error, try with no-cors mode as fallback
                    if (error.message && error.message.includes('CORS')) {
                        console.log('[POST] CORS error, trying no-cors mode...');
                        await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify(params),
                            redirect: 'follow'
                        });
                        return { status: 'success', message: 'Data sent (no-cors fallback).' };
                    }
                    throw error;
                }
            }
        }
        
        // =================================================================
        // DATA FETCHING - Menggunakan arsitektur IndexedDB ‚Üí Google Apps Script
        // =================================================================
        async function fetchUsersFromGoogleScript() {
            try {
                // Arsitektur baru: IndexedDB first, then sync from server
                const users = await DataService.getUsers();
                
                if (users && Array.isArray(users) && users.length > 0) {
                    AppState.users = users.map((user, index) => ({
                        ...user,
                        id: user.id || `gs-user-${index}`
                    }));
                    console.log('User data loaded successfully from IndexedDB/Server.');
                    return true;
                } else {
                    // Try force refresh from server
                    const freshUsers = await DataService.getUsers(true);
                    if (freshUsers && Array.isArray(freshUsers) && freshUsers.length > 0) {
                        AppState.users = freshUsers.map((user, index) => ({
                            ...user,
                            id: user.id || `gs-user-${index}`
                        }));
                        console.log('User data loaded successfully from Server.');
                        return true;
                    }
                    throw new Error('No user data available.');
                }
            } catch (error) {
                console.error('Failed to fetch user data:', error);
                const loginError = document.getElementById('loginError');
                if (loginError) {
                    loginError.textContent = 'Gagal memuat data pengguna. Silakan muat ulang halaman.';
                    loginError.classList.remove('hidden');
                }
                return false;
            }
        }

        // =================================================================
        // MANAGEMENT SYSTEM (Full Google Sheets Integration)
        // =================================================================
        const Management = {
            generateId() {
                return 'id-' + Date.now() + Math.random().toString(36).substr(2, 9);
            },

            // User, Class, Subject management remain local as requested
            showAddUserModal() {
                const content = `
                    <form id="addUserForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('kelasField').classList.remove('hidden') : document.getElementById('kelasField').classList.add('hidden')">
                                    <option value="">Pilih Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="guru">Guru</option>
                                    <option value="siswa">Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="kelasField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Pengguna', content);
                
                document.getElementById('addUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    AppState.users.push({
                        id: this.generateId(),
                        ...userData
                    });
                    
                    UI.hideModal();
                    UI.showUserManagement();
                    UI.showNotification('Pengguna berhasil ditambahkan! Perubahan hanya bersifat lokal.', 'success');
                });
            },

            viewUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <div class="space-y-4">
                        <div><strong>Username:</strong> ${user.username}</div>
                        <div><strong>Nama:</strong> ${user.nama}</div>
                        <div><strong>Role:</strong> ${user.role}</div>
                        <div><strong>Kelas:</strong> ${user.kelas || '-'}</div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Pengguna', content);
            },

            editUser(id) {
                const user = AppState.users.find(u => u.id == id);
                const content = `
                    <form id="editUserForm" class="space-y-4">
                        <input type="hidden" name="id" value="${user.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" name="username" value="${user.username}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" name="password" value="${user.password}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" name="nama" value="${user.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                <select name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="this.value === 'siswa' ? document.getElementById('editKelasField').classList.remove('hidden') : document.getElementById('editKelasField').classList.add('hidden')">
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    <option value="guru" ${user.role === 'guru' ? 'selected' : ''}>Guru</option>
                                    <option value="siswa" ${user.role === 'siswa' ? 'selected' : ''}>Siswa</option>
                                </select>
                            </div>
                        </div>
                        <div id="editKelasField" class="${user.role === 'siswa' ? '' : 'hidden'}">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select name="kelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Kelas</option>
                                ${AppState.classes.map(c => `<option value="${c.nama}" ${user.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Pengguna', content);
                
                document.getElementById('editUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const userData = Object.fromEntries(formData);
                    
                    if (userData.role !== 'siswa') {
                        userData.kelas = '';
                    }
                    
                    // OPTIMISTIC UI: Update local state immediately
                    const index = AppState.users.findIndex(u => u.id == userData.id);
                    if (index !== -1) {
                        AppState.users[index] = { ...AppState.users[index], ...userData };
                        UI.hideModal();
                        UI.showUserManagement();
                        
                        // BACKGROUND: Sync to server (fire and forget)
                        callGoogleScript('POST', { 
                            action: 'updateUser', 
                            data: userData 
                        }).then(result => {
                            if (result.status !== 'success') {
                                console.error('[Sync] Update user failed:', result.message);
                                UI.showNotification('Gagal sync ke server', 'warning');
                            }
                        }).catch(err => {
                            console.error('[Sync] Update user error:', err);
                            UI.showNotification('Gagal sync ke server', 'warning');
                        });
                    }
                });
            },

            deleteUser(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus pengguna ini?', () => {
                    // Get username before removing
                    const userToDelete = AppState.users.find(u => u.id == id);
                    const username = userToDelete ? userToDelete.username : null;
                    
                    // OPTIMISTIC UI: Remove from local state immediately
                    AppState.users = AppState.users.filter(u => u.id != id);
                    UI.showUserManagement();
                    
                    // BACKGROUND: Sync to server (fire and forget)
                    if (username) {
                        callGoogleScript('POST', { 
                            action: 'deleteUser', 
                            data: { username: username } 
                        }).then(result => {
                            if (result.status !== 'success') {
                                console.error('[Sync] Delete user failed:', result.message);
                                UI.showNotification('Gagal sync hapus ke server', 'warning');
                            }
                        }).catch(err => {
                            console.error('[Sync] Delete user error:', err);
                            UI.showNotification('Gagal sync hapus ke server', 'warning');
                        });
                    }
                });
            },

            showAddClassModal() {
                const content = `
                    <form id="addClassForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: 1A">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi kelas"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Kelas', content);
                
                document.getElementById('addClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    AppState.classes.push({
                        id: this.generateId(),
                        ...classData
                    });
                    
                    UI.hideModal();
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil ditambahkan!', 'success');
                });
            },

            editClass(id) {
                const cls = AppState.classes.find(c => c.id == id);
                const content = `
                    <form id="editClassForm" class="space-y-4">
                        <input type="hidden" name="id" value="${cls.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kelas</label>
                            <input type="text" name="nama" value="${cls.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${cls.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Kelas', content);
                
                document.getElementById('editClassForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const classData = Object.fromEntries(formData);
                    
                    const index = AppState.classes.findIndex(c => c.id == classData.id);
                    if (index !== -1) {
                        AppState.classes[index] = { ...AppState.classes[index], ...classData };
                        UI.hideModal();
                        UI.showClassManagement();
                        UI.showNotification('Kelas berhasil diupdate!', 'success');
                    }
                });
            },

            deleteClass(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus kelas ini?', () => {
                    AppState.classes = AppState.classes.filter(c => c.id != id);
                    UI.showClassManagement();
                    UI.showNotification('Kelas berhasil dihapus!', 'success');
                });
            },

            showAddSubjectModal() {
                const content = `
                    <form id="addSubjectForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Matematika">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Deskripsi mata pelajaran"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Mata Pelajaran', content);
                
                document.getElementById('addSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    AppState.subjects.push({
                        id: this.generateId(),
                        ...subjectData
                    });
                    
                    UI.hideModal();
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil ditambahkan!', 'success');
                });
            },

            editSubject(id) {
                const subject = AppState.subjects.find(s => s.id == id);
                const content = `
                    <form id="editSubjectForm" class="space-y-4">
                        <input type="hidden" name="id" value="${subject.id}">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Mata Pelajaran</label>
                            <input type="text" name="nama" value="${subject.nama}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${subject.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Mata Pelajaran', content);
                
                document.getElementById('editSubjectForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const subjectData = Object.fromEntries(formData);
                    
                    const index = AppState.subjects.findIndex(s => s.id == subjectData.id);
                    if (index !== -1) {
                        AppState.subjects[index] = { ...AppState.subjects[index], ...subjectData };
                        UI.hideModal();
                        UI.showSubjectManagement();
                        UI.showNotification('Mata pelajaran berhasil diupdate!', 'success');
                    }
                });
            },

            deleteSubject(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus mata pelajaran ini?', () => {
                    AppState.subjects = AppState.subjects.filter(s => s.id != id);
                    UI.showSubjectManagement();
                    UI.showNotification('Mata pelajaran berhasil dihapus!', 'success');
                });
            },

            unblockStudent(blockId) {
                UI.showConfirmModal('Konfirmasi Buka Blokir', 'Anda yakin ingin membuka blokir siswa ini?', async () => {
                    Swal.fire({
                        title: 'Memproses...',
                        text: 'Sedang membuka blokir siswa.',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    try {
                        await DataService.unblockStudent(blockId);
                        // Force refresh from server to ensure UI is in sync
                        await DataService.getBlockedStudents(true);
                        Swal.close();
                        UI.showNotification('Blokir siswa berhasil dibuka!', 'success');
                        UI.renderBlockedStudents();
                    } catch (error) {
                        Swal.close();
                        console.error("Error unblocking student: ", error);
                        UI.showNotification('Gagal membuka blokir siswa!', 'error');
                    }
                });
            },

            unblockAllStudents() {
                UI.showConfirmModal('Konfirmasi Buka Semua Blokir', 'Anda yakin ingin membuka blokir untuk SEMUA siswa? Tindakan ini tidak dapat dibatalkan.', async () => {
                    Swal.fire({
                        title: 'Memproses...',
                        text: 'Sedang membuka semua blokir siswa.',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });
                    try {
                        await DataService.unblockAllStudents();
                        // Force refresh from server to ensure UI is in sync
                        await DataService.getBlockedStudents(true);
                        Swal.close();
                        UI.showNotification('Semua blokir siswa berhasil dibuka!', 'success');
                        UI.renderBlockedStudents();
                    } catch (error) {
                        Swal.close();
                        console.error("Error unblocking all students: ", error);
                        UI.showNotification('Gagal membuka semua blokir siswa!', 'error');
                    }
                });
            },

            // =================================================================
            // Question Management (Google Sheets Integration)
            // =================================================================
            showAddQuestionModal() {
                const lastData = AppState.lastQuestionData;
                let classOptions = '';
                if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else { // Admin sees all classes
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }

                const content = `
                    <form id="addQuestionForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Tahun Ajaran</option>
                                    ${UI.getYearOptions(lastData.tahunAjaran)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Semester</option>
                                    ${UI.getSemesterOptions(lastData.semester)}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                <input type="text" name="kode" value="${lastData.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PAI001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${lastData.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                            <select id="questionTypeSelect" name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="UI.toggleAnswerFields(this.value, 'addQuestionForm')">
                                <option value="">Pilih Tipe Soal</option>
                                <option value="pilihan_ganda" ${lastData.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                <option value="isian" ${lastData.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                <option value="uraian" ${lastData.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                            <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan pertanyaan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                            <input type="file" id="gambarInput" name="gambarFile" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Ukuran gambar maksimal 10cm x 10cm</p>
                        </div>
                        <div id="pilihanField" class="${lastData.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan & Jawaban Benar</label>
                            <input type="text" name="pilihan1" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan2" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan3" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan4" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select name="correct" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Jawaban Benar</option>
                                <option value="0">A</option>
                                <option value="1">B</option>
                                <option value="2">C</option>
                                <option value="3">D</option>
                            </select>
                        </div>
                        <div id="jawabanTeksField" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                            <textarea name="jawabanBenar" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan jawaban yang benar untuk soal isian/uraian"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                `;
                UI.showModal('Tambah Soal', content);
                
                document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
                    
                    try {
                        const formData = new FormData(form);
                        const questionData = Object.fromEntries(formData);

                        // Validation
                        if (questionData.tipe === 'pilihan_ganda' && !questionData.correct) {
                            throw new Error('Silakan pilih jawaban yang benar untuk Pilihan Ganda.');
                        }
                        if ((questionData.tipe === 'isian' || questionData.tipe === 'uraian') && !questionData.jawabanBenar.trim()) {
                            throw new Error('Silakan isi kunci jawaban untuk soal Isian atau Uraian.');
                        }
                        
                        questionData.createdBy = AppState.currentUser.nama;
                        
                        const fileInput = document.getElementById('gambarInput');
                        if (fileInput.files[0]) {
                            questionData.gambar = await UI.toBase64(fileInput.files[0]);
                        } else {
                            questionData.gambar = null;
                        }

                        if (questionData.tipe === 'pilihan_ganda') {
                            questionData.pilihan = [
                                questionData.pilihan1, questionData.pilihan2, questionData.pilihan3, questionData.pilihan4
                            ].filter(p => p);
                            questionData.correct = parseInt(questionData.correct);
                            delete questionData.pilihan1;
                            delete questionData.pilihan2;
                            delete questionData.pilihan3;
                            delete questionData.pilihan4;
                            delete questionData.jawabanBenar;
                        } else {
                           questionData.pilihan = [];
                           questionData.correct = null;
                        }
                        delete questionData.gambarFile;

                        // Instant save to IndexedDB + background sync
                        await DataService.addQuestion(questionData);

                        AppState.cache.clear(); 
                        AppState.lastQuestionData = {
                            tahunAjaran: questionData.tahunAjaran,
                            semester: questionData.semester,
                            kode: questionData.kode,
                            kelas: questionData.kelas,
                            mataPelajaran: questionData.mataPelajaran,
                            tipe: questionData.tipe
                        };
                        UI.hideModal();
                        UI.showNotification('Soal berhasil ditambahkan', 'success');
                        UI.loadAndRenderPaginatedQuestions(); // Refresh list
                    } catch (error) {
                        console.error("Error adding question: ", error);
                        UI.showNotification(error.message || 'Gagal menambahkan soal!', 'error');
                    } finally {
                         submitButton.disabled = false;
                         submitButton.innerHTML = 'Simpan';
                    }
                });
            },

            async viewQuestion(id) {
                const cacheKey = AppState.cache.generateKey('questions', AppState.filters.questions);
                const allFilteredQuestions = AppState.cache.get(cacheKey);
                
                if (!allFilteredQuestions) {
                    UI.showNotification('Cache soal tidak ditemukan. Silakan filter ulang.', 'error');
                    return;
                }
                const question = allFilteredQuestions.find(q => q.id === id);

                if (!question) {
                    UI.showNotification('Soal tidak ditemukan', 'error');
                    return;
                }
                
                let optionsHtml = '';
                if (question.tipe === 'pilihan_ganda' && Array.isArray(question.pilihan)) {
                    optionsHtml = `
                        <div class="mt-4">
                            <h5 class="font-semibold text-gray-700 mb-2">Pilihan Jawaban:</h5>
                            <ul class="list-disc list-inside space-y-2">
                                ${question.pilihan.map((opt, index) => `
                                    <li class="${index === question.correct ? 'font-bold text-green-600' : ''}">
                                        ${String.fromCharCode(65 + index)}. ${opt} ${index === question.correct ? '(Jawaban Benar)' : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                } else if ((question.tipe === 'isian' || question.tipe === 'uraian') && question.jawabanBenar) {
                    optionsHtml = `
                        <div class="mt-4">
                            <h5 class="font-semibold text-gray-700 mb-2">Kunci Jawaban:</h5>
                            <p class="p-4 bg-green-50 rounded-md border text-green-800">${question.jawabanBenar}</p>
                        </div>
                    `;
                }

                const content = `
                    <div class="space-y-4 text-gray-800">
                        <div><span class="font-semibold">ID:</span> <span class="text-xs text-gray-500">${question.id}</span></div>
                        <div><span class="font-semibold">Kode Soal:</span> <span>${question.kode}</span></div>
                        <div><span class="font-semibold">Kelas:</span> <span>${question.kelas}</span></div>
                        <div><span class="font-semibold">Mata Pelajaran:</span> <span>${question.mataPelajaran}</span></div>
                        <div><span class="font-semibold">Tipe Soal:</span> <span>${question.tipe}</span></div>
                        <hr class="my-4">
                        <div>
                            <h5 class="font-semibold mb-2">Pertanyaan:</h5>
                            <p class="p-4 bg-gray-50 rounded-md border">${question.pertanyaan || ''}</p>
                        </div>
                        ${question.gambar ? `
                            <div class="mt-4">
                                <h5 class="font-semibold text-gray-700 mb-2">Gambar:</h5>
                                <img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-sm border">
                            </div>
                        ` : ''}
                        ${optionsHtml}
                    </div>
                    <div class="flex justify-end pt-6 mt-6 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Soal', content);
            },

            async editQuestion(id) {
                const cacheKey = AppState.cache.generateKey('questions', AppState.filters.questions);
                const allFilteredQuestions = AppState.cache.get(cacheKey);

                if (!allFilteredQuestions) {
                    UI.showNotification('Cache soal tidak ditemukan. Silakan filter ulang.', 'error');
                    return;
                }
                const question = allFilteredQuestions.find(q => q.id === id);

                if (!question) {
                    UI.showNotification('Soal tidak ditemukan untuk diedit.', 'error');
                    return;
                }

                let classOptions = '';
                if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else { 
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${question.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }
                
                const content = `
                    <form id="editQuestionForm" class="space-y-4">
                        <input type="hidden" name="id" value="${question.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Tahun Ajaran</option>
                                    ${UI.getYearOptions(question.tahunAjaran)}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Semester</option>
                                    ${UI.getSemesterOptions(question.semester)}
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label>
                                <input type="text" name="kode" value="${question.kode || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${question.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Soal</label>
                            <select name="tipe" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="UI.toggleAnswerFields(this.value, 'editQuestionForm')">
                                <option value="pilihan_ganda" ${question.tipe === 'pilihan_ganda' ? 'selected' : ''}>Pilihan Ganda</option>
                                <option value="isian" ${question.tipe === 'isian' ? 'selected' : ''}>Isian</option>
                                <option value="uraian" ${question.tipe === 'uraian' ? 'selected' : ''}>Uraian</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                            <textarea name="pertanyaan" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${question.pertanyaan || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Gambar (Opsional)</label>
                            <input type="file" id="editGambarInput" name="gambarFile" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Pilih gambar baru untuk mengganti yang lama. Ukuran maksimal 10cm x 10cm.</p>
                            <div id="editImagePreview" class="mt-2">
                                ${question.gambar ? `<img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-sm">` : ''}
                            </div>
                        </div>
                        <div id="pilihanField" class="${question.tipe === 'pilihan_ganda' ? '' : 'hidden'} space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan & Jawaban Benar</label>
                            <input type="text" name="pilihan1" value="${question.pilihan ? question.pilihan[0] || '' : ''}" placeholder="Pilihan A" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan2" value="${question.pilihan ? question.pilihan[1] || '' : ''}" placeholder="Pilihan B" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan3" value="${question.pilihan ? question.pilihan[2] || '' : ''}" placeholder="Pilihan C" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="pilihan4" value="${question.pilihan ? question.pilihan[3] || '' : ''}" placeholder="Pilihan D" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select name="correct" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Pilih Jawaban Benar</option>
                                <option value="0" ${question.correct === 0 ? 'selected' : ''}>A</option>
                                <option value="1" ${question.correct === 1 ? 'selected' : ''}>B</option>
                                <option value="2" ${question.correct === 2 ? 'selected' : ''}>C</option>
                                <option value="3" ${question.correct === 3 ? 'selected' : ''}>D</option>
                            </select>
                        </div>
                        <div id="jawabanTeksField" class="${question.tipe === 'isian' || question.tipe === 'uraian' ? '' : 'hidden'}">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jawaban Benar</label>
                            <textarea name="jawabanBenar" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${question.jawabanBenar || ''}</textarea>
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Soal', content);
                
                document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengupdate...';
                    
                    try {
                        const formData = new FormData(form);
                        const questionData = Object.fromEntries(formData);
                        
                        // Validation
                        if (questionData.tipe === 'pilihan_ganda' && questionData.correct === '') {
                            throw new Error('Silakan pilih jawaban yang benar untuk Pilihan Ganda.');
                        }
                        if ((questionData.tipe === 'isian' || questionData.tipe === 'uraian') && !questionData.jawabanBenar.trim()) {
                           throw new Error('Silakan isi kunci jawaban untuk soal Isian atau Uraian.');
                        }

                        // Preserve owner info and creation date from original object
                        questionData.createdBy = question.createdBy || AppState.currentUser.nama;
                        questionData.createdAt = question.createdAt;
                        
                        const fileInput = document.getElementById('editGambarInput');
                        if (fileInput.files[0]) {
                            questionData.gambar = await UI.toBase64(fileInput.files[0]);
                        } else {
                            questionData.gambar = question.gambar; // Keep old image
                        }
                        
                        if (questionData.tipe === 'pilihan_ganda') {
                            questionData.pilihan = [
                                questionData.pilihan1, questionData.pilihan2, questionData.pilihan3, questionData.pilihan4
                            ].filter(p => p);
                            questionData.correct = parseInt(questionData.correct);
                            questionData.jawabanBenar = null; 
                            delete questionData.pilihan1;
                            delete questionData.pilihan2;
                            delete questionData.pilihan3;
                            delete questionData.pilihan4;
                        } else {
                            questionData.pilihan = []; 
                            questionData.correct = null;
                        }
                        delete questionData.gambarFile;

                        // Instant save to IndexedDB + background sync
                        await DataService.updateQuestion(questionData);

                        AppState.cache.clear(); 
                        UI.hideModal();
                        UI.showNotification('Soal berhasil diupdate!', 'success');
                        UI.loadAndRenderPaginatedQuestions(); // Refresh list
                    } catch (error) {
                        console.error("Error updating document: ", error);
                        UI.showNotification(error.message || 'Gagal mengupdate soal!', 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'Update';
                    }
                });
            },

            deleteQuestion(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus soal ini?', async () => {
                    console.log('[Delete] Deleting question with ID:', id);
                    
                    // OPTIMISTIC UI: Remove item from ALL cache entries containing this question
                    Object.keys(AppState.cache._data).forEach(key => {
                        if (key.startsWith('questions') && Array.isArray(AppState.cache._data[key])) {
                            const index = AppState.cache._data[key].findIndex(q => q.id === id);
                            if (index !== -1) {
                                AppState.cache._data[key].splice(index, 1);
                            }
                        }
                    });
                    
                    // Re-render from modified cache
                    UI.loadAndRenderPaginatedQuestions(false);
                    
                    // BACKGROUND: Delete from server (fire and forget)
                    callGoogleScript('POST', { 
                        action: 'deleteQuestion', 
                        data: { id: id } 
                    }).then(serverResult => {
                        if (serverResult.status === 'success') {
                            console.log('[Delete] Question deleted successfully:', id);
                        } else {
                            console.error('[Sync] Delete failed:', serverResult.message);
                            UI.loadAndRenderPaginatedQuestions(true);
                        }
                    }).catch(err => {
                        console.error('[Sync] Delete error:', err);
                        UI.showNotification('Gagal sync hapus ke server', 'warning');
                    });
                });
            },

            renderFilteredQuestions(questions, allQuestions = null, startIndex = 0) {
                AppState.currentlyDisplayed.questions = questions;
                const questionsList = document.getElementById('questionsList');
                if (!questionsList) return;

                // If displayNumber already exists (from renderQuestionsFromCache), use it directly
                // Otherwise calculate locally (fallback for direct calls)
                let questionsWithNumbers = questions;
                if (!questions[0]?.displayNumber) {
                    let currentSubject = null;
                    let subjectQuestionNumber = 0;
                    questionsWithNumbers = questions.map((question) => {
                        if (question.mataPelajaran !== currentSubject) {
                            currentSubject = question.mataPelajaran;
                            subjectQuestionNumber = 1;
                        } else {
                            subjectQuestionNumber++;
                        }
                        return { ...question, displayNumber: subjectQuestionNumber };
                    });
                }

                questionsList.innerHTML = questionsWithNumbers.length === 0 ?
                    '<div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">Tidak ada soal yang sesuai dengan filter</div>' :
                    questionsWithNumbers.map((question, index) => {
                        const canEdit = AppState.currentUser.role === 'admin' ||
                                      (question.createdBy && question.createdBy === AppState.currentUser.nama) ||
                                      (!question.createdBy && AppState.currentUser.role === 'guru');

                        // Show subject header when subject changes
                        // Check previous question in full list (allQuestions) for correct header on page boundaries
                        const globalIndex = startIndex + index;
                        const prevQuestion = globalIndex > 0 && allQuestions ? allQuestions[globalIndex - 1] : (index > 0 ? questionsWithNumbers[index - 1] : null);
                        const showSubjectHeader = !prevQuestion || prevQuestion.mataPelajaran !== question.mataPelajaran;
                        const subjectHeader = showSubjectHeader ? `
                            <div class="bg-gradient-to-r from-blue-600 to-teal-500 text-white rounded-lg shadow p-4 mb-4">
                                <h3 class="text-lg font-bold"><i class="fas fa-book mr-2"></i>${question.mataPelajaran}</h3>
                            </div>
                        ` : '';

                        return `
                        ${subjectHeader}
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-2 flex-wrap">
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">${question.kelas}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${question.mataPelajaran}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">${question.tipe}</span>
                                        <span class="text-xs text-gray-500">Kode: ${question.kode}</span>
                                        <span class="text-xs text-gray-400">Dibuat oleh: ${question.createdBy || '-'}</span>
                                    </div>
                                    <h4 class="font-medium text-gray-900 mb-2">Soal No. ${question.displayNumber}</h4>
                                    <p class="text-gray-700 mb-3">${(question.pertanyaan || '').length > 100 ? (question.pertanyaan || '').substring(0, 100) + '...' : (question.pertanyaan || '')}</p>
                                </div>
                                <div class="flex space-x-3 ml-4">
                                    <button onclick="Management.viewQuestion('${question.id}')" class="text-blue-600 hover:text-blue-900" title="Lihat Soal">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${canEdit ? `
                                    <button onclick="Management.editQuestion('${question.id}')" class="text-green-600 hover:text-green-900" title="Edit Soal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="Management.deleteQuestion('${question.id}')" class="text-red-600 hover:text-red-900" title="Hapus Soal">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `}).join('');
            },

            showAutoGenerateModal() {
                const lastData = AppState.lastQuestionData;
                let classOptions = '';
                 if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                } else {
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}" ${lastData.kelas === c.nama ? 'selected' : ''}>${c.nama}</option>`).join('');
                }

                const content = `
                    <form id="geminiGenerateForm" class="space-y-4">
                        <p class="text-sm text-gray-600 mb-4">Isi form di bawah ini untuk membuat soal secara otomatis menggunakan AI. Pastikan topik yang dimasukkan spesifik.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                <select name="tahunAjaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${UI.getYearOptions(lastData.tahunAjaran)}</select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester Ujian</label>
                                <select name="semester" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">${UI.getSemesterOptions(lastData.semester)}</select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select name="mataPelajaran" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Mata Pelajaran</option>
                                    ${AppState.subjects.map(s => `<option value="${s.nama}" ${lastData.mataPelajaran === s.nama ? 'selected' : ''}>${s.nama}</option>`).join('')}
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select name="kelas" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal (Dasar)</label>
                                <input type="text" name="kodeSoal" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: PAI-STS-1">
                            </div>
                        </div>

                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Topik / Materi Pembahasan</label>
                            <input type="text" name="topik" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Perang Diponegoro, Penjumlahan Pecahan">
                        </div>

                        <div class="p-4 border rounded-lg bg-gray-50">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Tentukan Jumlah Soal per Tipe (Total Maks. 100)</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Pilihan Ganda</label>
                                    <input type="number" name="jumlah_pg" min="0" max="100" value="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Isian Singkat</label>
                                    <input type="number" name="jumlah_isian" min="0" max="100" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Uraian / Esai</label>
                                    <input type="number" name="jumlah_uraian" min="0" max="100" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200 font-semibold"><i class="fas fa-magic mr-2"></i>Buat Soal</button>
                        </div>
                    </form>
                    <div id="geminiResultArea" class="mt-6"></div>
                `;
                UI.showGeminiModal('‚ú® Buat Soal Otomatis dengan AI', content);

                document.getElementById('geminiGenerateForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const submitButton = form.querySelector('button[type="submit"]');
                    const resultArea = document.getElementById('geminiResultArea');
                    
                    const formData = new FormData(form);
                    const promptData = Object.fromEntries(formData);

                    const jumlahPg = parseInt(promptData.jumlah_pg) || 0;
                    const jumlahIsian = parseInt(promptData.jumlah_isian) || 0;
                    const jumlahUraian = parseInt(promptData.jumlah_uraian) || 0;
                    const totalSoal = jumlahPg + jumlahIsian + jumlahUraian;

                    if (totalSoal <= 0) {
                        UI.showNotification('Masukkan jumlah soal yang ingin dibuat.', 'error');
                        return;
                    }
                    if (totalSoal > 100) {
                        UI.showNotification('Total jumlah soal tidak boleh melebihi 100.', 'error');
                        return;
                    }

                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sedang membuat soal...';
                    resultArea.innerHTML = '<div class="text-center p-8"><i class="fas fa-robot fa-spin text-3xl text-purple-600"></i><p class="mt-3 text-gray-600">AI sedang bekerja, mohon tunggu sebentar...</p></div>';

                    const generatedQuestions = await GeminiHelper.generateQuestions(promptData);

                    if (generatedQuestions && generatedQuestions.length > 0) {
                        this.renderGeneratedQuestions(generatedQuestions, promptData, resultArea);
                    } else {
                        resultArea.innerHTML = '<div class="text-center p-8 bg-red-50 rounded-lg"><i class="fas fa-exclamation-triangle text-3xl text-red-600"></i><p class="mt-3 text-red-700 font-semibold">Gagal membuat soal.</p><p class="text-sm text-red-600">Pastikan API Key sudah diatur di menu Pengaturan.</p></div>';
                    }
                    
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-magic mr-2"></i>Buat Soal';
                });
            },

            renderGeneratedQuestions(questions, metadata, container) {
                let html = '<h3 class="text-lg font-bold mb-4">Hasil Soal yang Dibuat:</h3>';
                html += questions.map((q, index) => {
                    let answerHtml = '';
                    if(q.pilihan && q.pilihan.length > 0) {
                        answerHtml = `<ul class="list-disc list-inside space-y-1 pl-4 mt-2">${q.pilihan.map((opt, i) => `<li class="${i === q.correct ? 'font-bold text-green-700' : ''}">${opt} ${i === q.correct ? '<span class="text-green-600 font-normal">(Jawaban Benar)</span>' : ''}</li>`).join('')}</ul>`;
                    } else if (q.jawabanBenar) {
                        answerHtml = `<div class="mt-2 p-2 bg-green-50 border border-green-200 rounded-md"><p class="text-sm text-green-800"><strong>Kunci Jawaban:</strong> ${q.jawabanBenar}</p></div>`;
                    }

                    return `<div class="p-4 border rounded-lg mb-3 bg-gray-50">
                                <p class="font-semibold">${index + 1}. ${q.pertanyaan}</p>
                                ${answerHtml}
                            </div>`;
                }).join('');

                html += `<div class="flex justify-end pt-4 mt-4 border-t">
                            <button id="saveGeneratedQuestionsBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold"><i class="fas fa-save mr-2"></i>Simpan Semua Soal</button>
                         </div>`;
                container.innerHTML = html;

                document.getElementById('saveGeneratedQuestionsBtn').addEventListener('click', async () => {
                    const button = document.getElementById('saveGeneratedQuestionsBtn');
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    const questionsToSave = questions.map((q, index) => ({
                        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}-${index}`,
                        tahunAjaran: metadata.tahunAjaran,
                        semester: metadata.semester,
                        mataPelajaran: metadata.mataPelajaran,
                        kelas: metadata.kelas,
                        kode: metadata.kodeSoal,
                        tipe: q.tipe,
                        pertanyaan: q.pertanyaan,
                        pilihan: q.pilihan || [],
                        correct: (q.correct !== undefined && q.correct !== null) ? q.correct : null,
                        jawabanBenar: q.jawabanBenar || null,
                        gambar: null,
                        createdBy: AppState.currentUser.nama,
                        createdAt: new Date().toISOString(),
                    }));

                    try {
                        // Instant batch save to IndexedDB + background sync
                        for (const q of questionsToSave) {
                            await DataService.addQuestion(q);
                        }
                        
                        AppState.cache.clear(); 
                        UI.hideGeminiModal();
                        UI.showNotification(`${questions.length} soal berhasil disimpan!`, 'success');
                        UI.loadAndRenderPaginatedQuestions(); // Refresh
                    } catch(error) {
                        console.error('Error saving generated questions:', error);
                        UI.showNotification('Gagal menyimpan soal!', 'error');
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Semua Soal';
                    }
                });
            },

            // =================================================================
            // Result Management (Google Sheets Integration)
            // =================================================================
            async viewResult(id) {
                 const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };
                const cacheKey = AppState.cache.generateKey('results', filters);
                const allFilteredResults = AppState.cache.get(cacheKey);
                if (!allFilteredResults) {
                     UI.showNotification('Data cache tidak ditemukan, silakan filter ulang.', 'error');
                     return;
                }
                const result = allFilteredResults.find(r => r.resultId === id);

                if (!result) {
                    UI.showNotification('Data hasil ujian tidak ditemukan di cache.', 'error');
                    return;
                }
                const content = `
                    <div class="space-y-3 text-sm">
                        <p><strong>Nama Siswa:</strong> ${result.namaLengkap}</p>
                        <p><strong>Kelas:</strong> ${result.kelas}</p>
                        <p><strong>Kode Soal:</strong> ${result.kodesoal}</p>
                        <hr>
                        <p><strong>No. Soal:</strong> ${result.noSoal}</p>
                        <p><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                        <p><strong>Jawaban Siswa:</strong> ${result.jawabanSiswa}</p>
                        <p><strong>Status:</strong> <span class="${result.status === 'benar' ? 'text-green-600' : result.status === 'salah' ? 'text-red-600' : 'text-yellow-600'} font-semibold">${String(result.status).toUpperCase()}</span></p>
                        <p><strong>Nilai Poin:</strong> ${result.nilai}</p>
                    </div>
                    <div class="flex justify-end pt-4 mt-4 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Hasil Jawaban', content);
            },
            
            async editResult(id) {
                const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };
                const cacheKey = AppState.cache.generateKey('results', filters);
                const allFilteredResults = AppState.cache.get(cacheKey);
                 if (!allFilteredResults) {
                     UI.showNotification('Data cache tidak ditemukan, silakan filter ulang.', 'error');
                     return;
                }
                const result = allFilteredResults.find(r => r.resultId === id);

                if (!result) {
                     UI.showNotification('Data hasil ujian tidak ditemukan di cache.', 'error');
                    return;
                }

                const content = `
                    <form id="editResultForm" class="space-y-4">
                        <input type="hidden" name="id" value="${result.resultId}">
                        <p class="text-sm"><strong>Siswa:</strong> ${result.namaLengkap}</p>
                        <p class="text-sm"><strong>Soal No:</strong> ${result.noSoal}</p>
                        <p class="text-sm"><strong>Pertanyaan:</strong> ${result.pertanyaan}</p>
                        <p class="text-sm"><strong>Jawaban:</strong> ${result.jawabanSiswa}</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai (0-100)</label>
                            <input type="number" name="nilai" value="${result.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Soal', content);

                document.getElementById('editResultForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const resultId = form.id.value;
                    const newNilai = parseInt(form.nilai.value);
                    const newStatus = newNilai > 0 ? 'benar' : 'salah';
                    const oldNilai = result.nilai || 0;
                    const studentName = result.namaLengkap;
                    const examCode = result.kodesoal;
                    
                    // OPTIMISTIC UI: Close modal immediately
                    UI.hideModal();
                    
                    // === STEP 1: Update UI Hasil Ujian LANGSUNG via DOM ===
                    const resultRow = document.querySelector(`tr[data-result-id="${resultId}"]`);
                    if (resultRow) {
                        const nilaiCell = resultRow.querySelector('.result-nilai');
                        const statusCell = resultRow.querySelector('.result-status');
                        if (nilaiCell) nilaiCell.textContent = newNilai;
                        if (statusCell) {
                            statusCell.textContent = newStatus;
                            statusCell.className = `result-status px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${newStatus === 'benar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        }
                    }
                    
                    // === STEP 2: Hitung ulang grade dan SIMPAN PENDING UPDATE ===
                    // studentName dan examCode sudah dideklarasikan di atas
                    
                    // Ambil semua results dari tabel yang sedang ditampilkan
                    const allResultRows = document.querySelectorAll('#resultsTableBody tr[data-result-id]');
                    let totalScore = 0;
                    let countResults = 0;
                    
                    allResultRows.forEach(row => {
                        const rowStudent = row.getAttribute('data-student');
                        const rowExam = row.getAttribute('data-exam');
                        if (rowStudent === studentName && rowExam === examCode) {
                            const nilaiCell = row.querySelector('.result-nilai');
                            const statusCell = row.querySelector('.result-status');
                            const nilai = parseInt(nilaiCell?.textContent) || 0;
                            const status = statusCell?.textContent?.trim();
                            
                            if (status !== 'perlu dinilai') {
                                totalScore += nilai;
                            }
                            countResults++;
                        }
                    });
                    
                    // Jika tidak ada di DOM, gunakan cache
                    if (countResults === 0) {
                        const cachedResultsLocal = AppState.cache.get(cacheKey) || [];
                        cachedResultsLocal.forEach(r => {
                            if (r.namaLengkap === studentName && r.kodesoal === examCode) {
                                // Update nilai jika ini adalah result yang diedit
                                const nilai = (r.resultId === resultId) ? newNilai : (Number(r.nilai) || 0);
                                const status = (r.resultId === resultId) ? newStatus : r.status;
                                if (status !== 'perlu dinilai') {
                                    totalScore += nilai;
                                }
                                countResults++;
                            }
                        });
                    }
                    
                    // Get total questions
                    const cachedQuestions = CacheHelper.getCached('questions') || [];
                    const examQuestions = cachedQuestions.filter(q => q.kodesoal === examCode);
                    const totalQuestions = examQuestions.length || countResults || 1;
                    
                    // Calculate final grade
                    const finalScore = Math.round(totalScore / totalQuestions);
                    const gradeValue = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                    const keterangan = finalScore >= 70 ? 'Lulus' : 'Tidak Lulus';
                    
                    // === SIMPAN PENDING GRADE UPDATE ===
                    // Ini akan diterapkan ketika user membuka halaman Daftar Nilai
                    const pendingKey = `${studentName}|${examCode}`;
                    AppState.pendingGradeUpdates[pendingKey] = {
                        nilai: finalScore,
                        grade: gradeValue,
                        keterangan: keterangan
                    };
                    console.log(`[PENDING UPDATE] Saved for ${studentName}: ${finalScore} (${gradeValue})`);
                    
                    // UPDATE DOM Daftar Nilai LANGSUNG jika ada di DOM
                    const gradeRow = document.querySelector(`tr[data-student="${studentName}"][data-exam="${examCode}"]`);
                    if (gradeRow) {
                        const nilaiCell = gradeRow.querySelector('.grade-nilai');
                        const gradeCell = gradeRow.querySelector('.grade-grade');
                        const ketCell = gradeRow.querySelector('.grade-keterangan');
                        
                        if (nilaiCell) nilaiCell.textContent = finalScore;
                        if (gradeCell) {
                            const gradeClass = gradeValue === 'A' ? 'bg-green-100 text-green-800' : 
                                              gradeValue === 'B' ? 'bg-blue-100 text-blue-800' : 
                                              gradeValue === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                            gradeCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${gradeClass}">${gradeValue}</span>`;
                        }
                        if (ketCell) ketCell.textContent = keterangan;
                        
                        console.log(`[DOM UPDATE] Grade di tabel: ${studentName} = ${finalScore} (${gradeValue})`);
                    }
                    
                    // === STEP 3: Update Cache untuk konsistensi ===
                    try {
                        // Update results cache
                        const globalResults = CacheHelper.getCached('results') || [];
                        const globalIdx = globalResults.findIndex(r => r.resultId === resultId);
                        if (globalIdx !== -1) {
                            globalResults[globalIdx].nilai = newNilai;
                            globalResults[globalIdx].status = newStatus;
                            AppState.cache.set('results', { data: globalResults, timestamp: Date.now(), valid: true });
                        }
                        
                        // Update filtered results cache
                        const cachedResultsFiltered = AppState.cache.get(cacheKey);
                        if (cachedResultsFiltered) {
                            const idx = cachedResultsFiltered.findIndex(r => r.resultId === resultId);
                            if (idx !== -1) {
                                cachedResultsFiltered[idx].nilai = newNilai;
                                cachedResultsFiltered[idx].status = newStatus;
                            }
                        }
                        
                        // Update grades cache
                        const globalGrades = CacheHelper.getCached('grades') || [];
                        const gradeIdx = globalGrades.findIndex(g => g.namaSiswa === studentName && g.kodeSoal === examCode);
                        if (gradeIdx !== -1) {
                            globalGrades[gradeIdx].nilai = finalScore;
                            globalGrades[gradeIdx].grade = gradeValue;
                            globalGrades[gradeIdx].keterangan = keterangan;
                            AppState.cache.set('grades', { data: globalGrades, timestamp: Date.now(), valid: true });
                            
                            // Queue for background sync
                            BackgroundSync.queueOperation('update', 'grades', {
                                ...globalGrades[gradeIdx],
                                gradeId: globalGrades[gradeIdx].gradeId,
                                namaSiswa: studentName,
                                kodeSoal: examCode
                            });
                        }
                    } catch (cacheError) {
                        console.warn('[Cache Update] Warning:', cacheError);
                    }
                    
                    // === STEP 4: BACKGROUND Sync result to server ===
                    callGoogleScript('POST', {
                        action: 'updateResult',
                        data: { resultId: resultId, nilai: newNilai, status: newStatus }
                    }).then(response => {
                        if (response.status === 'success') {
                            console.log('[Server Sync] Result updated on server');
                        } else {
                            console.error('[Server Sync] Failed:', response.message);
                            UI.showNotification('Gagal sync ke server', 'warning');
                        }
                    }).catch(err => {
                        console.error('[Server Sync] Error:', err);
                    });
                });
            },
            
            deleteResult(id) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus detail hasil ini?', async () => {
                    console.log('[Delete] Deleting result with ID:', id);
                    
                    // OPTIMISTIC UI: Remove item from ALL cache entries containing this result
                    Object.keys(AppState.cache._data).forEach(key => {
                        if (key.startsWith('results') && Array.isArray(AppState.cache._data[key])) {
                            const index = AppState.cache._data[key].findIndex(r => r.resultId === id);
                            if (index !== -1) {
                                AppState.cache._data[key].splice(index, 1);
                            }
                        }
                    });
                    
                    // Re-render from modified cache
                    UI.loadAndRenderPaginatedResults(false);
                    
                    // BACKGROUND: Delete from server (fire and forget)
                    callGoogleScript('POST', { 
                        action: 'deleteResult', 
                        data: { resultId: id } 
                    }).then(serverResult => {
                        if (serverResult.status !== 'success') {
                            console.error('[Sync] Delete failed:', serverResult.message);
                            UI.loadAndRenderPaginatedResults(true);
                        }
                    }).catch(err => {
                        console.error('[Sync] Delete error:', err);
                    });
                });
            },

            renderFilteredResults(results) {
                AppState.currentlyDisplayed.results = results; // Store for bulk delete/actions
                const resultsTableBody = document.getElementById('resultsTableBody');
                if (!resultsTableBody) return;
                
                resultsTableBody.innerHTML = results.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Tidak ada hasil ujian yang sesuai dengan filter</td></tr>' :
                    results.map((result, index) => {
                        // The unique ID for a result is now `resultId` from Google Sheet
                        const resultId = result.resultId; 
                        let actionButtons = '';
                        if (String(result.status) === 'perlu dinilai') {
                            actionButtons = `
                                <button id="grade-btn-${resultId}" onclick="Management.gradeWithAI('${resultId}')" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 text-xs">
                                    <i class="fas fa-magic mr-1"></i> Nilai AI
                                </button>
                                 <button onclick="Management.editResult('${resultId}')" class="text-green-600 hover:text-green-900 ml-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                            `;
                        } else {
                            actionButtons = `
                                <button onclick="Management.viewResult('${resultId}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editResult('${resultId}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteResult('${resultId}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                        }
                        return `
                        <tr data-result-id="${resultId}" data-student="${result.namaLengkap}" data-exam="${result.kodesoal}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1 + (AppState.pagination.results.currentPage - 1) * AppState.itemsPerPage}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kodesoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.namaLengkap}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.noSoal}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.pertanyaan}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.jawabanSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="result-status px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.status === 'benar' ? 'bg-green-100 text-green-800' : result.status === 'salah' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${result.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 result-nilai">${result.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${actionButtons}
                            </td>
                        </tr>
                    `}).join('');
            },
            
            async gradeAllWithAI() {
                const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };
                const cacheKey = AppState.cache.generateKey('results', filters);
                const allFilteredResults = AppState.cache.get(cacheKey);

                if (!allFilteredResults) {
                    UI.showNotification('Tidak ada data yang dimuat. Silakan filter terlebih dahulu.', 'info');
                    return;
                }
                
                const resultsToGrade = allFilteredResults.filter(r => String(r.status) === 'perlu dinilai');

                if (resultsToGrade.length === 0) {
                    UI.showNotification('Tidak ada jawaban yang perlu dinilai pada filter ini.', 'info');
                    return;
                }

                UI.showConfirmModal(
                    'Konfirmasi Penilaian Otomatis',
                    `Anda akan menilai <strong>${resultsToGrade.length}</strong> jawaban secara otomatis menggunakan sistem similarity. Proses ini akan mengirim data ke Google Sheet. Lanjutkan?`,
                    async () => {
                        Swal.fire({
                            title: 'Menilai Otomatis...',
                            html: `Memproses <strong>0</strong> dari <strong>${resultsToGrade.length}</strong> jawaban.`,
                            allowOutsideClick: false,
                            didOpen: () => { Swal.showLoading(); }
                        });

                        const questionCache = {};
                        const updates = [];
                        let processedCount = 0;
                        const affectedGrades = new Set(); // To store unique keys for recalculation

                        for (const result of resultsToGrade) {
                            try {
                                if (!questionCache[result.kodesoal]) {
                                    const questionResult = await callGoogleScript('GET', { action: 'getQuestions', kode: result.kodesoal });
                                    if (questionResult.status !== 'success' || questionResult.data.length === 0) continue;

                                    let questions = questionResult.data;
                                    // Sort by: 1. Mata Pelajaran, 2. Tipe (PG ‚Üí Isian/Essai ‚Üí Uraian), 3. Creation time
                                    const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                                    questions.sort((a, b) => {
                                        // 1. Sort by mataPelajaran first
                                        const mataPelajaranCompare = (a.mataPelajaran || '').localeCompare(b.mataPelajaran || '', 'id-ID');
                                        if (mataPelajaranCompare !== 0) return mataPelajaranCompare;

                                        // 2. Sort by tipe (pilihan_ganda ‚Üí isian ‚Üí uraian)
                                        const typeA = typeOrder[a.tipe] || 99;
                                        const typeB = typeOrder[b.tipe] || 99;
                                        if (typeA !== typeB) return typeA - typeB;

                                        // 3. Sort by creation time
                                        const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                                        const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                                        return timeA - timeB;
                                    });
                                    questionCache[result.kodesoal] = questions;
                                }

                                const questions = questionCache[result.kodesoal];
                                const question = questions[result.noSoal - 1];
                                if (!question || !question.jawabanBenar) continue;

                                // Gunakan TextSimilarity sebagai pengganti AI
                                // Untuk SD (Kelas 4-6), gunakan sistem penilaian SD yang lebih longgar
                                const isSDClass = ['4A', '4B', '4C', '4D', '5A', '5B', '6A', '6B'].includes(result.kelas);
                                const gradingResult = isSDClass
                                    ? SDGrading.gradeAnswerForSD(result.jawabanSiswa, question.jawabanBenar)
                                    : TextSimilarity.gradeAnswer(result.jawabanSiswa, question.jawabanBenar);

                                if (gradingResult) {
                                    const newNilai = gradingResult.nilai;
                                    const newStatus = newNilai > 0 ? 'benar' : 'salah';
                                    updates.push({ resultId: result.resultId, nilai: newNilai, status: newStatus });
                                    affectedGrades.add(`${result.namaLengkap}__${result.kodesoal}`);
                                }
                            } catch (error) {
                                console.error(`Failed to grade result ID ${result.resultId}:`, error);
                            }

                            processedCount++;
                            Swal.update({ html: `Memproses <strong>${processedCount}</strong> dari <strong>${resultsToGrade.length}</strong> jawaban.` });
                        }

                        // Batch update results - Instant save to IndexedDB + background sync
                        if (updates.length > 0) {
                            for (const update of updates) {
                                await DataService.updateResult(update);
                            }
                        }
                        AppState.cache.clear(); // Clear cache to reflect changes

                        // Recalculate final grades for affected students
                        Swal.update({ html: 'Menghitung ulang nilai akhir...' });
                        
                        for (const gradeKey of affectedGrades) {
                            const [namaLengkap, kodesoal] = gradeKey.split('__');
                            await this.recalculateFinalGrade(namaLengkap, kodesoal);
                        }

                        Swal.close();
                        UI.showNotification(`${updates.length} jawaban berhasil dinilai dan dikirim ke Google Sheet.`, 'success');
                        document.getElementById('applyResultFilterBtn').click(); // Refresh the view
                    }
                );
            },

            async gradeWithAI(id) {
                const button = document.getElementById(`grade-btn-${id}`);
                if (!button) return;

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menilai...';

                try {
                    const filters = {
                        action: 'getResults',
                        tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                        semester: document.getElementById('filterResultSemester').value,
                        kodesoal: document.getElementById('filterResultCode').value,
                        mataPelajaran: document.getElementById('filterResultSubject').value,
                        kelas: document.getElementById('filterResultClass').value,
                        namaLengkap: document.getElementById('filterResultStudent').value,
                    };
                    const cacheKey = AppState.cache.generateKey('results', filters);
                    const allFilteredResults = AppState.cache.get(cacheKey);

                    if (!allFilteredResults) {
                        throw new Error("Data cache tidak ditemukan. Silakan filter ulang.");
                    }
                    
                    const resultData = allFilteredResults.find(r => r.resultId === id);
                    if (!resultData) throw new Error("Data hasil ujian tidak ditemukan.");

                    const questionResult = await callGoogleScript('GET', { action: 'getQuestions', kode: resultData.kodesoal });
                    if (questionResult.status !== 'success' || questionResult.data.length === 0) {
                        throw new Error("Data soal tidak ditemukan.");
                    }
                    
                    let questions = questionResult.data;
                    // Sort by: 1. Mata Pelajaran, 2. Tipe (PG ‚Üí Isian/Essai ‚Üí Uraian), 3. Creation time
                    const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                    questions.sort((a, b) => {
                        // 1. Sort by mataPelajaran first
                        const mataPelajaranCompare = (a.mataPelajaran || '').localeCompare(b.mataPelajaran || '', 'id-ID');
                        if (mataPelajaranCompare !== 0) return mataPelajaranCompare;

                        // 2. Sort by tipe (pilihan_ganda ‚Üí isian ‚Üí uraian)
                        const typeA = typeOrder[a.tipe] || 99;
                        const typeB = typeOrder[b.tipe] || 99;
                        if (typeA !== typeB) return typeA - typeB;

                        // 3. Sort by creation time
                        const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        return timeA - timeB;
                    });

                    const question = questions[resultData.noSoal - 1];
                    if (!question || !question.jawabanBenar) throw new Error(`Kunci jawaban untuk soal no. ${resultData.noSoal} tidak ditemukan.`);
                    
                    // Gunakan TextSimilarity sebagai pengganti AI
                    // Untuk SD (Kelas 4-6), gunakan sistem penilaian SD yang lebih longgar
                    const isSDClass = ['4A', '4B', '4C', '4D', '5A', '5B', '6A', '6B'].includes(resultData.kelas);
                    const gradingResult = isSDClass
                        ? SDGrading.gradeAnswerForSD(resultData.jawabanSiswa, question.jawabanBenar)
                        : TextSimilarity.gradeAnswer(resultData.jawabanSiswa, question.jawabanBenar);
                    if (!gradingResult) throw new Error("Gagal mendapatkan nilai.");
                    
                    const newNilai = gradingResult.nilai;
                    const newStatus = newNilai > 0 ? 'benar' : 'salah';

                    // Instant save to IndexedDB + background sync
                    await DataService.updateResult({
                        resultId: id,
                        nilai: newNilai,
                        status: newStatus
                    });
                    AppState.cache.clear(); // Clear cache
                    
                    await this.recalculateFinalGrade(resultData.namaLengkap, resultData.kodesoal);
                    
                    UI.showNotification(`Penilaian berhasil! Nilai: ${newNilai}. Similarity: ${gradingResult.similarity}%. ${gradingResult.feedback}`, 'success');
                    
                } catch (error) {
                    console.error("Error during grading: ", error);
                    UI.showNotification(error.message, 'error');
                } finally {
                    document.getElementById('applyResultFilterBtn').click();
                }
            },

            async recalculateFinalGrade(studentName, examCode) {
                try {
                    // OPTIMISTIC: Gunakan cache lokal dulu untuk instant response
                    let studentResults = [];
                    const cachedResults = CacheHelper.getCached('results') || [];
                    studentResults = cachedResults.filter(r => 
                        r.namaLengkap === studentName && r.kodesoal === examCode
                    );
                    
                    // Fallback ke IndexedDB jika cache kosong
                    if (studentResults.length === 0) {
                        const idbResults = await IndexedDBService.getAll('results');
                        studentResults = idbResults.filter(r => 
                            r.namaLengkap === studentName && r.kodesoal === examCode
                        );
                    }
            
                    if (!studentResults || studentResults.length === 0) {
                        console.warn('No results found for recalculation.');
                        return;
                    }

                    // OPTIMISTIC: Gunakan questions dari cache
                    let questions = [];
                    const cachedQuestions = CacheHelper.getCached('questions') || [];
                    questions = cachedQuestions.filter(q => q.kodesoal === examCode);
                    
                    if (questions.length === 0) {
                        const idbQuestions = await IndexedDBService.getAll('questions');
                        questions = idbQuestions.filter(q => q.kodesoal === examCode);
                    }
                    
                    if (!questions || questions.length === 0) return;
                    const totalQuestionsForExam = questions.length;

                    let totalScore = 0;
                    studentResults.forEach(r => {
                        if (r.status !== 'perlu dinilai') {
                            totalScore += Number(r.nilai) || 0;
                        }
                    });
                    
                    const finalScore = Math.round(totalScore / totalQuestionsForExam);
                    const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                    
                    // OPTIMISTIC: Cari grade dari cache lokal
                    let existingGrade = null;
                    const cachedGrades = CacheHelper.getCached('grades') || [];
                    existingGrade = cachedGrades.find(g => 
                        g.namaSiswa === studentName && g.kodeSoal === examCode
                    );
                    
                    // Fallback ke IndexedDB
                    if (!existingGrade) {
                        const idbGrades = await IndexedDBService.getAll('grades');
                        existingGrade = idbGrades.find(g => 
                            g.namaSiswa === studentName && g.kodeSoal === examCode
                        );
                    }

                    if (existingGrade) {
                        await DataService.updateGrade({
                            ...existingGrade,
                            gradeId: existingGrade.gradeId,
                            id: existingGrade.id || existingGrade.gradeId,
                            namaSiswa: studentName,
                            kodeSoal: examCode,
                            nilai: finalScore,
                            grade: grade,
                            keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus'
                        });
                        console.log(`[OPTIMISTIC] Final grade updated for ${studentName} on exam ${examCode}. New score: ${finalScore}`);
                    }
                } catch (error) {
                    console.error(`Failed to recalculate final grade for ${studentName}:`, error);
                }
            },

            // Synchronous version that updates server directly (for edit operations)
            async recalculateFinalGradeSync(studentName, examCode) {
                try {
                    // OPTIMISTIC: Gunakan cache lokal dulu untuk instant response
                    let studentResults = [];
                    const cachedResults = CacheHelper.getCached('results') || [];
                    studentResults = cachedResults.filter(r => 
                        r.namaLengkap === studentName && r.kodesoal === examCode
                    );
                    
                    // Fallback ke IndexedDB jika cache kosong
                    if (studentResults.length === 0) {
                        const idbResults = await IndexedDBService.getAll('results');
                        studentResults = idbResults.filter(r => 
                            r.namaLengkap === studentName && r.kodesoal === examCode
                        );
                    }
            
                    if (!studentResults || studentResults.length === 0) {
                        console.warn('No results found for recalculation.');
                        return;
                    }

                    // OPTIMISTIC: Gunakan questions dari cache
                    let questions = [];
                    const cachedQuestions = CacheHelper.getCached('questions') || [];
                    questions = cachedQuestions.filter(q => q.kodesoal === examCode);
                    
                    if (questions.length === 0) {
                        const idbQuestions = await IndexedDBService.getAll('questions');
                        questions = idbQuestions.filter(q => q.kodesoal === examCode);
                    }
                    
                    if (!questions || questions.length === 0) return;
                    const totalQuestionsForExam = questions.length;

                    let totalScore = 0;
                    studentResults.forEach(r => {
                        if (r.status !== 'perlu dinilai') {
                            totalScore += Number(r.nilai) || 0;
                        }
                    });
                    
                    const finalScore = Math.round(totalScore / totalQuestionsForExam);
                    const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                    
                    // OPTIMISTIC: Cari grade dari cache lokal
                    let existingGrade = null;
                    const cachedGrades = CacheHelper.getCached('grades') || [];
                    existingGrade = cachedGrades.find(g => 
                        g.namaSiswa === studentName && g.kodeSoal === examCode
                    );
                    
                    // Fallback ke IndexedDB
                    if (!existingGrade) {
                        const idbGrades = await IndexedDBService.getAll('grades');
                        existingGrade = idbGrades.find(g => 
                            g.namaSiswa === studentName && g.kodeSoal === examCode
                        );
                    }

                    if (existingGrade) {
                        // Update dengan DataService (sudah optimistic)
                        await DataService.updateGrade({
                            ...existingGrade,
                            gradeId: existingGrade.gradeId,
                            id: existingGrade.id || existingGrade.gradeId,
                            namaSiswa: studentName,
                            kodeSoal: examCode,
                            nilai: finalScore,
                            grade: grade,
                            keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus'
                        });
                        
                        console.log(`[OPTIMISTIC] Final grade synced for ${studentName} on exam ${examCode}. New score: ${finalScore}`);
                    }
                } catch (error) {
                    console.error(`Failed to recalculate and sync final grade for ${studentName}:`, error);
                }
            },

            // Async version for background processing (non-blocking) - FULLY OPTIMISTIC
            async recalculateFinalGradeAsync(studentName, examCode, newNilai) {
                try {
                    // OPTIMISTIC: Gunakan cache lokal dulu untuk instant response
                    let studentResults = [];
                    const cachedResults = CacheHelper.getCached('results') || [];
                    studentResults = cachedResults.filter(r => 
                        r.namaLengkap === studentName && r.kodesoal === examCode
                    );
                    
                    // Fallback ke IndexedDB jika cache kosong
                    if (studentResults.length === 0) {
                        const idbResults = await IndexedDBService.getAll('results');
                        studentResults = idbResults.filter(r => 
                            r.namaLengkap === studentName && r.kodesoal === examCode
                        );
                    }
            
                    if (!studentResults || studentResults.length === 0) return;

                    // OPTIMISTIC: Gunakan questions dari cache
                    let questions = [];
                    const cachedQuestions = CacheHelper.getCached('questions') || [];
                    questions = cachedQuestions.filter(q => q.kodesoal === examCode);
                    
                    if (questions.length === 0) {
                        const idbQuestions = await IndexedDBService.getAll('questions');
                        questions = idbQuestions.filter(q => q.kodesoal === examCode);
                    }
                    
                    if (!questions || questions.length === 0) return;
                    const totalQuestionsForExam = questions.length;

                    let totalScore = 0;
                    studentResults.forEach(r => {
                        if (r.status !== 'perlu dinilai') {
                            totalScore += Number(r.nilai) || 0;
                        }
                    });
                    
                    const finalScore = Math.round(totalScore / totalQuestionsForExam);
                    const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                    
                    // OPTIMISTIC: Cari grade dari cache lokal
                    let existingGrade = null;
                    const cachedGrades = CacheHelper.getCached('grades') || [];
                    existingGrade = cachedGrades.find(g => 
                        g.namaSiswa === studentName && g.kodeSoal === examCode
                    );
                    
                    // Fallback ke IndexedDB (bukan server)
                    if (!existingGrade) {
                        const idbGrades = await IndexedDBService.getAll('grades');
                        existingGrade = idbGrades.find(g => 
                            g.namaSiswa === studentName && g.kodeSoal === examCode
                        );
                    }

                    if (existingGrade) {
                        // Update grade dengan data lengkap - PASTIKAN namaSiswa dan kodeSoal dikirim
                        await DataService.updateGrade({
                            ...existingGrade,  // Include semua field existing
                            gradeId: existingGrade.gradeId,
                            id: existingGrade.id || existingGrade.gradeId,
                            namaSiswa: studentName,
                            kodeSoal: examCode,
                            nilai: finalScore,
                            grade: grade,
                            keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus'
                        });
                        
                        console.log(`[OPTIMISTIC] Updated ${studentName}: ${finalScore} (${grade})`);
                        
                        // PENTING: Force refresh UI Daftar Nilai
                        if (typeof UI !== 'undefined' && typeof UI.refreshGradesUIIfVisible === 'function') {
                            UI.refreshGradesUIIfVisible();
                        }
                    } else {
                        console.warn(`[OPTIMISTIC] No existing grade found for ${studentName} on ${examCode}`);
                    }
                } catch (error) {
                    console.error(`Failed to recalculate grade async for ${studentName}:`, error);
                }
            },

            // =================================================================
            // Grade Management (Direct Google Sheets)
            // =================================================================
            async viewGrade(gradeId) {
                const grades = await DataService.getGrades();
                const grade = grades.find(g => g.gradeId === gradeId);
                
                if (!grade) {
                    UI.showNotification('Data nilai tidak ditemukan.', 'error');
                    return;
                }
                
                const content = `
                    <div class="space-y-3 text-sm">
                        <p><strong>Nama Siswa:</strong> ${grade.namaSiswa}</p>
                        <p><strong>Kelas:</strong> ${grade.kelas}</p>
                        <p><strong>Kode Soal:</strong> ${grade.kodeSoal}</p>
                        <p><strong>Mata Pelajaran:</strong> ${grade.mataPelajaran}</p>
                        <hr>
                        <p><strong>Nilai Akhir:</strong> <span class="text-2xl font-bold text-blue-600">${grade.nilai}</span></p>
                        <p><strong>Grade:</strong> <span class="font-semibold">${grade.grade}</span></p>
                        <p><strong>Keterangan:</strong> <span class="font-semibold">${grade.keterangan}</span></p>
                        <p><strong>Waktu Selesai:</strong> ${grade.waktuSelesai}</p>
                    </div>
                    <div class="flex justify-end pt-4 mt-4 border-t">
                        <button onclick="UI.hideModal()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Tutup</button>
                    </div>
                `;
                UI.showModal('Detail Nilai Siswa', content);
            },

            async editGrade(gradeId) {
                const grades = await DataService.getGrades();
                const grade = grades.find(g => g.gradeId === gradeId);
                
                if (!grade) {
                    UI.showNotification('Data nilai tidak ditemukan.', 'error');
                    return;
                }

                const content = `
                    <form id="editGradeForm" class="space-y-4">
                        <p class="text-sm">Mengedit nilai akhir untuk <strong>${grade.namaSiswa}</strong> pada ujian <strong>${grade.kodeSoal}</strong>.</p>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nilai Akhir (0-100)</label>
                            <input type="number" name="nilai" value="${grade.nilai}" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" onclick="UI.hideModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                UI.showModal('Edit Nilai Akhir', content);

                document.getElementById('editGradeForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newNilai = parseInt(e.target.nilai.value);
                    const newGrade = newNilai >= 90 ? 'A' : newNilai >= 80 ? 'B' : newNilai >= 70 ? 'C' : newNilai >= 60 ? 'D' : 'E';
                    const newKeterangan = newNilai >= 70 ? 'Lulus' : 'Tidak Lulus';

                    // 1. OPTIMISTIC UI: Update cache langsung
                    const updatedGradeData = {
                        ...grade,
                        gradeId: gradeId,
                        id: grade.id || gradeId,
                        nilai: newNilai,
                        grade: newGrade,
                        keterangan: newKeterangan
                    };
                    
                    // 2. Gunakan DataService yang sudah pakai queue pattern
                    await DataService.updateGrade(updatedGradeData);
                    
                    // 3. Close modal
                    UI.hideModal();
                    
                    // 4. Refresh UI langsung dari cache (yang sudah diupdate oleh DataService)
                    UI.loadAndRenderPaginatedGrades(false);
                    
                    UI.showNotification('Nilai berhasil diupdate!', 'success');
                });
            },

            deleteGrade(gradeId) {
                UI.showConfirmModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus data nilai ini?', async () => {
                    console.log('[Delete] Deleting grade with ID:', gradeId);
                    
                    // OPTIMISTIC UI: Remove item from ALL cache entries containing this grade
                    Object.keys(AppState.cache._data).forEach(key => {
                        if (key.startsWith('grades') && Array.isArray(AppState.cache._data[key])) {
                            const index = AppState.cache._data[key].findIndex(g => g.gradeId === gradeId);
                            if (index !== -1) {
                                AppState.cache._data[key].splice(index, 1);
                            }
                        }
                    });
                    
                    // Re-render from modified cache
                    UI.loadAndRenderPaginatedGrades(false);
                    
                    // BACKGROUND: Delete from server (fire and forget)
                    callGoogleScript('POST', { 
                        action: 'deleteGrade', 
                        data: { gradeId: gradeId } 
                    }).then(serverResult => {
                        if (serverResult.status !== 'success') {
                            console.error('[Sync] Delete failed:', serverResult.message);
                            UI.loadAndRenderPaginatedGrades(true);
                        }
                    }).catch(err => {
                        console.error('[Sync] Delete error:', err);
                    });
                });
            },

            renderFilteredGrades(grades) {
                AppState.currentlyDisplayed.grades = grades; // Store for bulk delete
                const gradesTableBody = document.getElementById('gradesTableBody');
                if (!gradesTableBody) return;

                gradesTableBody.innerHTML = grades.length === 0 ?
                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai yang sesuai dengan filter</td></tr>' :
                    grades.map((grade, index) => `
                        <tr data-grade-id="${grade.gradeId}" data-student="${grade.namaSiswa}" data-exam="${grade.kodeSoal}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1 + (AppState.pagination.grades.currentPage - 1) * AppState.itemsPerPage}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.namaSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kodeSoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.mataPelajaran}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 grade-nilai">${grade.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap grade-grade">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${grade.grade === 'A' ? 'bg-green-100 text-green-800' : grade.grade === 'B' ? 'bg-blue-100 text-blue-800' : grade.grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${grade.grade}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 grade-keterangan">${grade.keterangan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.waktuSelesai}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="Management.viewGrade('${grade.gradeId}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Management.editGrade('${grade.gradeId}')" class="text-green-600 hover:text-green-900 mr-3">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Management.deleteGrade('${grade.gradeId}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
            },
            
            async downloadQuestionsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const filters = {
                    tahunAjaran: document.getElementById('filterTahunAjaran').value,
                    semester: document.getElementById('filterSemester').value,
                    kelas: document.getElementById('filterKelas').value,
                    mataPelajaran: document.getElementById('filterSubject').value,
                    kode: document.getElementById('filterCode').value
                };
                const cacheKey = AppState.cache.generateKey('questions', filters);
                const allFilteredQuestions = AppState.cache.get(cacheKey);

                if (!allFilteredQuestions || allFilteredQuestions.length === 0) {
                    UI.showNotification('Tidak ada data soal untuk diunduh.', 'info');
                    return;
                }

                doc.text("Laporan Daftar Soal", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kode Soal", "Kelas", "Mata Pelajaran", "Tipe", "Pertanyaan"];
                const tableRows = [];

                allFilteredQuestions.forEach((question, index) => {
                    let questionText = question.pertanyaan;
                    if (question.tipe === 'pilihan_ganda' && question.pilihan) {
                        const options = question.pilihan.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n');
                        questionText += '\n' + options;
                    }

                    const questionData = [
                        index + 1,
                        question.kode,
                        question.kelas,
                        question.mataPelajaran,
                        question.tipe,
                        doc.splitTextToSize(questionText, 100)
                    ];
                    tableRows.push(questionData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 28,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [59, 130, 246] }
                });

                doc.save(`daftar-soal-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadResultsPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };
                const cacheKey = AppState.cache.generateKey('results', filters);
                const allFilteredResults = AppState.cache.get(cacheKey);

                if (!allFilteredResults || allFilteredResults.length === 0) {
                    UI.showNotification('Tidak ada data hasil untuk diunduh.', 'info');
                    return;
                }

                doc.text("Laporan Hasil Ujian", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Kode Soal", "Nama Siswa", "No. Soal", "Status", "Nilai"];
                const tableRows = [];

                allFilteredResults.forEach((result, index) => {
                    tableRows.push([
                        index + 1, result.kelas, result.kodesoal, result.namaLengkap,
                        result.noSoal, result.status, result.nilai
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`hasil-ujian-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            async downloadGradesPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const filters = {
                    tahunAjaran: document.getElementById('filterGradeTahunAjaran').value,
                    semester: document.getElementById('filterGradeSemester').value,
                    kodeSoal: document.getElementById('filterGradeCode').value,
                    mataPelajaran: document.getElementById('filterGradeSubject').value,
                    kelas: document.getElementById('filterGradeClass').value,
                    namaSiswa: document.getElementById('filterGradeStudent').value
                };
                const cacheKey = AppState.cache.generateKey('grades', filters);
                const allFilteredGrades = AppState.cache.get(cacheKey);

                if (!allFilteredGrades || allFilteredGrades.length === 0) {
                    UI.showNotification('Tidak ada data nilai untuk diunduh.', 'info');
                    return;
                }

                doc.text("Laporan Daftar Nilai", 14, 16);
                doc.setFontSize(10);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 14, 22);

                const tableColumn = ["No", "Kelas", "Nama Siswa", "Kode Soal", "Mata Pelajaran", "Nilai", "Grade", "Keterangan"];
                const tableRows = [];

                allFilteredGrades.forEach((grade, index) => {
                    tableRows.push([
                        index + 1, grade.kelas, grade.namaSiswa, grade.kodeSoal,
                        grade.mataPelajaran, grade.nilai, grade.grade, grade.keterangan
                    ]);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 28 });
                doc.save(`daftar-nilai-${new Date().toISOString().slice(0,10)}.pdf`);
                UI.showNotification('PDF berhasil diunduh!', 'success');
            },

            deleteFilteredQuestions() {
                 const filters = {
                    tahunAjaran: document.getElementById('filterTahunAjaran').value,
                    semester: document.getElementById('filterSemester').value,
                    kelas: document.getElementById('filterKelas').value,
                    mataPelajaran: document.getElementById('filterSubject').value,
                    kode: document.getElementById('filterCode').value
                };
                const cacheKey = AppState.cache.generateKey('questions', filters);
                const allFilteredQuestions = AppState.cache.get(cacheKey);

                if (!allFilteredQuestions) {
                     UI.showNotification('Tidak ada data yang dimuat untuk dihapus.', 'info');
                    return;
                }
                
                let questionsToDelete;
                if (AppState.currentUser.role === 'admin') {
                    questionsToDelete = allFilteredQuestions;
                } else if (AppState.currentUser.role === 'guru') {
                    questionsToDelete = allFilteredQuestions.filter(question => 
                        (question.createdBy && question.createdBy === AppState.currentUser.nama) || !question.createdBy
                    );
                } else {
                    questionsToDelete = [];
                }
                
                if (questionsToDelete.length === 0) {
                    UI.showNotification('Tidak ada soal milik Anda untuk dihapus pada filter ini.', 'info');
                    return;
                }

                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${questionsToDelete.length}** soal secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const idsToDelete = questionsToDelete.map(q => q.id);
                        
                        // OPTIMISTIC UI: Remove items from ALL cache entries
                        Object.keys(AppState.cache._data).forEach(key => {
                            if (key.startsWith('questions') && Array.isArray(AppState.cache._data[key])) {
                                for (let i = AppState.cache._data[key].length - 1; i >= 0; i--) {
                                    if (idsToDelete.includes(AppState.cache._data[key][i].id)) {
                                        AppState.cache._data[key].splice(i, 1);
                                    }
                                }
                            }
                        });
                        
                        // Re-render from modified cache
                        UI.loadAndRenderPaginatedQuestions(false);
                        
                        // BACKGROUND: Delete from server (fire and forget)
                        callGoogleScript('POST', { 
                            action: 'deleteQuestionsBatch', 
                            data: { ids: idsToDelete } 
                        }).then(serverResult => {
                            if (serverResult.status !== 'success') {
                                console.error('[Sync] Bulk delete failed:', serverResult.message);
                                UI.loadAndRenderPaginatedQuestions(true);
                            }
                        }).catch(err => {
                            console.error('[Sync] Bulk delete error:', err);
                        });
                    }
                );
            },

            deleteFilteredResults() {
                const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };
                const cacheKey = AppState.cache.generateKey('results', filters);
                const resultsToDelete = AppState.cache.get(cacheKey);

                if (!resultsToDelete || resultsToDelete.length === 0) {
                    UI.showNotification('Tidak ada hasil ujian untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${resultsToDelete.length}** data hasil ujian secara permanen. Lanjutkan?`, 
                    async () => {
                        const resultIds = resultsToDelete.map(r => r.resultId);
                        
                        // OPTIMISTIC UI: Remove items from ALL cache entries
                        Object.keys(AppState.cache._data).forEach(key => {
                            if (key.startsWith('results') && Array.isArray(AppState.cache._data[key])) {
                                for (let i = AppState.cache._data[key].length - 1; i >= 0; i--) {
                                    if (resultIds.includes(AppState.cache._data[key][i].resultId)) {
                                        AppState.cache._data[key].splice(i, 1);
                                    }
                                }
                            }
                        });
                        
                        // Re-render from modified cache
                        UI.loadAndRenderPaginatedResults(false);
                        
                        // BACKGROUND: Delete from server (fire and forget)
                        callGoogleScript('POST', { 
                            action: 'deleteResults', 
                            data: { resultIds: resultIds } 
                        }).then(serverResult => {
                            if (serverResult.status !== 'success') {
                                console.error('[Sync] Bulk delete failed:', serverResult.message);
                                UI.loadAndRenderPaginatedResults(true);
                            }
                        }).catch(err => {
                            console.error('[Sync] Bulk delete error:', err);
                        });
                    }
                );
            },

            deleteFilteredGrades() {
                const filters = {
                    tahunAjaran: document.getElementById('filterGradeTahunAjaran').value,
                    semester: document.getElementById('filterGradeSemester').value,
                    kodeSoal: document.getElementById('filterGradeCode').value,
                    mataPelajaran: document.getElementById('filterGradeSubject').value,
                    kelas: document.getElementById('filterGradeClass').value,
                    namaSiswa: document.getElementById('filterGradeStudent').value
                };
                const cacheKey = AppState.cache.generateKey('grades', filters);
                const gradesToDelete = AppState.cache.get(cacheKey);

                if (!gradesToDelete || gradesToDelete.length === 0) {
                    UI.showNotification('Tidak ada daftar nilai untuk dihapus sesuai filter.', 'info');
                    return;
                }
                UI.showConfirmModal(
                    'Konfirmasi Hapus Massal', 
                    `Anda akan menghapus **${gradesToDelete.length}** data nilai secara permanen. Aksi ini tidak dapat dibatalkan. Lanjutkan?`, 
                    async () => {
                        const gradeIds = gradesToDelete.map(g => g.gradeId);
                        
                        // OPTIMISTIC UI: Remove items from ALL cache entries
                        Object.keys(AppState.cache._data).forEach(key => {
                            if (key.startsWith('grades') && Array.isArray(AppState.cache._data[key])) {
                                for (let i = AppState.cache._data[key].length - 1; i >= 0; i--) {
                                    if (gradeIds.includes(AppState.cache._data[key][i].gradeId)) {
                                        AppState.cache._data[key].splice(i, 1);
                                    }
                                }
                            }
                        });
                        
                        // Re-render from modified cache
                        UI.loadAndRenderPaginatedGrades(false);
                        
                        // BACKGROUND: Delete from server (fire and forget)
                        callGoogleScript('POST', { 
                            action: 'deleteGrades', 
                            data: { gradeIds: gradeIds } 
                        }).then(serverResult => {
                            if (serverResult.status !== 'success') {
                                console.error('[Sync] Bulk delete failed:', serverResult.message);
                                UI.loadAndRenderPaginatedGrades(true);
                            }
                        }).catch(err => {
                            console.error('[Sync] Bulk delete error:', err);
                        });
                    }
                );
            }
        };

        // =================================================================
        // GEMINI API HELPER (Hanya untuk pembuatan soal otomatis)
        // Penilaian jawaban menggunakan TextSimilarity (tanpa AI)
        // =================================================================
        const GeminiHelper = {
            async generateQuestions(promptData) {
                // Modified: Fetch API Key from localStorage first
                let apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    // Fallback to old key, or warn user.
                    // Assuming old key is invalid per user's complaint, we rely on local storage.
                    UI.showNotification('API Key Gemini belum diatur. Silakan masukkan di menu Pengaturan.', 'error');
                    return null;
                }

                const systemPrompt = `Anda adalah asisten pembuatan soal untuk guru SD. Buat soal berdasarkan topik, mata pelajaran, dan kelas yang diberikan. Pastikan jawaban pilihan ganda bervariasi dan pengecohnya masuk akal. Jangan membuat soal yang terlalu sulit untuk level SD.`;
                
                const jumlahPg = parseInt(promptData.jumlah_pg) || 0;
                const jumlahIsian = parseInt(promptData.jumlah_isian) || 0;
                const jumlahUraian = parseInt(promptData.jumlah_uraian) || 0;

                let requestedTypes = [];
                if (jumlahPg > 0) requestedTypes.push(`${jumlahPg} soal Pilihan Ganda`);
                if (jumlahIsian > 0) requestedTypes.push(`${jumlahIsian} soal Isian Singkat`);
                if (jumlahUraian > 0) requestedTypes.push(`${jumlahUraian} soal Uraian`);

                const userQuery = `
                    Topik: "${promptData.topik}"
                    Mata Pelajaran: "${promptData.mataPelajaran}"
                    Kelas: "${promptData.kelas}"
                    
                    Buatkan soal-soal berikut: ${requestedTypes.join(', ')}.

                    Untuk Pilihan Ganda, berikan 4 pilihan dan tandai jawaban yang benar (correct) dengan indeks mulai dari 0.
                    Untuk soal tipe 'isian' dan 'uraian', sertakan properti "jawabanBenar" dengan kunci jawaban yang benar dan akurat. Jangan sertakan properti "pilihan" dan "correct" untuk tipe ini.
                    Untuk setiap soal, sertakan properti "tipe" dengan nilai 'pilihan_ganda', 'isian', atau 'uraian'.
                `;

                const ai = new GoogleGenAI({ apiKey: apiKey });
                
                try {
                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash",
                        contents: userQuery,
                        config: {
                            systemInstruction: systemPrompt,
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: Type.ARRAY,
                                items: {
                                    type: Type.OBJECT,
                                    properties: {
                                        tipe: { type: Type.STRING },
                                        pertanyaan: { type: Type.STRING },
                                        pilihan: { 
                                            type: Type.ARRAY,
                                            items: { type: Type.STRING }
                                        },
                                        correct: { type: Type.NUMBER },
                                        jawabanBenar: { type: Type.STRING }
                                    },
                                    required: ["tipe", "pertanyaan"]
                                }
                            }
                        }
                    });

                    const jsonText = response.text;
                    return JSON.parse(jsonText);

                } catch (error) {
                    console.error('Error calling Gemini API (Generate Questions):', error);
                    UI.showNotification('Gagal terhubung ke AI. Cek API Key Anda.', 'error');
                    return null;
                }
            }
            // gradeAnswer dihapus - menggunakan TextSimilarity.gradeAnswer() sebagai gantinya
        };


        // =================================================================
        // AUTHENTICATION SYSTEM
        // =================================================================
        const Auth = {
            login(username, password) {
                const user = AppState.users.find(u => u.username === username && u.password === password);
                if (user) {
                    AppState.currentUser = user;
                    // Persistence: Save user to localStorage
                    localStorage.setItem('cbtCurrentUser', JSON.stringify(user));
                    return { success: true, user: user };
                }
                return { success: false, message: 'Username atau password salah!' };
            },

            logout() {
                AppState.currentUser = null;
                AppState.cache.clear(); // Clear cache on logout
                // Persistence: Remove user from localStorage
                localStorage.removeItem('cbtCurrentUser');
                this.clearExamTimer();
                // Ensure we exit fullscreen on logout
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
                UI.showLogin();
            },

            clearExamTimer() {
                if (AppState.examTimer) {
                    clearInterval(AppState.examTimer);
                    AppState.examTimer = null;
                }
            },
            
            // Persistence: Check for persisted user on load
            checkSession() {
                const persistedUser = localStorage.getItem('cbtCurrentUser');
                if (persistedUser) {
                    // Make sure the user still exists in the fetched list
                    const parsedUser = JSON.parse(persistedUser);
                    const userExists = AppState.users.some(u => u.username === parsedUser.username);

                    if (userExists) {
                        AppState.currentUser = parsedUser;
                        UI.showDashboard();
                    } else {
                        // User might have been removed from the source
                        this.logout();
                    }

                } else {
                    UI.showLogin();
                }
            }
        };

        // =================================================================
        // UI MANAGEMENT
        // =================================================================
        const UI = {
            toBase64: file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            }),
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('managementModal').classList.remove('hidden');
            },

            hideModal() {
                document.getElementById('managementModal').classList.add('hidden');
            },

            showGeminiModal(title, content) {
                document.getElementById('geminiModalTitle').innerHTML = title;
                document.getElementById('geminiModalContent').innerHTML = content;
                document.getElementById('geminiModal').classList.remove('hidden');
            },

            hideGeminiModal() {
                document.getElementById('geminiModal').classList.add('hidden');
            },

            showConfirmModal(title, message, onConfirm) {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').innerHTML = message.replace(/\n/g, '<br>');
                document.getElementById('confirmModal').classList.remove('hidden');
                
                const confirmBtn = document.getElementById('confirmOkBtn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    document.getElementById('confirmModal').classList.add('hidden');
                    onConfirm();
                }, { once: true });
            },

            showQuestionListModal() {
                document.getElementById('questionListModal').classList.remove('hidden');
            },

            hideQuestionListModal() {
                document.getElementById('questionListModal').classList.add('hidden');
            },

            showLogin() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                document.getElementById('examLockModal').classList.add('hidden');
                document.getElementById('loginError').classList.add('hidden');
                AppState.currentView = 'login';
            },

            showDashboard() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.remove('hidden');
                document.getElementById('examInterface').classList.add('hidden');
                document.getElementById('examLockModal').classList.add('hidden');
                
                const sidebar = document.getElementById('dashboardSidebar');
                const header = document.getElementById('dashboardHeader');

                // All roles (admin, guru, siswa) will now use the header navigation
                sidebar.classList.add('hidden');
                header.classList.remove('hidden');
                this.setupDashboardHeader();
                
                let defaultView = 'dashboard';
                if (AppState.currentUser.role === 'guru') {
                    defaultView = 'questions';
                }
                
                this.setActiveNav(defaultView);
                this.showDashboardView(defaultView);
            },

            async showExamInterface() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examLockModal').classList.add('hidden');
                document.getElementById('examInterface').classList.remove('hidden');
                this.updateUserInfo();
                
                const success = await this.initializeExam(AppState.selectedExamCode);
                if (!success) {
                    this.showDashboard();
                    return;
                }
                
                AppState.currentView = 'exam';
            },

            showExamLockScreen() {
                document.getElementById('dashboardInterface').classList.add('hidden');
                document.getElementById('examLockModal').classList.remove('hidden');

                // Reset modal to initial state
                const examLockIcon = document.getElementById('examLockIcon');
                const examLockTitle = document.getElementById('examLockTitle');
                const examLockDesc = document.getElementById('examLockDesc');
                const examLockRules = document.getElementById('examLockRules');

                examLockIcon.className = 'fas fa-lock text-5xl text-blue-600 mb-6';
                examLockTitle.textContent = 'Mode Ujian Terkunci';
                examLockDesc.textContent = 'Anda akan memasuki mode ujian layar penuh.';
                examLockRules.classList.remove('hidden');

                const startBtn = document.getElementById('startFullscreenExamBtn');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Saya Mengerti & Mulai Ujian';

                const newStartBtn = startBtn.cloneNode(true);
                startBtn.parentNode.replaceChild(newStartBtn, startBtn);

                newStartBtn.addEventListener('click', async () => {
                    // Show loading state
                    const examLockIcon = document.getElementById('examLockIcon');
                    const examLockTitle = document.getElementById('examLockTitle');
                    const examLockDesc = document.getElementById('examLockDesc');
                    const examLockRules = document.getElementById('examLockRules');
                    const btn = document.getElementById('startFullscreenExamBtn');

                    examLockIcon.className = 'fas fa-spinner fa-spin text-5xl text-blue-600 mb-6';
                    examLockTitle.textContent = 'Memuat Soal Ujian...';
                    examLockDesc.textContent = 'Mohon tunggu, sedang mempersiapkan soal ujian Anda.';
                    examLockRules.classList.add('hidden');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memuat...';

                    try {
                        await document.documentElement.requestFullscreen();
                        // Wait for fullscreen to activate before showing the exam
                        // A small delay helps ensure the transition is smooth
                        setTimeout(() => {
                            UI.showExamInterface();
                        }, 200);
                    } catch (err) {
                        // Reset to initial state on error
                        examLockIcon.className = 'fas fa-lock text-5xl text-blue-600 mb-6';
                        examLockTitle.textContent = 'Mode Ujian Terkunci';
                        examLockDesc.textContent = 'Anda akan memasuki mode ujian layar penuh.';
                        examLockRules.classList.remove('hidden');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Saya Mengerti & Mulai Ujian';

                        UI.showNotification('Gagal masuk mode layar penuh. Silakan coba lagi atau aktifkan izin.', 'error');
                        console.error("Fullscreen request failed: ", err);
                    }
                }, { once: true });
            },

            updateDashboardUserInfo() {
                if (AppState.currentUser) {
                    document.getElementById('dashboardUserInfo').textContent = AppState.currentUser.nama;
                    document.getElementById('dashboardUserRole').textContent = AppState.currentUser.role.toUpperCase();
                }
            },

            updateUserInfo() {
                const userInfoEl = document.getElementById('examUserInfo');
                if (AppState.currentUser && userInfoEl) {
                    userInfoEl.textContent = AppState.currentUser.nama;
                }
            },

            setupDashboardHeader() {
                const header = document.getElementById('dashboardHeader');
                let navItems = [];

                if (AppState.currentUser.role === 'admin') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'users', label: 'Pengguna', icon: 'fas fa-users' },
                        { id: 'classes', label: 'Kelas', icon: 'fas fa-school' },
                        { id: 'subjects', label: 'Mapel', icon: 'fas fa-book' },
                        { id: 'settings', label: 'Pengaturan', icon: 'fas fa-cog' }
                    ];
                } else if (AppState.currentUser.role === 'guru') {
                    navItems = [
                        { id: 'questions', label: 'Manajemen Soal', icon: 'fas fa-question-circle' },
                        { id: 'results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' },
                        { id: 'settings', label: 'Pengaturan', icon: 'fas fa-cog' }
                    ];
                } else if (AppState.currentUser.role === 'siswa') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'student-results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'student-grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                }

                header.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800">SD IT NURUL KAUTSAR</h2>
                            <nav id="headerNav" class="flex items-center space-x-1 sm:border-l sm:pl-4">
                                ${navItems.map(item => `
                                    <button class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 nav-item" data-view="${item.id}">
                                        <i class="${item.icon} mr-1 sm:mr-2"></i><span class="hidden sm:inline">${item.label}</span>
                                    </button>
                                `).join('')}
                            </nav>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right mr-4">
                                 <p class="font-semibold text-gray-800">${AppState.currentUser.nama}</p>
                                 <p class="text-sm text-gray-500">${AppState.currentUser.role.toUpperCase()}</p>
                            </div>
                            <button id="headerLogoutBtn" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition duration-200" title="Logout">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                `;

                header.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.setActiveNav(view);
                        this.showDashboardView(view);
                    });
                });
                document.getElementById('headerLogoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar?', () => Auth.logout()));
            },

            setupDashboardNavigation() {
                const nav = document.getElementById('dashboardNav');
                let navItems = [];

                if (AppState.currentUser.role === 'admin') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'users', label: 'Manajemen Pengguna', icon: 'fas fa-users' },
                        { id: 'classes', label: 'Manajemen Kelas', icon: 'fas fa-school' },
                        { id: 'subjects', label: 'Manajemen Mata Pelajaran', icon: 'fas fa-book' }
                    ];
                } else if (AppState.currentUser.role === 'guru') {
                    navItems = [
                        { id: 'questions', label: 'Manajemen Soal', icon: 'fas fa-question-circle' },
                        { id: 'results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                } else if (AppState.currentUser.role === 'siswa') {
                    navItems = [
                        { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                        { id: 'student-results', label: 'Hasil Ujian', icon: 'fas fa-chart-bar' },
                        { id: 'student-grades', label: 'Daftar Nilai', icon: 'fas fa-list-alt' }
                    ];
                }

                nav.innerHTML = navItems.map(item => `
                    <button class="flex items-center px-3 py-4 text-sm font-medium hover:bg-blue-800 transition duration-200 nav-item" data-view="${item.id}">
                        <i class="${item.icon} mr-2"></i>
                        ${item.label}
                    </button>
                `).join('');

                nav.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view;
                        this.setActiveNav(view);
                        this.showDashboardView(view);
                    });
                });
            },

            setActiveNav(activeView) {
                // Reset and set for sidebar items
                document.querySelectorAll('#dashboardNav .nav-item').forEach(item => {
                    item.classList.toggle('bg-blue-800', item.dataset.view === activeView);
                });
                // Reset and set for header items
                document.querySelectorAll('#headerNav .nav-item').forEach(item => {
                    item.classList.toggle('bg-blue-100', item.dataset.view === activeView);
                    item.classList.toggle('text-blue-600', item.dataset.view === activeView);
                    item.classList.toggle('font-semibold', item.dataset.view === activeView);
                });
            },

            showDashboardView(view) {
                switch (view) {
                    case 'dashboard': this.showDashboardHome(); break;
                    case 'users': this.showUserManagement(); break;
                    case 'classes': this.showClassManagement(); break;
                    case 'subjects': this.showSubjectManagement(); break;
                    case 'questions': this.showQuestionManagement(); break;
                    case 'results': this.showResultManagement(); break;
                    case 'grades': this.showGradeManagement(); break;
                    case 'exam': this.showExamInterface(); break;
                    case 'student-results': this.showStudentResults(); break;
                    case 'student-grades': this.showStudentGrades(); break;
                    case 'settings': this.showSettings(); break;
                    default: this.showDashboardHome();
                }
            },

            async showDashboardHome() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat dashboard...</p></div>`;
                
                // Load data from server
                try {
                    // Load users from server
                    const usersResult = await callGoogleScript('GET', { action: 'getUsers' });
                    if (usersResult.status === 'success' && usersResult.data) {
                        AppState.users = usersResult.data;
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
                
                const user = AppState.currentUser;
                let dashboardContent = `<div class="fade-in"><h2 class="text-3xl font-bold text-gray-900 mb-8">Selamat Datang, ${user.nama}</h2>`;

                if (user.role === 'admin') {
                    dashboardContent += `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="stat-card">
                                <div class="flex items-center mb-4"><div class="icon-circle ocean">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Pengguna</p>
                                    <p class="text-3xl font-bold text-gray-900">${AppState.users.length}</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="flex items-center mb-4"><div class="icon-circle teal">
                                    <i class="fas fa-school"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Kelas</p>
                                    <p class="text-3xl font-bold text-gray-900">${AppState.classes.length}</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="flex items-center mb-4"><div class="icon-circle">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Mata Pelajaran</p>
                                    <p class="text-3xl font-bold text-gray-900">${AppState.subjects.length}</p>
                                </div>
                            </div>
                        </div>`;
                } else if (user.role === 'guru') {
                    // This view is no longer used for teachers, they go straight to questions
                } else if (user.role === 'siswa') {
                    dashboardContent += `
                        <div class="ocean-card shadow-xl">
                            <div class="text-center mb-8"><i class="fas fa-clipboard-list text-6xl text-cyan-500 mb-4"></i></div>
                            <div class="text-center mb-8">
                                <h3 class="text-2xl font-bold text-gray-900">Mulai Ujian</h3>
                                <p class="text-gray-600">Masukkan kode soal untuk memulai ujian</p>
                            </div>
                            <form id="examCodeForm" class="max-w-lg mx-auto">
                                <div class="relative mb-6">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                                        <i class="fas fa-key text-cyan-500"></i>
                                    </div>
                                    <input type="text" id="examCode" required class="input-ocean w-full pl-12 pr-5 py-4 text-gray-700 text-lg font-mono" placeholder="Contoh: PAI001">
                                </div>
                                <div id="examCodeError" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 px-4 py-3 rounded-xl text-sm mb-4"></div>
                                <button type="submit" class="w-full btn-ocean py-4 text-lg flex items-center justify-center gap-2">
                                    <i class="fas fa-play"></i>
                                    <span class="font-semibold">Mulai Ujian</span>
                                </button>
                            </form>
                        </div>`;
                }
                dashboardContent += `</div>`;
                content.innerHTML = dashboardContent;
                
                if (user.role === 'siswa') {
                    document.getElementById('examCodeForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const examCode = document.getElementById('examCode').value.trim();
                        const errorDiv = document.getElementById('examCodeError');
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        const studentUsername = AppState.currentUser.username;

                        if (!examCode) {
                            errorDiv.textContent = 'Silakan masukkan kode soal!';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // Show loading state
                        errorDiv.classList.add('hidden');
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span class="font-semibold">Memuat Soal...</span>';

                        try {
                            // Arsitektur baru: Cek dari IndexedDB dulu
                            const isBlocked = await DataService.isStudentBlocked(studentUsername, examCode);

                            if (isBlocked) {
                                errorDiv.textContent = 'Akses Anda ke soal ini diblokir. Hubungi admin untuk membuka blokir.';
                                errorDiv.classList.remove('hidden');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-play"></i><span class="font-semibold">Mulai Ujian</span>';
                                return;
                            }

                            // Check if exam code exists via Google Script
                            const result = await callGoogleScript('GET', { action: 'getQuestions', kode: examCode });
                            if (result.status !== 'success' || result.data.length === 0) {
                                 errorDiv.textContent = 'Kode soal tidak ditemukan!';
                                errorDiv.classList.remove('hidden');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-play"></i><span class="font-semibold">Mulai Ujian</span>';
                                return;
                            }

                            // New: Check if student's grade level matches exam's grade level
                            const examData = result.data[0];
                            const studentGrade = AppState.currentUser.kelas.charAt(0);
                            const examGrade = examData.kelas.charAt(0);

                            if (studentGrade !== examGrade) {
                                errorDiv.textContent = 'Anda tidak diizinkan mengerjakan soal untuk kelas ini.';
                                errorDiv.classList.remove('hidden');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-play"></i><span class="font-semibold">Mulai Ujian</span>';
                                return;
                            }

                            errorDiv.classList.add('hidden');
                            AppState.selectedExamCode = examCode;
                            UI.showExamLockScreen();
                        } catch (error) {
                            console.error('Error starting exam:', error);
                            errorDiv.textContent = 'Terjadi kesalahan. Silakan coba lagi.';
                            errorDiv.classList.remove('hidden');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-play"></i><span class="font-semibold">Mulai Ujian</span>';
                        }
                    });
                }

                this.setupDashboardHeader();
            },

            async showSettings() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i></div>`;

                let currentDuration = 60; // Default duration in minutes
                
                try {
                    // Arsitektur baru: IndexedDB ‚Üí Google Apps Script
                    const settings = await DataService.getSettings('examConfig');
                    if (settings && settings.durationMinutes) {
                        currentDuration = settings.durationMinutes;
                    }
                } catch (error) {
                    console.error("Could not load exam settings:", error);
                    UI.showNotification('Gagal memuat pengaturan. Menggunakan nilai default.', 'error');
                }

                const currentApiKey = localStorage.getItem('geminiApiKey') || '';

                content.innerHTML = `
                    <div class="fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Pengaturan</h2>

                        <!-- Card 1: Pengaturan Ujian (Server) -->
                        <div class="max-w-lg mx-auto bg-white rounded-lg shadow p-6 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-clock text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Pengaturan Waktu Ujian</h3>
                                    <p class="text-xs text-gray-500"><i class="fas fa-cloud mr-1"></i>Tersimpan di Server (berlaku untuk semua)</p>
                                </div>
                            </div>
                            <form id="examSettingsForm">
                                <div class="mb-4">
                                    <label for="examDuration" class="block text-sm font-medium text-gray-700 mb-2">Durasi Waktu Ujian (menit)</label>
                                    <p class="text-xs text-gray-500 mb-2">Atur berapa lama waktu yang dimiliki siswa untuk menyelesaikan ujian.</p>
                                    <input type="number" id="examDuration" name="examDuration" min="1" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           value="${currentDuration}">
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" id="saveExamSettingsBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold text-sm">
                                        <i class="fas fa-save mr-2"></i>Simpan Durasi
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Card 2: API Key (Local Browser) -->
                        <div class="max-w-lg mx-auto bg-white rounded-lg shadow p-6 mb-6">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                                    <i class="fas fa-key text-amber-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Google Gemini API Key</h3>
                                    <p class="text-xs text-gray-500"><i class="fas fa-laptop mr-1"></i>Tersimpan di Browser ini saja (privat)</p>
                                </div>
                            </div>
                            <form id="apiKeyForm">
                                <div class="mb-4">
                                    <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-2">API Key untuk Pembuatan Soal Otomatis</label>
                                    <p class="text-xs text-gray-500 mb-2">Masukkan API Key Anda untuk mengaktifkan fitur AI. Key ini hanya tersimpan di browser ini dan tidak dikirim ke server.</p>
                                    <input type="password" id="geminiApiKey" name="geminiApiKey"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                                           placeholder="AIzaSy..." value="${currentApiKey}">
                                    <div class="mt-2 text-xs text-blue-600">
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="hover:underline"><i class="fas fa-external-link-alt mr-1"></i>Dapatkan API Key di sini</a>
                                    </div>
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" id="saveApiKeyBtn" class="bg-amber-600 text-white px-5 py-2 rounded-lg hover:bg-amber-700 transition duration-200 font-semibold text-sm">
                                        <i class="fas fa-save mr-2"></i>Simpan API Key
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div id="blockedStudentsSection" class="mt-8"></div>
                    </div>
                `;

                // Form 1: Exam Duration Settings (synced to server)
                document.getElementById('examSettingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newDuration = parseInt(document.getElementById('examDuration').value);

                    if (isNaN(newDuration) || newDuration <= 0) {
                        UI.showNotification('Masukkan durasi yang valid.', 'error');
                        return;
                    }

                    const submitButton = document.getElementById('saveExamSettingsBtn');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    try {
                        await DataService.saveSettings({
                            key: 'examConfig',
                            durationMinutes: newDuration
                        });
                        UI.showNotification('Durasi ujian berhasil disimpan!', 'success');
                    } catch (error) {
                        console.error("Error saving exam settings:", error);
                        UI.showNotification('Gagal menyimpan durasi ujian!', 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Durasi';
                    }
                });

                // Form 2: API Key Settings (stored locally)
                document.getElementById('apiKeyForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newApiKey = document.getElementById('geminiApiKey').value.trim();

                    const submitButton = document.getElementById('saveApiKeyBtn');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';

                    try {
                        if (newApiKey) {
                            localStorage.setItem('geminiApiKey', newApiKey);
                            UI.showNotification('API Key berhasil disimpan di browser ini!', 'success');
                        } else {
                            localStorage.removeItem('geminiApiKey');
                            UI.showNotification('API Key berhasil dihapus!', 'success');
                        }
                    } catch (error) {
                        console.error("Error saving API key:", error);
                        UI.showNotification('Gagal menyimpan API Key!', 'error');
                    } finally {
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan API Key';
                    }
                });

                // Load and render blocked students
                this.renderBlockedStudents();
            },

            async renderBlockedStudents(forceRefresh = false) {
                const section = document.getElementById('blockedStudentsSection');
                if (!section) return;

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">Manajemen Siswa Terblokir</h3>
                        <button id="unblockAllBtn" class="hidden bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition duration-200 text-sm font-semibold">
                            <i class="fas fa-unlock-alt mr-2"></i>Buka Semua Blokir
                        </button>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Diblokir</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="blockedStudentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                const tableBody = document.getElementById('blockedStudentsTableBody');
                const unblockAllBtn = document.getElementById('unblockAllBtn');

                try {
                    // Arsitektur baru: IndexedDB ‚Üí Google Apps Script
                    const blockedList = await DataService.getBlockedStudents(forceRefresh);
                    
                    if (!blockedList || blockedList.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Tidak ada siswa yang terblokir saat ini.</td></tr>';
                        if (unblockAllBtn) unblockAllBtn.classList.add('hidden');
                        return;
                    }

                    if (unblockAllBtn) {
                        unblockAllBtn.classList.remove('hidden');
                        unblockAllBtn.onclick = () => Management.unblockAllStudents();
                    }
                    
                    tableBody.innerHTML = blockedList.map((blocked, index) => {
                        const user = AppState.users.find(u => u.username === blocked.username);
                        const studentName = user ? user.nama : 'N/A';
                        const blockedAtDate = blocked.blockedAt || 'N/A';
                        return `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${blocked.username}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${studentName}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${blocked.examCode}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${blockedAtDate}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="Management.unblockStudent('${blocked.blockId}')" class="bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 text-xs">
                                        <i class="fas fa-unlock-alt mr-1"></i> Buka Blokir
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } catch (error) {
                    console.error("Error fetching blocked students:", error);
                    tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat data siswa terblokir.</td></tr>';
                }
            },
            
            renderBlockedStudentsTable(tableBody, blockedList, unblockAllBtn, fromCache) {
                // Function no longer needed, merged into renderBlockedStudents
            },


            async showUserManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat data pengguna...</p></div>`;
                
                // Load users from server
                try {
                    const usersResult = await callGoogleScript('GET', { action: 'getUsers' });
                    if (usersResult.status === 'success' && usersResult.data) {
                        AppState.users = usersResult.data;
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                }

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Pengguna</h2><button onclick="Management.showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Pengguna</button></div>
                        
                        <!-- Filter Section -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama / Username</label>
                                    <input type="text" id="filterUserName" placeholder="Cari..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select id="filterUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="guru">Guru</option>
                                        <option value="siswa">Siswa</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                    <select id="filterUserClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Kelas</option>
                                        ${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyUserFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button>
                                </div>
                                <div class="flex items-end">
                                    <button id="resetUserFilterBtn" class="w-full bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-sync mr-2"></i>Reset</button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table id="userManagementTable" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <!-- User data will be rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;

                document.getElementById('applyUserFilterBtn').addEventListener('click', () => this.renderUserTable());
                document.getElementById('resetUserFilterBtn').addEventListener('click', () => {
                    document.getElementById('filterUserName').value = '';
                    document.getElementById('filterUserRole').value = '';
                    document.getElementById('filterUserClass').value = '';
                    this.renderUserTable();
                });

                this.renderUserTable();
            },

            renderUserTable() {
                const nameFilter = document.getElementById('filterUserName').value.toLowerCase();
                const roleFilter = document.getElementById('filterUserRole').value;
                const classFilter = document.getElementById('filterUserClass').value;

                const filteredUsers = AppState.users.filter(user => {
                    const nameMatch = user.nama.toLowerCase().includes(nameFilter) || user.username.toLowerCase().includes(nameFilter);
                    const roleMatch = !roleFilter || user.role === roleFilter;
                    const classMatch = !classFilter || user.kelas === classFilter;
                    return nameMatch && roleMatch && classMatch;
                });

                const tableBody = document.querySelector('#userManagementTable tbody');
                tableBody.innerHTML = filteredUsers.map((user, index) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.kelas || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : user.role === 'guru' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${user.role.toUpperCase()}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="Management.viewUser('${user.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-eye"></i></button>
                            <button onclick="Management.editUser('${user.id}')" class="text-green-600 hover:text-green-900 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="Management.deleteUser('${user.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');
            },

            showClassManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Kelas</h2><button onclick="Management.showAddClassModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Kelas</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.classes.map(cls => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-gray-900">${cls.nama}</h3></div><p class="text-gray-600 text-sm mb-4">${cls.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editClass('${cls.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteClass('${cls.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            showSubjectManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-900">Manajemen Mata Pelajaran</h2><button onclick="Management.showAddSubjectModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah Mata Pelajaran</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${AppState.subjects.map(subject => `
                            <div class="bg-white rounded-lg shadow hover:shadow-md transition duration-200"><div class="p-6"><div class="flex items-center mb-4"><div class="bg-blue-100 rounded-full w-12 h-12 flex items-center justify-center"><i class="fas fa-book text-blue-600"></i></div><div class="ml-4"><h3 class="text-lg font-semibold text-gray-900">${subject.nama}</h3></div></div><p class="text-gray-600 text-sm mb-4">${subject.deskripsi}</p><div class="flex space-x-2"><button onclick="Management.editSubject('${subject.id}')" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700"><i class="fas fa-edit mr-1"></i>Edit</button><button onclick="Management.deleteSubject('${subject.id}')" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700"><i class="fas fa-trash"></i></button></div></div></div>`).join('')}
                        </div></div>`;
            },

            async showQuestionManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat manajemen soal...</p></div>`;
                
                const isTeacher = AppState.currentUser.role === 'guru';
                let classOptions = '';
                if (isTeacher) {
                    const teacherGrade = AppState.currentUser.kelas.charAt(0);
                    const availableClasses = AppState.classes.filter(c => c.nama.startsWith(teacherGrade));
                    classOptions = availableClasses.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                } else {
                    classOptions = AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('');
                }

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Manajemen Soal</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="UI.refreshQuestionsFromServer()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition duration-200" title="Sinkronkan data dengan Google Sheet"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                                <button onclick="Management.showAutoGenerateModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200"><i class="fas fa-magic mr-2"></i>Buat Otomatis</button>
                                <button onclick="Management.deleteFilteredQuestions()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadQuestionsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download</button>
                                <button onclick="Management.showAddQuestionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterKelas" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Kelas</option>${classOptions}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Mata Pelajaran</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterCode" placeholder="Masukkan kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="flex items-end"><button id="applyFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div id="questionsList" class="space-y-4"></div>
                        <div id="questionsPagination" class="flex justify-between items-center mt-6"></div>
                    </div>`;
                
                document.getElementById('applyFilterBtn').addEventListener('click', () => {
                    AppState.pagination.questions.currentPage = 1; // Reset to first page on new filter
                    UI.loadAndRenderPaginatedQuestions();
                });
                // Initial load
                UI.loadAndRenderPaginatedQuestions();
            },

            async showResultManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat hasil ujian...</p></div>`;
                
                
                const isTeacher = AppState.currentUser.role === 'guru';
                
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Hasil Ujian</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="UI.refreshResultsFromServer()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition duration-200" title="Sinkronkan data dengan Google Sheet"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                                <button onclick="Management.gradeAllWithAI()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200"><i class="fas fa-calculator mr-2"></i>Nilai Otomatis</button>
                                <button onclick="Management.deleteFilteredResults()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadResultsPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterResultTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterResultSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterResultCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterResultSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterResultClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterResultStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div>
                            <div class="flex items-end col-span-full md:col-span-1"><button id="applyResultFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertanyaan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                        <div id="resultsPagination" class="flex justify-between items-center mt-6"></div>
                    </div>`;
                
                if (isTeacher) document.getElementById('filterResultClass').value = AppState.currentUser.kelas;
                
                UI.populateStudentFilter('filterResultClass', 'filterResultStudent');

                document.getElementById('applyResultFilterBtn').addEventListener('click', () => {
                    AppState.pagination.results.currentPage = 1; // Reset to first page
                    UI.loadAndRenderPaginatedResults();
                });
                UI.loadAndRenderPaginatedResults();
            },

            async showGradeManagement() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat daftar nilai...</p></div>`;
                
                
                const isTeacher = AppState.currentUser.role === 'guru';

                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">Daftar Nilai</h2>
                            <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2 w-full sm:w-auto">
                                <button onclick="UI.refreshGradesFromServer()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition duration-200" title="Sinkronkan data dengan Google Sheet"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                                <button onclick="Management.deleteFilteredGrades()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200"><i class="fas fa-trash-alt mr-2"></i>Hapus</button>
                                <button onclick="Management.downloadGradesPDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200"><i class="fas fa-download mr-2"></i>Download PDF</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6"><div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                             <div><label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label><select id="filterGradeTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getYearOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="filterGradeSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${UI.getSemesterOptions()}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kode Soal</label><input type="text" id="filterGradeCode" placeholder="Kode soal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label><select id="filterGradeSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua</option>${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="filterGradeClass" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" ${isTeacher ? 'disabled' : ''}><option value="">Semua</option>${AppState.classes.map(c => `<option value="${c.nama}">${c.nama}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa</label><select id="filterGradeStudent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="">Semua Siswa</option></select></div>
                            <div class="flex items-end col-span-full md:col-span-1"><button id="applyGradeFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Filter</button></div>
                        </div></div>
                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Selesai</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                        <div id="gradesPagination" class="flex justify-between items-center mt-6"></div>
                    </div>`;
                
                if (isTeacher) document.getElementById('filterGradeClass').value = AppState.currentUser.kelas;

                UI.populateStudentFilter('filterGradeClass', 'filterGradeStudent');

                document.getElementById('applyGradeFilterBtn').addEventListener('click', () => {
                    AppState.pagination.grades.currentPage = 1; // Reset to first page
                    UI.loadAndRenderPaginatedGrades();
                });
                UI.loadAndRenderPaginatedGrades();
            },

            async showStudentResults() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat hasil ujian...</p></div>`;
                
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Hasil Ujian Anda</h2>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                    <select id="filterStudentResultTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getYearOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                                    <select id="filterStudentResultSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getSemesterOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select id="filterStudentResultSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyStudentResultFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                        <i class="fas fa-search mr-2"></i>Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertanyaan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jawaban Anda</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentResultsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('applyStudentResultFilterBtn').addEventListener('click', async () => {
                    const studentResultsTableBody = document.getElementById('studentResultsTableBody');
                    studentResultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>';

                    const filters = {
                        action: 'getResults',
                        namaLengkap: AppState.currentUser.nama,
                        tahunAjaran: document.getElementById('filterStudentResultTahunAjaran').value,
                        semester: document.getElementById('filterStudentResultSemester').value,
                        mataPelajaran: document.getElementById('filterStudentResultSubject').value,
                    };
                    
                    try {
                        // Try cache first
                        const cacheKey = `studentResults_${JSON.stringify(filters)}`;
                        let results = null;
                        
                        // Fetch from server directly
                        const result = await callGoogleScript('GET', filters);
                        if (result.status === 'success') {
                            this.renderStudentResultsTable(result.data);
                        } else {
                            throw new Error('Gagal memuat hasil ujian');
                        }
                    } catch (error) {
                         studentResultsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat data.</td></tr>';
                    }
                });
                document.getElementById('applyStudentResultFilterBtn').click();
            },

            renderStudentResultsTable(results) {
                const resultsTableBody = document.getElementById('studentResultsTableBody');
                if (!resultsTableBody) return;
                
                results.sort((a, b) => {
                    if (a.kodesoal < b.kodesoal) return -1;
                    if (a.kodesoal > b.kodesoal) return 1;
                    return a.noSoal - b.noSoal;
                });

                resultsTableBody.innerHTML = results.length === 0 ?
                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Tidak ada hasil ujian yang ditemukan</td></tr>' :
                    results.map((result, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.kodesoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.noSoal}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.pertanyaan}</td>
                            <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${result.jawabanSiswa}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.status === 'benar' ? 'bg-green-100 text-green-800' : result.status === 'salah' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${result.status}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${result.nilai}</td>
                        </tr>
                    `).join('');
            },

            async showStudentGrades() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-500">Memuat daftar nilai...</p></div>`;
                
                content.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                            <h2 class="text-2xl font-bold text-gray-900">Daftar Nilai Anda</h2>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                                    <select id="filterStudentGradeTahunAjaran" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getYearOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                                    <select id="filterStudentGradeSemester" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua</option>
                                        ${UI.getSemesterOptions()}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                    <select id="filterStudentGradeSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Semua Mata Pelajaran</option>
                                        ${AppState.subjects.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="applyStudentGradeFilterBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                        <i class="fas fa-search mr-2"></i>Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Soal</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grade</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Selesai</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentGradesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('applyStudentGradeFilterBtn').addEventListener('click', async () => {
                    const studentGradesTableBody = document.getElementById('studentGradesTableBody');
                    studentGradesTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data dari server...</td></tr>';

                    const tahunAjaran = document.getElementById('filterStudentGradeTahunAjaran').value;
                    const semester = document.getElementById('filterStudentGradeSemester').value;
                    const mataPelajaran = document.getElementById('filterStudentGradeSubject').value;
                    
                    try {
                        // Fetch from Google Sheets directly
                        const result = await callGoogleScript('GET', {
                            action: 'getGrades',
                            namaSiswa: AppState.currentUser.nama,
                            tahunAjaran: tahunAjaran,
                            semester: semester,
                            mataPelajaran: mataPelajaran
                        });

                        if (result.status === 'success') {
                            this.renderStudentGradesTable(result.data || []);
                        } else {
                            throw new Error('Gagal memuat data nilai dari server');
                        }
                    } catch (error) {
                        console.error("Error fetching student grades:", error);
                        studentGradesTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat data. Periksa koneksi.</td></tr>';
                    }
                });
                document.getElementById('applyStudentGradeFilterBtn').click();
            },

            renderStudentGradesTable(grades) {
                const gradesTableBody = document.getElementById('studentGradesTableBody');
                if (!gradesTableBody) return;

                grades.sort((a, b) => (new Date(b.waktuSelesai.split(', ')[0].split('/').reverse().join('-') + ' ' + b.waktuSelesai.split(', ')[1])) - (new Date(a.waktuSelesai.split(', ')[0].split('/').reverse().join('-') + ' ' + a.waktuSelesai.split(', ')[1])));

                gradesTableBody.innerHTML = grades.length === 0 ?
                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai yang ditemukan</td></tr>' :
                    grades.map((grade, index) => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.kodeSoal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.mataPelajaran}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${grade.nilai}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${grade.grade === 'A' ? 'bg-green-100 text-green-800' : grade.grade === 'B' ? 'bg-blue-100 text-blue-800' : grade.grade === 'C' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${grade.grade}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.keterangan}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${grade.waktuSelesai}</td>
                        </tr>
                    `).join('');
            },

            async initializeExam(examCode) {
                if (!examCode) return false;

                try {
                    // Arsitektur baru: IndexedDB ‚Üí Google Apps Script
                    const filteredQuestions = await DataService.getQuestions(examCode);
                    
                    if (!filteredQuestions || filteredQuestions.length === 0) {
                        UI.showNotification('Kode soal tidak ditemukan!', 'error');
                        return false;
                    }
                    
                    const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };

                    // Sort by: 1. Mata Pelajaran, 2. Tipe (PG ‚Üí Isian/Essai ‚Üí Uraian), 3. Creation time
                    filteredQuestions.sort((a, b) => {
                        // 1. Sort by mataPelajaran first
                        const mataPelajaranCompare = (a.mataPelajaran || '').localeCompare(b.mataPelajaran || '', 'id-ID');
                        if (mataPelajaranCompare !== 0) return mataPelajaranCompare;

                        // 2. Sort by tipe (pilihan_ganda ‚Üí isian ‚Üí uraian)
                        const typeA = typeOrder[a.tipe] || 99;
                        const typeB = typeOrder[b.tipe] || 99;
                        if (typeA !== typeB) return typeA - typeB;

                        // 3. Sort by creation time
                        const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                        const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                        return timeA - timeB;
                    });

                    AppState.questions = filteredQuestions.map((q, index) => ({
                        originalId: q.id,
                        id: index + 1,
                        type: q.tipe,
                        question: q.pertanyaan,
                        options: q.pilihan || [],
                        correct: (q.correct !== "" && q.correct !== null) ? Number(q.correct) : null,
                        correctAnswer: q.jawabanBenar || null,
                        gambar: q.gambar || null,
                        mataPelajaran: q.mataPelajaran || null,
						tahunAjaran: q.tahunAjaran,
						semester: q.semester
                    }));
                    
                    AppState.selectedExamCode = examCode;
                    AppState.currentQuestion = 0;
                    AppState.examAnswers = {};
                    AppState.violationCount = 0; // Reset violations
                    
                    // Get settings from DataService
                    try {
                        const settings = await DataService.getSettings('examConfig');
                        if (settings && settings.durationMinutes) {
                            AppState.examTimeLeft = parseInt(settings.durationMinutes) * 60;
                        } else {
                            AppState.examTimeLeft = 3600; // Default 60 minutes
                        }
                    } catch (error) {
                        console.error("Error fetching exam settings, using default time.", error);
                        AppState.examTimeLeft = 3600;
                    }
                    
                    this.renderQuestion();
                    this.setupQuestionNavigation();
                    this.startTimer();
                    this.updateProgress();

                    document.addEventListener('fullscreenchange', this.handleFullscreenChange);
                    document.addEventListener('visibilitychange', this.handleVisibilityChange);

                    return true;
                } catch (error) {
                    console.error("Error initializing exam: ", error);
                    UI.showNotification('Gagal memuat soal ujian!', 'error');
                    return false;
                }
            },

            renderQuestion() {
                const question = AppState.questions[AppState.currentQuestion];
                const questionContent = document.getElementById('questionContent');
                
                document.getElementById('currentQuestionNum').textContent = AppState.currentQuestion + 1;
                document.getElementById('totalQuestions').textContent = AppState.questions.length;
                
                 const questionTypeMap = {
                    'pilihan_ganda': 'Pilihan Ganda',
                    'isian': 'Isian',
                    'uraian': 'Uraian'
                };
                 const questionTypeClassMap = {
                    'pilihan_ganda': 'bg-blue-100 text-blue-800',
                    'isian': 'bg-green-100 text-green-800',
                    'uraian': 'bg-purple-100 text-purple-800'
                };


                let content = `
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">Soal No. ${AppState.currentQuestion + 1}</h3>
                            <span class="px-3 py-1 text-sm rounded-full ${questionTypeClassMap[question.type] || ''}">${questionTypeMap[question.type] || 'Soal'}</span>
                        </div>
                        <p class="text-lg text-gray-800 leading-relaxed mb-6">${question.question}</p>
                        ${question.gambar ? `<div class="my-4"><img src="${question.gambar}" class="w-full max-w-sm mx-auto rounded-lg shadow-md"></div>` : ''}
                    </div>`;
                
                if (question.type === 'pilihan_ganda') {
                    content += `<div class="space-y-3">${question.options.map((option, index) => `<label class="flex items-center p-4 border-2 rounded-lg hover:bg-blue-50 hover:border-blue-300 cursor-pointer transition duration-200 ${AppState.examAnswers[AppState.currentQuestion] === index ? 'bg-blue-50 border-blue-500' : 'border-gray-200'}"><input type="radio" name="answer" value="${index}" class="mr-4 w-5 h-5 text-blue-600" ${AppState.examAnswers[AppState.currentQuestion] === index ? 'checked' : ''}><span class="text-gray-800 font-medium mr-3">${String.fromCharCode(65 + index)}.</span><span class="text-gray-800">${option}</span></label>`).join('')}</div>`;
                } else if (question.type === 'isian') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><input type="text" name="answer" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" placeholder="Masukkan jawaban Anda" value="${AppState.examAnswers[AppState.currentQuestion] || ''}"></div>`;
                } else if (question.type === 'uraian') {
                    content += `<div><label class="block text-sm font-medium text-gray-700 mb-3">Jawaban:</label><textarea name="answer" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg resize-none" placeholder="Tuliskan jawaban Anda dengan lengkap dan jelas">${AppState.examAnswers[AppState.currentQuestion] || ''}</textarea></div>`;
                }
                
                questionContent.innerHTML = content;
                document.getElementById('prevQuestionBtn').disabled = AppState.currentQuestion === 0;
                document.getElementById('nextQuestionBtn').innerHTML = AppState.currentQuestion === AppState.questions.length - 1 ? 'Selesai <i class="fas fa-flag-checkered ml-2"></i>' : 'Selanjutnya <i class="fas fa-chevron-right ml-2"></i>';
                
                questionContent.querySelectorAll('input[name="answer"], textarea[name="answer"]').forEach(input => {
                    // Use 'input' event for real-time updates on text/textarea
                    const eventType = (input.type === 'radio') ? 'change' : 'input';
                    input.addEventListener(eventType, () => {
                        if (input.type === 'radio') AppState.examAnswers[AppState.currentQuestion] = parseInt(input.value);
                        else AppState.examAnswers[AppState.currentQuestion] = input.value;
                        this.updateQuestionNavigation();
                        this.updateProgress();
                    });
                    // Also listen to change event for radio buttons and final blur
                    if (input.type !== 'radio') {
                        input.addEventListener('change', () => {
                            AppState.examAnswers[AppState.currentQuestion] = input.value;
                            this.updateQuestionNavigation();
                            this.updateProgress();
                        });
                    }
                });
            },

            setupQuestionNavigation() {
                const navigationModal = document.getElementById('questionListModalContent');
                if (!navigationModal) return;
                navigationModal.innerHTML = Array.from({ length: AppState.questions.length }, (_, i) => {
                    const isAnswered = AppState.examAnswers[i] !== undefined && AppState.examAnswers[i] !== '';
                    const isCurrent = i === AppState.currentQuestion;
                    // Priority: if answered, show green (answered). Current indicator shown via border.
                    let stateClass = 'unanswered';
                    if (isAnswered) stateClass = 'answered';
                    else if (isCurrent) stateClass = 'current';
                    // Add extra styling for current question
                    const currentBorder = isCurrent ? 'ring-2 ring-offset-2 ring-blue-500' : '';
                    return `<button class="question-nav-btn w-12 h-12 rounded-full border-2 text-sm font-bold ${stateClass} ${currentBorder}" onclick="UI.goToQuestionFromModal(${i})">${i + 1}</button>`;
                }).join('');
            },

            updateQuestionNavigation() { this.setupQuestionNavigation(); },

            goToQuestion(index) {
                AppState.currentQuestion = index;
                this.renderQuestion();
                this.updateQuestionNavigation();
                this.updateProgress();
            },

            goToQuestionFromModal(index) {
                this.goToQuestion(index);
                this.hideQuestionListModal();
            },

            updateProgress() {
                const answered = Object.keys(AppState.examAnswers).filter(key => AppState.examAnswers[key] !== undefined && AppState.examAnswers[key] !== '').length;
                const total = AppState.questions.length;
                const percentage = total > 0 ? (answered / total) * 100 : 0;
                document.getElementById('progressBar').style.width = `${percentage}%`;
            },

            startTimer() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);
                AppState.examTimer = setInterval(() => {
                    AppState.examTimeLeft--;
                    document.getElementById('examTimer').textContent = this.formatTime(AppState.examTimeLeft);
                    if (AppState.examTimeLeft <= 0) this.submitExam();
                }, 1000);
            },

            formatTime(seconds) {
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            },

            async submitExam() {
                if (AppState.examTimer) clearInterval(AppState.examTimer);

                // Remove security listeners before showing confirmation
                document.removeEventListener('fullscreenchange', this.handleFullscreenChange);
                document.removeEventListener('visibilitychange', this.handleVisibilityChange);

                Swal.fire({
                    title: 'Sedang Memproses Jawaban...',
                    html: 'Mohon tunggu, jawaban Anda sedang disimpan dan dinilai.',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
                
                // Get exam details from the first question (already loaded in AppState)
                const firstQuestionData = AppState.questions.length > 0 ? AppState.questions[0] : {};
                const examDetails = {
                    mataPelajaran: firstQuestionData.mataPelajaran || 'Tidak diketahui',
                    semester: firstQuestionData.semester || 'Tidak diketahui',
                    tahunAjaran: firstQuestionData.tahunAjaran || 'Tidak diketahui'
                };
                
                let totalScore = 0;
                let resultsForSheet = [];
                const submissionTimestamp = new Date().toISOString();

                for (const [index, question] of AppState.questions.entries()) {
                    const userAnswer = AppState.examAnswers[index] !== undefined ? String(AppState.examAnswers[index]) : 'Tidak dijawab';
                    let point = 0;
                    let status = 'salah';

                    if (question.type === 'pilihan_ganda') {
                        if (question.correct !== undefined && AppState.examAnswers[index] === question.correct) {
                            point = 100;
                            status = 'benar';
                        }
                    } else { // Handles 'isian' and 'uraian' - PENILAIAN OTOMATIS
                        if (userAnswer && userAnswer !== 'Tidak dijawab' && question.correctAnswer) {
                            // Gunakan TextSimilarity untuk penilaian otomatis
                            const gradingResult = TextSimilarity.gradeAnswer(userAnswer, question.correctAnswer);
                            point = gradingResult.nilai;
                            status = point > 0 ? 'benar' : 'salah';
                        } else if (!question.correctAnswer) {
                            // Jika tidak ada kunci jawaban, perlu dinilai manual
                            point = 0;
                            status = 'perlu dinilai';
                        }
                    }
                    totalScore += point;

                    resultsForSheet.push({
                        resultId: `${Date.now()}-${AppState.currentUser.username}-${index + 1}`,
                        kelas: AppState.currentUser.kelas,
                        kodesoal: AppState.selectedExamCode,
                        namaLengkap: AppState.currentUser.nama,
                        noSoal: index + 1,
                        pertanyaan: question.question,
                        jawabanSiswa: userAnswer,
                        status: status,
                        nilai: point,
                        mataPelajaran: examDetails.mataPelajaran,
                        semester: examDetails.semester || AppState.lastQuestionData.semester || 'Tidak diketahui',
                        tahunAjaran: examDetails.tahunAjaran || AppState.lastQuestionData.tahunAjaran || 'Tidak diketahui',
                        timestamp: submissionTimestamp
                    });
                }
                
                try {
                    // This is where the fix for date-like answers is implemented.
                    const preparedResults = resultsForSheet.map((result, index) => {
                        const question = AppState.questions[index];
                        // Hanya berlaku untuk soal isian atau uraian
                        if (question && (question.type === 'isian' || question.type === 'uraian')) {
                            const answer = String(result.jawabanSiswa);
                            
                            // Regex untuk mendeteksi format seperti tanggal (misal: 1/2, 1-2, 1/2/2024) atau angka murni
                            if (/^\d{1,4}[-\/]\d{1,2}(?:[-\/]\d{1,4})?$/.test(answer.trim()) || /^\d+$/.test(answer.trim())) {
                                // Jika cocok, tambahkan tanda kutip di depannya
                                return { ...result, jawabanSiswa: "'" + answer };
                            }
                        }
                        return result;
                    });
                    
                    // Arsitektur baru: Simpan ke IndexedDB dulu, lalu sync ke server
                    await DataService.addResults(preparedResults);

                    // Save final grade summary
                    const finalScore = AppState.questions.length > 0 ? Math.round(totalScore / AppState.questions.length) : 0;
                    const grade = finalScore >= 90 ? 'A' : finalScore >= 80 ? 'B' : finalScore >= 70 ? 'C' : finalScore >= 60 ? 'D' : 'E';
                    
                    await DataService.addGrade({
                        gradeId: `${Date.now()}-${AppState.currentUser.username}-${AppState.selectedExamCode}`,
                        kelas: AppState.currentUser.kelas,
                        namaSiswa: AppState.currentUser.nama,
                        kodeSoal: AppState.selectedExamCode,
                        mataPelajaran: examDetails.mataPelajaran,
                        semester: examDetails.semester,
                        tahunAjaran: examDetails.tahunAjaran,
                        nilai: finalScore,
                        grade: grade,
                        keterangan: finalScore >= 70 ? 'Lulus' : 'Tidak Lulus',
                        waktuSelesai: new Date().toLocaleString('id-ID')
                    });

                    // Queue sudah otomatis diproses oleh queueOperation()
                    // Tidak perlu memanggil processSyncQueue() lagi untuk menghindari duplikasi

                    Swal.fire({
                        title: 'Ujian Selesai!',
                        html: `Terima kasih telah menyelesaikan ujian.<br>Nilai Anda: <strong>${finalScore}</strong> (${grade})<br>Anda akan diarahkan kembali ke halaman login.`,
                        icon: 'success',
                        confirmButtonText: 'OK',
                        allowOutsideClick: false
                    }).then(() => Auth.logout());

                } catch (error) {
                    console.error("Error submitting exam: ", error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Gagal menyimpan hasil ujian. Silakan coba lagi.',
                        icon: 'error'
                    });
                }
            },


            showNotification(message, type = 'error') {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                Toast.fire({ icon: type, title: message });
            },

            getSemesterOptions(selected) {
                const semesters = [
                    "Sumatif Tengah Semester Ganjil",
                    "Sumatif Akhir Semester Ganjil",
                    "Sumatif Tengah Semester Genap",
                    "Sumatif Akhir Semester Genap"
                ];
                return semesters.map(s => `<option value="${s}" ${selected === s ? 'selected' : ''}>${s}</option>`).join('');
            },

            getYearOptions(selected) {
                let options = '';
				for (let year = 2025; year <= 2034; year++) {
                    const academicYear = `${year}/${year + 1}`;
                    options += `<option value="${academicYear}" ${selected === academicYear ? 'selected' : ''}>${academicYear}</option>`;
                }
                return options;
            },

            populateStudentFilter(classFilterId, studentFilterId) {
                const classFilterElement = document.getElementById(classFilterId);
                const studentFilterElement = document.getElementById(studentFilterId);

                const updateStudentOptions = () => {
                    const selectedClass = classFilterElement.value;
                    let filteredStudents = AppState.users.filter(u => u.role === 'siswa');

                    if (selectedClass) {
                        filteredStudents = filteredStudents.filter(u => u.kelas === selectedClass);
                    } else if (AppState.currentUser.role === 'guru') {
                        const teacherGrade = AppState.currentUser.kelas.charAt(0);
                        filteredStudents = filteredStudents.filter(u => u.kelas.startsWith(teacherGrade));
                    }

                    studentFilterElement.innerHTML = '<option value="">Semua Siswa</option>';
                    filteredStudents
                        .sort((a, b) => a.nama.localeCompare(b.nama))
                        .forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.nama;
                            option.textContent = student.nama;
                            studentFilterElement.appendChild(option);
                        });
                };

                classFilterElement.addEventListener('change', updateStudentOptions);
                updateStudentOptions(); // Initial population
            },
            
            async blockStudentAndExit() {
                // Remove listeners to prevent loops
                document.removeEventListener('fullscreenchange', this.handleFullscreenChange);
                document.removeEventListener('visibilitychange', this.handleVisibilityChange);
                if (AppState.examTimer) clearInterval(AppState.examTimer);

                // Arsitektur baru: Simpan ke IndexedDB dulu, lalu sync ke server
                const blockId = `${AppState.currentUser.username}_${AppState.selectedExamCode}`;
                await DataService.blockStudent({
                    blockId: blockId,
                    username: AppState.currentUser.username,
                    examCode: AppState.selectedExamCode,
                    blockedAt: new Date().toLocaleString('id-ID')
                });

                // Show final message and log out
                Swal.fire({
                    title: 'Anda Diblokir!',
                    html: `Anda telah berpindah tab atau meminimalkan browser sebanyak 3 kali.<br>Akses Anda ke ujian ini telah diblokir. Silakan hubungi admin.`,
                    icon: 'error',
                    confirmButtonText: 'OK',
                    allowOutsideClick: false
                }).then(() => {
                    Auth.logout();
                });
            },

            handleVisibilityChange() {
                if (AppState.currentView !== 'exam') return;

                if (document.hidden) {
                    AppState.violationCount++;
                    if (AppState.violationCount >= 3) {
                        UI.blockStudentAndExit();
                    }
                } else {
                     // User returned to tab
                    if (AppState.violationCount < 3 && AppState.violationCount > 0) {
                        UI.showNotification(`Peringatan: Anda telah meninggalkan tab ujian ${AppState.violationCount} kali. Akses akan diblokir jika mencapai 3 kali.`, 'warning');
                    }
                }
            },

            handleFullscreenChange() {
                if (AppState.currentView !== 'exam') return;

                const reEnterModal = document.getElementById('reEnterFullscreenModal');
                const warningText = document.getElementById('violationWarning');

                if (!document.fullscreenElement) {
                    // Exited fullscreen - PAUSE
                    if (AppState.examTimer) {
                        clearInterval(AppState.examTimer);
                        AppState.examTimer = null;
                    }
                    
                    warningText.textContent = ""; // Clear existing warning text as logic changed
                    reEnterModal.classList.remove('hidden');
                } else {
                    // Re-entered fullscreen - RESUME
                    reEnterModal.classList.add('hidden');
                    if (!AppState.examTimer && AppState.examTimeLeft > 0) {
                        UI.startTimer();
                    }
                }
            },
            
            toggleAnswerFields(type, formId) {
                const form = document.getElementById(formId);
                const pilihanField = form.querySelector('#pilihanField');
                const jawabanTeksField = form.querySelector('#jawabanTeksField');
                
                pilihanField.classList.toggle('hidden', type !== 'pilihan_ganda');
                jawabanTeksField.classList.toggle('hidden', type === 'pilihan_ganda' || type === '');
            },

            renderPaginationControls(containerId, paginationState, navigationFn) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const { currentPage, totalItems } = paginationState;
                const totalPages = Math.ceil(totalItems / AppState.itemsPerPage);

                if (totalPages <= 1) {
                    container.innerHTML = '';
                    return;
                }

                const isFirstPage = currentPage === 1;
                const isLastPage = currentPage === totalPages;

                container.innerHTML = `
                    <button id="${containerId}-prev" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" ${isFirstPage ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left mr-2"></i> Sebelumnya
                    </button>
                    <span class="text-sm text-gray-700">Halaman ${currentPage} dari ${totalPages}</span>
                    <button id="${containerId}-next" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" ${isLastPage ? 'disabled' : ''}>
                        Selanjutnya <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                `;

                document.getElementById(`${containerId}-prev`).addEventListener('click', () => {
                    if (!isFirstPage) navigationFn(currentPage - 1);
                });
                document.getElementById(`${containerId}-next`).addEventListener('click', () => {
                    if (!isLastPage) navigationFn(currentPage + 1);
                });
            },
            
            async loadAndRenderPaginatedQuestions(forceRefresh = false) {
                const questionsList = document.getElementById('questionsList');

                const filters = {
                    tahunAjaran: document.getElementById('filterTahunAjaran').value,
                    semester: document.getElementById('filterSemester').value,
                    kelas: document.getElementById('filterKelas').value,
                    mataPelajaran: document.getElementById('filterSubject').value,
                    kode: document.getElementById('filterCode').value
                };
                AppState.filters.questions = filters; // Save current filters for view/edit

                const cacheKey = AppState.cache.generateKey('questions', filters);
                
                // Clear cache if force refresh
                if (forceRefresh) {
                    AppState.cache.delete(cacheKey);
                }
                
                let cachedData = AppState.cache.get(cacheKey);
                
                // SMART CACHE: If cache exists, use it immediately (no loading)
                if (cachedData && cachedData.length >= 0) {
                    console.log('[Questions] Using cached data:', cachedData.length, 'items');
                    this.renderQuestionsFromCache(cachedData);
                    return;
                }

                // Show loading only when fetching from server
                questionsList.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i><p class="mt-2 text-gray-600">Memuat soal...</p></div>`;

                try {
                    // Fetch directly from server
                    const params = { action: 'getQuestions', ...filters };
                    const result = await callGoogleScript('GET', params);
                    
                    if (result.status === 'success') {
                        let allQuestions = result.data || [];
                        
                        // Apply filters locally
                        let filteredQuestions = allQuestions.filter(q => {
                            if (filters.tahunAjaran && q.tahunAjaran !== filters.tahunAjaran) return false;
                            if (filters.semester && q.semester !== filters.semester) return false;
                            if (filters.kelas && q.kelas !== filters.kelas) return false;
                            if (filters.mataPelajaran && q.mataPelajaran !== filters.mataPelajaran) return false;
                            if (filters.kode && q.kode !== filters.kode) return false;
                            return true;
                        });
                        
                        // Filter by teacher's grade if applicable
                        if (AppState.currentUser.role === 'guru' && AppState.currentUser.kelas) {
                            const teacherGrade = AppState.currentUser.kelas.charAt(0);
                            filteredQuestions = filteredQuestions.filter(q => q.kelas && q.kelas.startsWith(teacherGrade));
                        }
                        
                        // Sort by: 1. Mata Pelajaran, 2. Tipe (PG ‚Üí Isian ‚Üí Uraian), 3. No Soal
                        const typeOrder = { 'pilihan_ganda': 1, 'isian': 2, 'uraian': 3 };
                        filteredQuestions.sort((a, b) => {
                            // 1. Sort by mataPelajaran first
                            const mataPelajaranCompare = (a.mataPelajaran || '').localeCompare(b.mataPelajaran || '', 'id-ID');
                            if (mataPelajaranCompare !== 0) return mataPelajaranCompare;

                            // 2. Sort by tipe (pilihan_ganda ‚Üí isian ‚Üí uraian)
                            const typeA = typeOrder[a.tipe] || 99;
                            const typeB = typeOrder[b.tipe] || 99;
                            if (typeA !== typeB) return typeA - typeB;

                            // 3. Sort by noSoal (numeric)
                            const noA = parseInt(a.noSoal) || 0;
                            const noB = parseInt(b.noSoal) || 0;
                            if (noA !== noB && (noA !== 0 || noB !== 0)) return noA - noB;

                            // 4. Sort by creation time (fallback)
                            const timeA = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                            const timeB = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                            return timeA - timeB;
                        });
                        
                        cachedData = filteredQuestions;
                        AppState.cache.set(cacheKey, cachedData);
                        
                        this.renderQuestionsFromCache(cachedData);
                        console.log('[Questions] Loaded', cachedData.length, 'questions from server');
                    } else {
                        throw new Error(result.message || 'Gagal memuat soal.');
                    }
                } catch (error) {
                    UI.showNotification(error.message || 'Gagal memuat soal.', 'error');
                    questionsList.innerHTML = '<div class="bg-white rounded-lg shadow p-6 text-center text-red-500">Gagal memuat soal.</div>';
                    return;
                }
            },
            
            // Helper function to render questions from cache
            renderQuestionsFromCache(cachedData) {
                AppState.pagination.questions.totalItems = cachedData.length;
                const start = (AppState.pagination.questions.currentPage - 1) * AppState.itemsPerPage;
                const end = start + AppState.itemsPerPage;

                // Calculate question numbers for ALL questions first (before pagination)
                let currentSubject = null;
                let subjectQuestionNumber = 0;
                const allQuestionsWithNumbers = cachedData.map((question) => {
                    if (question.mataPelajaran !== currentSubject) {
                        currentSubject = question.mataPelajaran;
                        subjectQuestionNumber = 1;
                    } else {
                        subjectQuestionNumber++;
                    }
                    return { ...question, displayNumber: subjectQuestionNumber };
                });

                // Now slice for pagination (numbers are already calculated correctly)
                const paginatedItems = allQuestionsWithNumbers.slice(start, end);

                Management.renderFilteredQuestions(paginatedItems, allQuestionsWithNumbers, start);

                UI.renderPaginationControls('questionsPagination', AppState.pagination.questions, (newPage) => {
                    AppState.pagination.questions.currentPage = newPage;
                    this.loadAndRenderPaginatedQuestions();
                });
            },
            
            async loadAndRenderPaginatedResults(forceRefresh = false) {
                const resultsTableBody = document.getElementById('resultsTableBody');
                
                const filters = {
                    action: 'getResults',
                    tahunAjaran: document.getElementById('filterResultTahunAjaran').value,
                    semester: document.getElementById('filterResultSemester').value,
                    kodesoal: document.getElementById('filterResultCode').value,
                    mataPelajaran: document.getElementById('filterResultSubject').value,
                    kelas: document.getElementById('filterResultClass').value,
                    namaLengkap: document.getElementById('filterResultStudent').value,
                };

                const cacheKey = AppState.cache.generateKey('results', filters);
                
                // Clear cache if force refresh
                if (forceRefresh) {
                    AppState.cache.delete(cacheKey);
                }
                
                let cachedData = AppState.cache.get(cacheKey);
                
                // SMART CACHE: If cache exists, use it immediately (no loading)
                if (cachedData && cachedData.length >= 0) {
                    console.log('[Results] Using cached data:', cachedData.length, 'items');
                    this.renderResultsFromCache(cachedData);
                    return;
                }

                // Show loading only when fetching from server
                resultsTableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data...</td></tr>';

                try {
                    // Fetch directly from server
                    const result = await callGoogleScript('GET', filters);
                    if (result.status === 'success') {
                        let allResults = result.data || [];
                        
                        // Apply filters locally
                        let filteredResults = allResults.filter(r => {
                            if (filters.tahunAjaran && r.tahunAjaran !== filters.tahunAjaran) return false;
                            if (filters.semester && r.semester !== filters.semester) return false;
                            if (filters.kodesoal && r.kodesoal !== filters.kodesoal) return false;
                            if (filters.mataPelajaran && r.mataPelajaran !== filters.mataPelajaran) return false;
                            if (filters.kelas && r.kelas !== filters.kelas) return false;
                            if (filters.namaLengkap && r.namaLengkap !== filters.namaLengkap) return false;
                            return true;
                        });
                        
                        // Sort by: mataPelajaran, namaLengkap, noSoal
                        filteredResults.sort((a, b) => {
                            // 1. Sort by mataPelajaran
                            const mataPelajaranCompare = (a.mataPelajaran || '').localeCompare(b.mataPelajaran || '', 'id-ID');
                            if (mataPelajaranCompare !== 0) return mataPelajaranCompare;
                            
                            // 2. Sort by namaLengkap
                            const namaCompare = (a.namaLengkap || '').localeCompare(b.namaLengkap || '', 'id-ID');
                            if (namaCompare !== 0) return namaCompare;
                            
                            // 3. Sort by noSoal (numeric)
                            const noSoalA = parseInt(a.noSoal) || 0;
                            const noSoalB = parseInt(b.noSoal) || 0;
                            return noSoalA - noSoalB;
                        });
                        AppState.cache.set(cacheKey, filteredResults);
                        
                        this.renderResultsFromCache(filteredResults);
                        console.log('[Results] Loaded', filteredResults.length, 'results from server');
                    } else {
                        throw new Error(result.message || 'Gagal memuat data.');
                    }
                } catch (error) {
                    resultsTableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat data. Periksa koneksi.</td></tr>';
                    return;
                }
            },
            
            // Helper function to render results from cache
            renderResultsFromCache(cachedData) {
                AppState.pagination.results.totalItems = cachedData.length;
                const start = (AppState.pagination.results.currentPage - 1) * AppState.itemsPerPage;
                const end = start + AppState.itemsPerPage;
                const paginatedItems = cachedData.slice(start, end);

                Management.renderFilteredResults(paginatedItems);

                UI.renderPaginationControls('resultsPagination', AppState.pagination.results, (newPage) => {
                    AppState.pagination.results.currentPage = newPage;
                    this.loadAndRenderPaginatedResults();
                });
            },

            async loadAndRenderPaginatedGrades(forceRefresh = false) {
                const gradesTableBody = document.getElementById('gradesTableBody');

                const filters = {
                    tahunAjaran: document.getElementById('filterGradeTahunAjaran').value,
                    semester: document.getElementById('filterGradeSemester').value,
                    kodeSoal: document.getElementById('filterGradeCode').value,
                    mataPelajaran: document.getElementById('filterGradeSubject').value,
                    kelas: document.getElementById('filterGradeClass').value,
                    namaSiswa: document.getElementById('filterGradeStudent').value
                };
                AppState.filters.grades = filters; // Store filters for view/edit

                const cacheKey = AppState.cache.generateKey('grades', filters);
                
                // SMART CACHE: Only clear if forceRefresh
                if (forceRefresh) {
                    AppState.cache.delete(cacheKey);
                }
                
                // === APPLY PENDING GRADE UPDATES ===
                // Jika ada pending updates dari edit hasil ujian, terapkan ke cache
                const hasPendingUpdates = Object.keys(AppState.pendingGradeUpdates).length > 0;
                if (hasPendingUpdates) {
                    console.log('[Grades] Applying pending updates:', AppState.pendingGradeUpdates);
                    
                    // Apply to global cache
                    const globalCache = CacheHelper.getCached('grades') || [];
                    for (const key in AppState.pendingGradeUpdates) {
                        const [studentName, examCode] = key.split('|');
                        const update = AppState.pendingGradeUpdates[key];
                        
                        const gradeIdx = globalCache.findIndex(g => 
                            g.namaSiswa === studentName && g.kodeSoal === examCode
                        );
                        
                        if (gradeIdx !== -1) {
                            globalCache[gradeIdx].nilai = update.nilai;
                            globalCache[gradeIdx].grade = update.grade;
                            globalCache[gradeIdx].keterangan = update.keterangan;
                            console.log(`[Grades] Applied pending update for ${studentName}: ${update.nilai}`);
                        }
                    }
                    
                    // Save updated global cache
                    if (globalCache.length > 0) {
                        AppState.cache.set('grades', { data: globalCache, timestamp: Date.now(), valid: true });
                    }
                    
                    // Clear filtered cache so it gets regenerated
                    AppState.cache.delete(cacheKey);
                    
                    // Clear pending updates
                    AppState.pendingGradeUpdates = {};
                }
                
                // Check filtered cache first
                let cachedData = AppState.cache.get(cacheKey);
                
                // If filtered cache exists, use it immediately
                if (cachedData && cachedData.length >= 0) {
                    console.log('[Grades] Using filtered cache:', cachedData.length, 'items');
                    this.renderGradesFromCache(cachedData, filters);
                    return;
                }
                
                // FALLBACK: Check global grades cache and filter locally
                const globalCache = CacheHelper.getCached('grades');
                if (globalCache && globalCache.length > 0) {
                    console.log('[Grades] Using global cache, filtering locally...');
                    let filteredGrades = globalCache.filter(g => {
                        if (filters.tahunAjaran && g.tahunAjaran !== filters.tahunAjaran) return false;
                        if (filters.semester && g.semester !== filters.semester) return false;
                        if (filters.kodeSoal && g.kodeSoal !== filters.kodeSoal) return false;
                        if (filters.mataPelajaran && g.mataPelajaran !== filters.mataPelajaran) return false;
                        if (filters.kelas && g.kelas !== filters.kelas) return false;
                        if (filters.namaSiswa && g.namaSiswa !== filters.namaSiswa) return false;
                        return true;
                    });
                    filteredGrades.sort((a, b) => (a.namaSiswa || '').localeCompare(b.namaSiswa || ''));
                    
                    // Save to filtered cache for next time
                    AppState.cache.set(cacheKey, filteredGrades);
                    
                    this.renderGradesFromCache(filteredGrades, filters);
                    return;
                }
                
                // Show loading only when fetching from server
                gradesTableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Memuat data nilai...</td></tr>';

                try {
                    // Fetch from Google Sheets
                    console.log('[Grades] Fetching data from server...');
                    const result = await callGoogleScript('GET', {
                        action: 'getGrades',
                        ...filters
                    });

                    if (result.status === 'success') {
                        let allGrades = result.data || [];
                        
                        // Apply filters locally
                        let filteredGrades = allGrades.filter(g => {
                            if (filters.tahunAjaran && g.tahunAjaran !== filters.tahunAjaran) return false;
                            if (filters.semester && g.semester !== filters.semester) return false;
                            if (filters.kodeSoal && g.kodeSoal !== filters.kodeSoal) return false;
                            if (filters.mataPelajaran && g.mataPelajaran !== filters.mataPelajaran) return false;
                            if (filters.kelas && g.kelas !== filters.kelas) return false;
                            if (filters.namaSiswa && g.namaSiswa !== filters.namaSiswa) return false;
                            return true;
                        });
                        
                        filteredGrades.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa));
                        
                        // Save to cache
                        AppState.cache.set(cacheKey, filteredGrades);
                        
                        // Render
                        this.renderGradesFromCache(filteredGrades, filters);
                        console.log(`[Grades] Loaded ${filteredGrades.length} grades from server`);
                    } else {
                        throw new Error(result.message || 'Gagal memuat data nilai dari server');
                    }
                } catch (error) {
                    console.error("Error fetching grades:", error);
                    gradesTableBody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat data. Periksa koneksi.</td></tr>';
                }
            },
            
            // Helper function to render grades from cache
            renderGradesFromCache(filteredGrades, filters) {
                AppState.pagination.grades.totalItems = filteredGrades.length;
                const start = (AppState.pagination.grades.currentPage - 1) * AppState.itemsPerPage;
                const end = start + AppState.itemsPerPage;
                const paginatedItems = filteredGrades.slice(start, end);

                Management.renderFilteredGrades(paginatedItems);

                UI.renderPaginationControls('gradesPagination', AppState.pagination.grades, (newPage) => {
                    AppState.pagination.grades.currentPage = newPage;
                    this.loadAndRenderPaginatedGrades();
                });
            },

            // AUTO-REFRESH: Refresh UI Daftar Nilai jika sedang terbuka
            refreshGradesUIIfVisible() {
                const gradesTableBody = document.getElementById('gradesTableBody');
                // Cek apakah menu Daftar Nilai sedang aktif/terlihat
                if (gradesTableBody && gradesTableBody.offsetParent !== null) {
                    console.log('[UI] Auto-refreshing grades table from cache...');
                    // Refresh dari cache (bukan dari server) - instant!
                    this.loadAndRenderPaginatedGrades(false);
                }
            },

            // Fungsi untuk refresh data grades dari server secara manual
            async refreshGradesFromServer() {
                if (!SyncManager.isOnline) {
                    return;
                }
                
                // Clear all grades cache
                AppState.cache.clear();
                
                // Reset pagination
                AppState.pagination.grades.currentPage = 1;
                
                // Reload with fresh data
                await this.loadAndRenderPaginatedGrades(true);
            },

            // Fungsi untuk refresh data questions dari server secara manual
            async refreshQuestionsFromServer() {
                if (!SyncManager.isOnline) {
                    return;
                }
                
                // Clear questions cache
                AppState.cache.clear();
                
                // Reset pagination
                AppState.pagination.questions.currentPage = 1;
                
                // Reload with fresh data
                await this.loadAndRenderPaginatedQuestions(true);
            },

            // Fungsi untuk refresh data results dari server secara manual
            async refreshResultsFromServer() {
                if (!SyncManager.isOnline) {
                    return;
                }
                
                // Clear results cache
                AppState.cache.clear();
                
                // Reset pagination
                AppState.pagination.results.currentPage = 1;
                
                // Reload with fresh data
                await this.loadAndRenderPaginatedResults(true);
            }

        };

        // =================================================================
        // EVENT LISTENERS & INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            const loginForm = document.getElementById('loginForm');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');

            // Initialize SyncManager first
            await SyncManager.init();
            
            // Initialize IndexedDB dan BackgroundSync
            await IndexedDBService.init();
            BackgroundSync.init();

            // Show loading state while fetching user data
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memuat Data...';
            usernameInput.disabled = true;
            passwordInput.disabled = true;

            // Try loading from IndexedDB cache first for faster startup
            let dataLoaded = false;
            const cachedUsers = await IndexedDBService.getAll('users');
            
            if (cachedUsers && cachedUsers.length > 0) {
                AppState.users = cachedUsers;
                dataLoaded = true;
                console.log('Users loaded from IndexedDB cache:', cachedUsers.length);
                
                // Trigger background sync untuk fresh data
                BackgroundSync.syncStore('users');
            } else {
                // Fallback ke fetch dari server
                dataLoaded = await fetchUsersFromGoogleScript();
            }

            if (dataLoaded) {
                 // Restore login form state
                loginButton.disabled = false;
                loginButton.innerHTML = 'Login';
                usernameInput.disabled = false;
                passwordInput.disabled = false;
                
                // Check for a persisted session after data is loaded
                Auth.checkSession();
            } else {
                 loginButton.innerHTML = 'Gagal Memuat';
            }


            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                loginError.classList.add('hidden');
                
                const result = Auth.login(username, password);
                if (result.success) {
                    // Disable form briefly
                    loginButton.disabled = true;
                    usernameInput.disabled = true;
                    passwordInput.disabled = true;
                    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Masuk...';
                    
                    // Trigger background sync untuk data terbaru
                    BackgroundSync.syncAll();
                    
                    // Show dashboard langsung (data dari IndexedDB cache)
                    UI.showDashboard();
                    
                    // Reset form state
                    loginButton.disabled = false;
                    loginButton.innerHTML = 'Login';
                    usernameInput.disabled = false;
                    passwordInput.disabled = false;
                }
                else {
                    loginError.textContent = result.message;
                    loginError.classList.remove('hidden');
                }
            });
            
            document.getElementById('togglePasswordVisibility').addEventListener('click', function() {
                const passwordField = document.getElementById('password');
                const icon = this.querySelector('i');
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordField.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });

            document.getElementById('prevQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion > 0) {
                    AppState.currentQuestion--;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                }
            });

            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                if (AppState.currentQuestion < AppState.questions.length - 1) {
                    AppState.currentQuestion++;
                    UI.renderQuestion();
                    UI.updateQuestionNavigation();
                    UI.updateProgress();
                } else {
                    const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                    let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                    if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                    UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
                }
            });

            document.getElementById('submitExamBtn').addEventListener('click', () => {
                 const unansweredCount = AppState.questions.length - Object.keys(AppState.examAnswers).filter(k => AppState.examAnswers[k] !== undefined && AppState.examAnswers[k] !== '').length;
                let message = 'Apakah Anda yakin ingin mengakhiri ujian?';
                if (unansweredCount > 0) message += `\n\nAnda memiliki ${unansweredCount} soal yang belum dikerjakan.`;
                UI.showConfirmModal('Konfirmasi Selesai Ujian', message, () => UI.submitExam());
            });
            document.getElementById('dashboardLogoutBtn').addEventListener('click', () => UI.showConfirmModal('Konfirmasi Keluar', 'Apakah Anda yakin ingin keluar?', () => Auth.logout()));
            document.getElementById('closeModalBtn').addEventListener('click', () => UI.hideModal());
            // Modal hanya bisa ditutup dengan tombol, tidak bisa klik di luar modal
            
            // Listener for Question List Modal
            document.getElementById('questionListBtn').addEventListener('click', () => UI.showQuestionListModal());
            document.getElementById('closeQuestionListBtn').addEventListener('click', () => UI.hideQuestionListModal());
            document.getElementById('questionListModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) UI.hideQuestionListModal(); });

            // Gemini modal should NOT close when clicking outside - only via buttons
            // (Event listener removed intentionally)
            
            document.getElementById('reEnterFullscreenBtn').addEventListener('click', async () => {
                try {
                    await document.documentElement.requestFullscreen();
                } catch (err) {
                    UI.showNotification('Gagal masuk mode layar penuh. Silakan klik lagi.', 'error');
                }
            });

            document.getElementById('confirmCancelBtn').addEventListener('click', () => document.getElementById('confirmModal').classList.add('hidden'));

        });

        document.addEventListener('contextmenu', (e) => { if (AppState.currentView === 'exam') e.preventDefault(); });
        document.addEventListener('keydown', (e) => {
            if (AppState.currentView === 'exam' && (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'u'))) {
                e.preventDefault();
            }
        });

        // Expose critical objects to global scope for inline HTML handlers
        window.AppState = AppState;
        window.Management = Management;
        window.UI = UI;
        window.Auth = Auth;
        window.GeminiHelper = GeminiHelper;
        window.CacheHelper = CacheHelper;
        window.IndexedDBService = IndexedDBService;
        window.BackgroundSync = BackgroundSync;
        window.DataService = DataService;
    </script>
</body>
</html>
